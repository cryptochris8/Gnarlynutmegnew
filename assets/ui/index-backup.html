<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HySports Soccer - Phase 1 Enhanced</title>
</head>
<body>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-content">
    <div class="loading-title">Loading Soccer Game</div>
    <div class="loading-message" id="loading-message">Initializing game world...</div>
    <div class="loading-progress-bar">
      <div class="loading-progress-fill" id="loading-progress-fill"></div>
    </div>
    <div class="loading-percentage" id="loading-percentage">0%</div>
    <div class="loading-spinner"></div>
  </div>
</div>

<!-- Player Status HUD -->
<div id="player-status-hud" class="player-status-hud" style="display: none;">
  <div class="role-indicator">
    <div class="role-icon" id="role-icon">⚽</div>
    <div class="role-info">
      <div class="role-name" id="role-name">Player</div>
      <div class="role-description" id="role-description">Ready to play</div>
    </div>
  </div>
  
  <div class="stamina-container">
    <div class="stamina-label">Stamina</div>
    <div class="stamina-bar">
      <div class="stamina-fill" id="stamina-fill"></div>
    </div>
    <div class="stamina-percentage" id="stamina-percentage">100%</div>
  </div>
  
  <div class="ball-possession-indicator" id="ball-possession" style="display: none;">
    <div class="possession-icon">⚽</div>
    <div class="possession-text">Ball Possession</div>
  </div>
</div>

<style>
  @import url('{{CDN_ASSETS_URL}}/ui/fonts/trebuchet-ms.css');

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: "Trebuchet MS", "Arial", sans-serif;
    background: transparent;
    overflow: hidden;
    user-select: none;
    cursor: default;
      overflow-y: auto;
      padding: 0;
      box-sizing: border-box;
    pointer-events: auto; /* Ensure UI can receive pointer events */
  }

  /* ===== CLEAN BUTTON STYLES (HYTOPIA-COMPLIANT) ===== */
  button, .btn, .team-btn, .game-mode-btn, .control-btn, .how-to-play-btn, .tab-button {
    cursor: pointer;
    user-select: none;
    outline: none;
    transition: transform 0.1s ease;
  }

  button:active, .btn:active, .team-btn:active, .game-mode-btn:active, .control-btn:active, .how-to-play-btn:active, .tab-button:active {
    transform: scale(0.98);
  }

  /* ===== MAIN SCOREBOARD SYSTEM ===== */
  .score-time-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex !important;
    align-items: center;
    gap: 20px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    border-radius: 15px;
    padding: 15px 25px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .team-banner {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 15px;
    border-radius: 10px;
    min-width: 80px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .team-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
  }

  .team-banner.red {
    background: linear-gradient(135deg, #ff4444, #cc3333);
    border: 2px solid #ff6666;
  }

  .team-banner.blue {
    background: linear-gradient(135deg, #4444ff, #3333cc);
    border: 2px solid #6666ff;
  }

  .team-banner:hover::before {
    left: 100%;
  }

  .team-name {
    font-size: 14px;
    font-weight: bold;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 5px;
  }

  .team-score {
    font-size: 28px;
    font-weight: bold;
    color: #ffffff !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5);
    transition: all 0.3s ease;
    min-height: 35px;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    opacity: 1 !important;
    visibility: visible !important;
    z-index: 10 !important;
    pointer-events: none !important;
  }

  /* ===== LOADING PROGRESS DISPLAY ===== */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    z-index: 10000;
    visibility: hidden;
    opacity: 0;
    transition: all 0.3s ease;
  }

  .loading-overlay.visible {
    visibility: visible;
    opacity: 1;
  }

  .loading-content {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    border-radius: 20px;
    padding: 40px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    text-align: center;
    min-width: 400px;
  }

  .loading-title {
    font-size: 24px;
    font-weight: bold;
    color: #ffffff;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .loading-message {
    font-size: 16px;
    color: #cccccc;
    margin-bottom: 30px;
    min-height: 24px;
  }

  .loading-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 15px;
  }

  .loading-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #45a049);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .loading-percentage {
    font-size: 18px;
    font-weight: bold;
    color: #ffffff;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }

  .loading-spinner {
    margin-top: 20px;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top: 4px solid #4CAF50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* ===== ENHANCED TIMER DISPLAY ===== */
  .time-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 20px;
  }

  .phase-indicator {
    font-size: 12px;
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 12px;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
  }

  .phase-indicator.waiting {
    background: #666666;
    color: #ffffff;
  }

  .phase-indicator.starting {
    background: #FFA500;
    color: #ffffff;
    animation: pulse 1s infinite;
  }

  .phase-indicator.playing {
    background: #00AA00;
    color: #ffffff;
  }

  .phase-indicator.overtime {
    background: #FF6600;
    color: #ffffff;
    animation: pulse 0.5s infinite;
  }

  .phase-indicator.goal {
    background: #FFD700;
    color: #000000;
    animation: celebration 0.5s infinite;
  }

  .phase-indicator.halftime {
    background: #9966CC;
    color: #ffffff;
    animation: pulse 1s infinite;
  }

  .phase-indicator.finished {
    background: #AA0000;
    color: #ffffff;
  }

  .time-label {
    font-size: 18px;
    font-weight: bold;
    color: #ffffff;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }

  /* ===== STATISTICS PANEL ===== */
  .stats-panel {
    position: fixed;
    top: 100px;
    right: 20px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    border-radius: 15px;
    padding: 20px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    min-width: 220px;
        margin: 0 auto;
        display: block;
    transition: all 0.3s ease;
    z-index: 999;
  }

  .stats-panel.hidden {
    transform: translateX(100%);
    opacity: 0;
  }

  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .stats-title {
    font-size: 16px;
    font-weight: bold;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px 0;
  }

  .stat-label {
    font-size: 14px;
    color: #cccccc;
    font-weight: 500;
  }

  .stat-values {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #ffffff;
    min-width: 30px;
    text-align: center;
  }

  .stat-value.red {
    color: #ff6666;
  }

  .stat-value.blue {
    color: #6666ff;
  }

  .possession-container {
    margin: 15px 0;
  }

  .possession-bar {
    width: 100%;
    height: 8px;
    background: linear-gradient(to right, #ff4444, #4444ff);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .possession-bar-fill {
    height: 100%;
    background: #ff4444;
    transition: width 0.5s ease;
    border-radius: 4px;
  }

  .possession-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    font-size: 12px;
    color: #cccccc;
  }

  /* ===== POWER-UP PANEL (ARCADE MODE ONLY) ===== */
  .powerup-panel {
    position: fixed;
    top: 100px;
    left: 20px;
    background: linear-gradient(135deg, rgba(255, 102, 0, 0.9), rgba(255, 140, 0, 0.9));
    border-radius: 15px;
    padding: 20px;
    border: 2px solid rgba(255, 215, 0, 0.6);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(255, 102, 0, 0.4);
    min-width: 220px;
    transition: all 0.3s ease;
    z-index: 998;
  }

  .powerup-panel.hidden {
    transform: translateX(-100%);
    opacity: 0;
  }

  .powerup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  }

  .powerup-title {
    font-size: 16px;
    font-weight: bold;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .powerup-active {
    background: rgba(255, 215, 0, 0.2);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
    border: 1px solid rgba(255, 215, 0, 0.4);
  }

  .powerup-name {
    font-size: 14px;
    font-weight: bold;
    color: #FFD700;
    margin-bottom: 5px;
  }

  .powerup-description {
    font-size: 12px;
    color: #ffffff;
    opacity: 0.9;
    line-height: 1.3;
  }

  .powerup-cooldown {
    font-size: 11px;
    color: #ffcccc;
    margin-top: 5px;
    font-style: italic;
  }

  .powerup-instructions {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .powerup-key {
    display: inline-block;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 12px;
    font-weight: bold;
    color: #ffffff;
    margin-right: 5px;
  }

  /* ===== CONTROL BUTTONS ===== */
  .control-buttons {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }

  .control-btn {
    width: 40px;
    height: 40px;
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    color: #ffffff;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.6);
    transform: scale(1.1);
  }

  .instructions-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, rgba(20, 20, 20, 0.95), rgba(40, 40, 40, 0.95));
    border: 3px solid #ffffff;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    color: #ffffff;
    font-family: "Trebuchet MS", "Arial", sans-serif;
    z-index: 1000;
    width: 90vw;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    transition: all 0.3s ease-in-out;
    backdrop-filter: blur(15px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .instructions-panel.hidden {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
    pointer-events: none;
    display: none;
  }

  .title-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    margin-bottom: 30px;
    gap: 12px;
  }

  .title-logo {
    width: min(280px, 40vw);
    height: min(280px, 40vw);
    object-fit: contain;
    filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.6));
  }

  .how-to-play-container {
    position: relative;
    margin-bottom: 30px;
  }

  .how-to-play-btn {
    background: linear-gradient(135deg, rgba(60, 60, 60, 0.8), rgba(80, 80, 80, 0.8));
    border: 2px solid #666;
    border-radius: 12px;
    color: white;
    padding: 12px 24px;
    cursor: pointer !important;
    font-size: 16px;
    transition: all 0.3s ease;
    font-weight: bold;
    backdrop-filter: blur(10px);
    pointer-events: auto;
  }

  .how-to-play-btn:hover {
    border-color: #fff;
    background: linear-gradient(135deg, rgba(80, 80, 80, 0.9), rgba(100, 100, 100, 0.9));
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  }

  .how-to-play-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(20, 20, 20, 0.95);
    border: 2px solid #ffffff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    min-width: 400px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .how-to-play-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 10px solid transparent;
    border-top-color: #ffffff;
  }

  .how-to-play-tooltip::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: rgba(20, 20, 20, 0.95);
    z-index: 1;
  }

  .how-to-play-btn:hover .how-to-play-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .how-to-play-tooltip p {
    margin: 6px 0;
    font-size: 14px;
    line-height: 1.4;
    color: #ffffff;
    text-align: left;
  }

  .team-selection {
    display: flex;
    gap: 24px;
    justify-content: flex-start;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .team-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    min-width: 140px;
  }

  .team-btn {
    padding: 16px 32px;
    border: 3px solid transparent;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 140px;
    position: relative;
    overflow: hidden;
  }

  .team-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
  }

  .team-btn:hover::before {
    left: 100%;
  }

  .team-btn.red {
    background: linear-gradient(135deg, #ff4444, #cc3333);
    color: #ffffff;
    border-color: #ff6666;
  }

  .team-btn.red:hover {
    background: linear-gradient(135deg, #ff6666, #ff4444);
    border-color: #ffffff;
    box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
    transform: translateY(-2px) scale(1.05);
  }

  .team-btn.red.selected {
    border-color: #ffffff;
    box-shadow: 0 0 25px rgba(255, 68, 68, 0.8);
    transform: translateY(-2px) scale(1.05);
  }

  .team-btn.blue {
    background: linear-gradient(135deg, #4444ff, #3333cc);
    color: #ffffff;
    border-color: #6666ff;
  }

  .team-btn.blue:hover {
    background: linear-gradient(135deg, #6666ff, #4444ff);
    border-color: #ffffff;
    box-shadow: 0 0 20px rgba(68, 68, 255, 0.6);
    transform: translateY(-2px) scale(1.05);
  }

  .team-btn.blue.selected {
    border-color: #ffffff;
    box-shadow: 0 0 25px rgba(68, 68, 255, 0.8);
    transform: translateY(-2px) scale(1.05);
  }

  .player-count {
    font-size: 13px;
    color: #cccccc;
    font-weight: bold;
    opacity: 0.9;
    background: rgba(0, 0, 0, 0.5);
    padding: 4px 8px;
    border-radius: 4px;
  }

  .score-time-container {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: stretch;
    height: 48px;
    border-radius: 12px;
    z-index: 100;
  }

  .team-banner {
    display: flex;
    align-items: center;
    padding: 0 20px;
    color: #ffffff;
    font-weight: bold;
    font-size: 18px;
    min-width: 120px;
    justify-content: flex-start;
    gap: 12px;
  }

  .team-banner.red {
    background: linear-gradient(135deg, #ff4444, #cc3333);
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
  }

  .team-banner.blue {
    background: linear-gradient(135deg, #4444ff, #3333cc);
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
  }

  .team-name {
    font-size: 16px;
  }

  .team-score {
    font-size: 24px;
    font-weight: bold;
  }

  .time-display {
    background: rgba(40, 40, 40, 0.92);
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 0 24px;
    font-size: 16px;
    font-weight: bold;
    min-width: 140px;
  }

  .goals-display {
    position: fixed;
    top: 10px;
    right: 20px;
    background: rgba(40, 40, 40, 0.92);
    padding: 10px 20px;
    border-radius: 8px;
    color: #ffffff;
    font-family: "Trebuchet MS", "Arial", sans-serif;
    font-size: 18px;
    font-weight: bold;
    z-index: 100;
  }

  .game-text {
    position: fixed;
    display: none;
    font-weight: bolder;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    font-size: 8rem;
    text-transform: uppercase;
    letter-spacing: 4px;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
    animation: 
      bounce 0.5s ease-in-out infinite alternate,
      scale 0.5s ease-in-out;
    z-index: 1000;
    text-align: center;
    width: 100%;
  }

  .game-text.red {
    color: #ff4444;
  }

  .game-text.blue {
    color: #4444ff;
  }

  @keyframes bounce {
    from { transform: translate(-50%, -60%); }
    to { transform: translate(-50%, -40%); }
  }

  @keyframes scale {
    0% { transform: translate(-50%, -50%) scale(0); }
    50% { transform: translate(-50%, -50%) scale(1.2); }
    100% { transform: translate(-50%, -50%) scale(1); }
  }

  .countdown-text {
    position: fixed;
    display: none;
    font-weight: bolder;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 6rem;
    text-transform: uppercase;
    letter-spacing: 4px;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
    z-index: 1000;
    text-align: center;
    width: 100%;
    animation: scale-in 0.5s ease-out;
  }

  .cooldown-message {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(40, 40, 40, 0.92);
    color: #ffffff;
    padding: 8px 16px;
    border-radius: 4px;
    font-family: "Trebuchet MS", "Arial", sans-serif;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 1000;
  }

  .cooldown-message.visible {
    opacity: 1;
  }

  .ability-holder {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 64px;
    height: 64px;
    background: rgba(40, 40, 40, 0.92);
    border: 3px solid #ffffff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    z-index: 1000;
  }

  .ability-holder img {
    width: 48px;
    height: 48px;
    object-fit: contain;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }

  .ability-holder img.visible {
    opacity: 1;
  }

  .ability-key {
    position: absolute;
    top: -10px;
    left: -10px;
    background: #ffffff;
    color: #000000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: bold;
    font-family: "Trebuchet MS", "Arial", sans-serif;
  }

  /* ===== ENHANCED GOAL CELEBRATION ===== */
  .game-text {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 72px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 0 0 20px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5);
    text-transform: uppercase;
    letter-spacing: 4px;
    z-index: 2000;
    display: none;
    animation: goalCelebration 3s ease-in-out;
  }

  .game-text.enhanced {
    animation: enhancedGoalCelebration 3s ease-in-out;
  }

  .goal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1999;
    display: none;
    pointer-events: none;
    opacity: 0;
  }

  .goal-overlay.red {
    background: radial-gradient(circle, rgba(255, 68, 68, 0.3) 0%, transparent 70%);
    animation: goalOverlayPulse 2s ease-in-out;
  }

  .goal-overlay.blue {
    background: radial-gradient(circle, rgba(68, 68, 255, 0.3) 0%, transparent 70%);
    animation: goalOverlayPulse 2s ease-in-out;
  }

  /* ===== ANIMATIONS ===== */
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.05); }
  }

  @keyframes celebration {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  @keyframes scoreUpdate {
    0% { 
      transform: scale(1); 
      background: rgba(255, 215, 0, 0.3);
    }
    50% { 
      transform: scale(1.2); 
      background: rgba(255, 215, 0, 0.8);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }
    100% { 
      transform: scale(1); 
      background: transparent;
    }
  }

  @keyframes goalCelebration {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
  }

  @keyframes enhancedGoalCelebration {
    0% { transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); opacity: 0; }
    20% { transform: translate(-50%, -50%) scale(1.3) rotate(5deg); opacity: 1; }
    40% { transform: translate(-50%, -50%) scale(0.9) rotate(-2deg); opacity: 1; }
    60% { transform: translate(-50%, -50%) scale(1.1) rotate(1deg); opacity: 1; }
    80% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(0.7) rotate(0deg); opacity: 0; }
  }

  @keyframes goalOverlayPulse {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }

  @keyframes countdownPulse {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  }

  @keyframes scale-in {
    0% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  }

  /* ===== ENHANCED EXISTING ELEMENTS ===== */
  .countdown-text {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 120px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    z-index: 1500;
    display: none;
    animation: countdownPulse 1s ease-in-out;
  }

  .cooldown-message {
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 165, 0, 0.9);
    color: #ffffff;
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1200;
    backdrop-filter: blur(10px);
  }

  .cooldown-message.visible {
    opacity: 1;
  }

  .ability-holder {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px 15px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
  }

  .ability-key {
    background: rgba(255, 255, 255, 0.2);
    color: #ffffff;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: bold;
  }

  #ability-icon {
    width: 40px;
    height: 40px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  #ability-icon.visible {
    opacity: 1;
  }

  .goals-display {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: #ffffff;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    border: 2px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    max-width: 200px;
    width: auto;
    height: auto;
    z-index: 100;
    pointer-events: none;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    .score-time-container {
      padding: 10px 15px;
      gap: 15px;
    }
    
    .team-score {
      font-size: 24px;
    }
    
    .stats-panel {
      right: 10px;
      min-width: 200px;
      padding: 15px;
    }
    
    .instructions-panel {
      width: 95vw;
      padding: 20px;
      max-height: 95vh;
    }
    
    .title-logo {
      width: min(200px, 50vw);
      height: min(200px, 50vw);
    }
    
    .game-mode-buttons {
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }
    
    .game-mode-btn {
      min-width: 80%;
      max-width: 300px;
      padding: 18px 20px;
    }
    
    .team-selection {
      gap: 15px;
    }
    
    .team-btn {
      min-width: 120px;
      padding: 14px 24px;
      font-size: 14px;
    }
    
    .selected-mode-info {
      margin: 15px 0;
      padding: 12px;
    }
  }

  @media (max-width: 480px) {
    .instructions-panel {
      padding: 15px;
    }
    
    .game-mode-title {
      font-size: 20px;
    }
    
    .team-selection {
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }
  }

  /* Enhanced Game Over Styles */
  .game-over-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .game-over-message {
    font-size: 32px;
    font-weight: bold;
    color: #FFD700;
    text-align: center;
    margin-bottom: 16px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .team-stats-container {
    margin-bottom: 30px;
  }

  .team-stats-header {
    font-size: 24px;
    font-weight: bold;
    color: #FFD700;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }

  .team-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    max-width: 600px;
    margin: 0 auto;
  }

  .team-stat-column {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    padding: 20px;
    border: 2px solid;
  }

  .team-stat-column.red-team {
    border-color: #ff4444;
  }

  .team-stat-column.blue-team {
    border-color: #4444ff;
  }

  .team-stat-column .team-name {
    font-size: 20px;
    font-weight: bold;
    text-align: center;
    margin-bottom: 15px;
    color: white;
  }

  .team-stat-column .stat-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    color: white;
  }

  .team-stat-column .stat-label {
    font-weight: bold;
  }

  .team-stat-column .stat-value {
    color: #FFD700;
    font-weight: bold;
  }

  .player-stats-container {
    margin-bottom: 20px;
  }

  .player-stats-header {
    font-size: 24px;
    font-weight: bold;
    color: #FFD700;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }

  .player-stats-tabs {
    display: flex;
    justify-content: flex-start;
    margin-bottom: 20px;
    gap: 10px;
  }

  .tab-button {
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: 2px solid #666;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .tab-button.active {
    background: #FFD700;
    color: black;
    border-color: #FFD700;
  }

  .tab-button:hover {
    background: rgba(255, 215, 0, 0.2);
  }

  .player-stats-content {
    max-width: 800px;
    margin: 0 auto;
  }

  .player-stat-card {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 15px;
    align-items: center;
  }

  .player-stat-card.red-player {
    border-left-color: #ff4444;
  }

  .player-stat-card.blue-player {
    border-left-color: #4444ff;
  }

  .player-name {
    font-weight: bold;
    color: white;
    font-size: 16px;
  }

  .player-role {
    color: #ccc;
    font-size: 12px;
    text-transform: capitalize;
  }

  .player-stat-group {
    text-align: center;
  }

  .player-stat-group .stat-number {
    font-size: 18px;
    font-weight: bold;
    color: #FFD700;
    display: block;
  }

  .player-stat-group .stat-name {
    font-size: 11px;
    color: #ccc;
    text-transform: uppercase;
  }

  /* ===== GAME MODE SELECTION STYLES ===== */
  .game-mode-selection {
    margin: 20px 0;
    padding: 0 10px;
  }

  .game-mode-title {
    color: #FFD700;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .game-mode-buttons {
    display: flex;
    gap: 20px;
    justify-content: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .game-mode-btn {
    position: relative;
    padding: 20px 25px;
    border: 3px solid transparent;
    border-radius: 15px;
    background: rgba(0, 0, 0, 0.4);
    color: #ffffff;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer !important;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(10px);
    overflow: hidden;
    min-width: 200px;
    flex: 1;
    max-width: 300px;
    pointer-events: auto;
    outline: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  .game-mode-btn.fifa {
    border-color: #00AA00;
    background: linear-gradient(135deg, rgba(0, 170, 0, 0.2), rgba(0, 170, 0, 0.1));
  }

  .game-mode-btn.fifa:hover {
    border-color: #00FF00;
    background: linear-gradient(135deg, rgba(0, 170, 0, 0.4), rgba(0, 170, 0, 0.2));
    box-shadow: 0 10px 30px rgba(0, 170, 0, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.arcade {
    border-color: #FF6600;
    background: linear-gradient(135deg, rgba(255, 102, 0, 0.2), rgba(255, 102, 0, 0.1));
  }

  .game-mode-btn.arcade:hover {
    background: linear-gradient(135deg, #f7931e, #ff8c42, #ffb366);
    box-shadow: 
      0 8px 30px rgba(255, 107, 53, 0.6),
      0 0 20px rgba(255, 215, 0, 0.4),
      inset 0 2px 6px rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.pickup {
    border-color: #9366FF;
    background: linear-gradient(135deg, rgba(147, 102, 255, 0.2), rgba(147, 102, 255, 0.1));
  }

  .game-mode-btn.pickup:hover {
    border-color: #B388FF;
    background: linear-gradient(135deg, rgba(147, 102, 255, 0.4), rgba(147, 102, 255, 0.2));
    box-shadow: 0 10px 30px rgba(147, 102, 255, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.tournament {
    border-color: #FFD700;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
  }

  .game-mode-btn.tournament:hover {
    border-color: #FFED4A;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 215, 0, 0.2));
    box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.selected {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
    border-color: #FFD700;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
  }

  .game-mode-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
  }

  .game-mode-btn:hover::before {
    left: 100%;
  }

  .mode-description {
    font-size: 12px;
    margin-top: 8px;
    opacity: 0.8;
    font-weight: normal;
    text-transform: none;
    letter-spacing: 0;
  }

  .mode-features {
    font-size: 10px;
    margin-top: 5px;
    opacity: 0.6;
    font-weight: normal;
    text-transform: none;
    letter-spacing: 0;
  }

  .selected-mode-info {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    padding: 15px;
    margin: 20px auto;
    max-width: 100%;
    border: 2px solid rgba(255, 215, 0, 0.3);
    backdrop-filter: blur(10px);
  }

  .selected-mode-info h3 {
    color: #FFD700;
    font-size: 16px;
    margin-bottom: 10px;
    text-align: center;
  }

  .selected-mode-info p {
    color: #ffffff;
    font-size: 13px;
    line-height: 1.4;
    margin-bottom: 8px;
  }

  .selected-mode-info .features-list {
    color: #cccccc;
    font-size: 12px;
    line-height: 1.3;
  }

  /* ===== PLAYER COUNT SELECTION STYLES ===== */
  .player-count-selection {
    margin: 20px 0;
    padding: 0 10px;
  }

  .player-count-title {
    color: #FFD700;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .player-count-buttons {
    display: flex;
    gap: 20px;
    justify-content: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .game-mode-btn.single-player {
    border-color: #00AA00;
    background: linear-gradient(135deg, rgba(0, 170, 0, 0.2), rgba(0, 170, 0, 0.1));
    cursor: pointer !important;
  }

  .game-mode-btn.single-player:hover {
    border-color: #00FF00;
    background: linear-gradient(135deg, rgba(0, 170, 0, 0.4), rgba(0, 170, 0, 0.2));
    box-shadow: 0 10px 30px rgba(0, 170, 0, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.multiplayer {
    border-color: #6666FF;
    background: linear-gradient(135deg, rgba(102, 102, 255, 0.2), rgba(102, 102, 255, 0.1));
    cursor: pointer !important;
  }

  .game-mode-btn.multiplayer:hover {
    border-color: #8888FF;
    background: linear-gradient(135deg, rgba(102, 102, 255, 0.4), rgba(102, 102, 255, 0.2));
    box-shadow: 0 10px 30px rgba(102, 102, 255, 0.3);
    transform: translateY(-3px);
    cursor: pointer !important;
  }
  
  /* CRITICAL FIX: Player Count Selection Button Styling */
  .player-count-selection {
    margin: 20px 0;
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    pointer-events: auto !important;
  }
  
  .player-count-title {
    color: #FFD700;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }
  
  .player-count-buttons {
    display: flex;
    gap: 24px;
    justify-content: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  /* Enhanced styling for player count buttons */
  .player-count-buttons .game-mode-btn {
    min-width: 200px;
    padding: 20px 24px;
    pointer-events: auto !important;
    cursor: pointer !important;
    z-index: 1000;
    position: relative;
  }
  
  .player-count-buttons .game-mode-btn:hover {
    cursor: pointer !important;
    pointer-events: auto !important;
  }
  
  .player-count-buttons .game-mode-btn.selected {
    border-color: #FFD700 !important;
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.6) !important;
    transform: translateY(-2px) scale(1.05) !important;
  }
  
  /* Global cursor enforcement to prevent Hytopia pointer lock conflicts */
  button, .btn, .team-btn, .game-mode-btn, input, select, textarea, [onclick], [role="button"] {
    cursor: pointer !important;
  }
  
  button:hover, .btn:hover, .team-btn:hover, .game-mode-btn:hover, input:hover, select:hover, textarea:hover, [onclick]:hover, [role="button"]:hover {
    cursor: pointer !important;
  }
  
  /* Prevent pointer events interference on UI containers */
  .game-mode-selection, .player-count-selection, .team-selection, .instructions-panel, .ui-container {
    pointer-events: auto !important;
  }
  
  /* Override any potential cursor resets */
  * {
    cursor: inherit !important;
  }
  
  body, html {
    cursor: default !important;
  }

  /* ===== HALFTIME BUTTON CRITICAL STYLES ===== */
  #start-second-half-btn {
    cursor: pointer !important;
    pointer-events: auto !important;
    z-index: 10002 !important;
    position: relative !important;
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  #start-second-half-btn:hover {
    cursor: pointer !important;
    pointer-events: auto !important;
  }

  #halftime-stats-overlay {
    cursor: default !important;
    pointer-events: auto !important;
    z-index: 10000 !important;
  }

  #halftime-stats-overlay * {
    cursor: inherit !important;
    pointer-events: auto !important;
  }

  .multiplayer-lobby {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    padding: 20px;
    margin: 20px auto;
    max-width: 400px;
    border: 2px solid rgba(102, 102, 255, 0.3);
    backdrop-filter: blur(10px);
    text-align: center;
  }

  .lobby-message {
    color: #ffffff;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .player-count-display {
    color: #6666FF;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .current-players {
    color: #00FF00;
  }

  .required-players {
    color: #FFD700;
  }

  /* ===== ANIMATIONS FOR NOTIFICATIONS ===== */
  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translate(-50%, -60%);
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%);
    }
  }

  @keyframes slideOutUp {
    from {
      opacity: 1;
      transform: translate(-50%, -50%);
    }
    to {
      opacity: 0;
      transform: translate(-50%, -40%);
    }
  }

  /* ===== HALFTIME BUTTON ANIMATIONS ===== */
  @keyframes pulse {
    0% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.8;
      transform: scale(1.05);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes glow {
    0% {
      box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
      transform: scale(1);
    }
    100% {
      box-shadow: 0 12px 35px rgba(34, 197, 94, 0.6);
      transform: scale(1.02);
    }
  }

  /* ===== HALFTIME OVERLAY ANIMATIONS ===== */
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  /* ===== PAUSE SCREEN STYLES ===== */
  #pause-stats-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    z-index: 10000;
    color: white;
    font-family: 'Inter', sans-serif;
    animation: fadeIn 0.5s ease-in;
    pointer-events: auto;
    cursor: default;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
  }

  #pause-stats-overlay * {
    cursor: inherit !important;
    pointer-events: auto !important;
  }

  #return-to-game-btn {
    background: linear-gradient(135deg, #22c55e, #16a34a, #22c55e);
    color: white;
    border: 3px solid #22c55e;
    padding: 20px 40px;
    font-size: 20px;
    font-weight: bold;
    border-radius: 15px;
    cursor: pointer !important;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
    font-family: 'Inter', sans-serif;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    z-index: 10002;
    pointer-events: auto !important;
    min-width: 220px;
    margin: 0 auto;
    display: block;
    animation: glow 2s infinite alternate;
  }

  #return-to-game-btn:hover {
    cursor: pointer !important;
    pointer-events: auto !important;
    transform: scale(1.05);
    box-shadow: 0 15px 40px rgba(34, 197, 94, 0.6);
  }
</style>

<!-- MAIN SCOREBOARD SYSTEM -->
<div id="main-scoreboard" class="score-time-container">
  <div class="team-banner red" id="red-banner">
    <div class="team-name">Red</div>
    <div class="team-score" id="red-score">0</div>
  </div>
  <div class="time-display">
    <div class="phase-indicator" id="phase-indicator">LOBBY</div>
    <span class="time-label" id="time-left">Waiting...</span>
  </div>
  <div class="team-banner blue" id="blue-banner">
    <div class="team-name">Blue</div>
    <div class="team-score" id="blue-score">0</div>
  </div>
</div>

<!-- ARCADE MODE INDICATOR -->
<div id="arcade-mode-indicator" class="arcade-mode-indicator">
  <span>🎪</span> ARCADE MODE - ENHANCED SOCCER!
</div>

<!-- POWERUP CONTAINER -->
<div id="powerup-container" class="powerup-container" style="position: fixed !important; bottom: 10px !important; right: 10px !important; z-index: 1000 !important;">
  <div class="powerup-title">🎮 ARCADE POWER-UPS</div>
  
  <div class="powerup-button" id="freeze-blast-btn" onclick="activatePowerUp('freeze_blast')">
    <div class="powerup-icon">🧊</div>
    <div class="powerup-name">Freeze Blast (1)</div>
    <div class="powerup-cooldown" id="freeze-blast-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="speed-btn" onclick="activatePowerUp('speed')">
    <div class="powerup-icon">⚡</div>
    <div class="powerup-name">Speed Boost (2)</div>
    <div class="powerup-cooldown" id="speed-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="fireball-btn" onclick="activatePowerUp('fireball')">
    <div class="powerup-icon">🔥</div>
    <div class="powerup-name">Fireball (3)</div>
    <div class="powerup-cooldown" id="fireball-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="mega-kick-btn" onclick="activatePowerUp('mega_kick')">
    <div class="powerup-icon">⚽</div>
    <div class="powerup-name">Mega Kick (4)</div>
    <div class="powerup-cooldown" id="mega-kick-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="power-btn" onclick="activatePowerUp('power')">
    <div class="powerup-icon">💥</div>
    <div class="powerup-name">Power Boost (5)</div>
    <div class="powerup-cooldown" id="power-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="precision-btn" onclick="activatePowerUp('precision')">
    <div class="powerup-icon">🎯</div>
    <div class="powerup-name">Precision (6)</div>
    <div class="powerup-cooldown" id="precision-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="stamina-btn" onclick="activatePowerUp('stamina')">
    <div class="powerup-icon">🧪</div>
    <div class="powerup-name">Stamina (7)</div>
    <div class="powerup-cooldown" id="stamina-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="shuriken-btn" onclick="activatePowerUp('shuriken')">
    <div class="powerup-icon">🥷</div>
    <div class="powerup-name">Shuriken (8)</div>
    <div class="powerup-cooldown" id="shuriken-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="shield-btn" onclick="activatePowerUp('shield')">
    <div class="powerup-icon">🛡️</div>
    <div class="powerup-name">Shield (U)</div>
    <div class="powerup-cooldown" id="shield-cooldown"></div>
  </div>
  
  <div class="powerup-button" id="random-powerup-btn" onclick="activateRandomPowerUp()">
    <div class="powerup-icon">🎲</div>
    <div class="powerup-name">Random (F)</div>
    <div class="powerup-cooldown" id="random-powerup-cooldown"></div>
  </div>
</div>

<!-- POWERUP EFFECT DISPLAY -->
<div id="powerup-effect-display" class="powerup-effect-display"></div>

<!-- Enhanced Team Selection -->
<style>
  .team-selection {
    margin: 20px 0;
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    border: 2px solid rgba(255, 255, 255, 0.1);
  }

  .team-selection-title {
    color: #FFD700;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .team-buttons-container {
    display: flex;
    gap: 24px;
    justify-content: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .team-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    min-width: 140px;
  }

  .team-btn {
    padding: 16px 32px;
    border: 3px solid transparent;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 140px;
    position: relative;
    overflow: hidden;
  }

  .team-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
  }

  .team-btn:hover::before {
    left: 100%;
  }

  .team-btn.red {
    background: linear-gradient(135deg, #ff4444, #cc3333);
    color: #ffffff;
    border-color: #ff6666;
  }

  .team-btn.red:hover {
    background: linear-gradient(135deg, #ff6666, #ff4444);
    border-color: #ffffff;
    box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
    transform: translateY(-2px) scale(1.05);
  }

  .team-btn.red.selected {
    border-color: #ffffff;
    box-shadow: 0 0 25px rgba(255, 68, 68, 0.8);
    transform: translateY(-2px) scale(1.05);
  }

  .team-btn.blue {
    background: linear-gradient(135deg, #4444ff, #3333cc);
    color: #ffffff;
    border-color: #6666ff;
  }

  .team-btn.blue:hover {
    background: linear-gradient(135deg, #6666ff, #4444ff);
    border-color: #ffffff;
    box-shadow: 0 0 20px rgba(68, 68, 255, 0.6);
    transform: translateY(-2px) scale(1.05);
  }

  .team-btn.blue.selected {
    border-color: #ffffff;
    box-shadow: 0 0 25px rgba(68, 68, 255, 0.8);
    transform: translateY(-2px) scale(1.05);
  }

  .player-count {
    font-size: 13px;
    color: #cccccc;
    font-weight: bold;
    opacity: 0.9;
    background: rgba(0, 0, 0, 0.5);
    padding: 4px 8px;
    border-radius: 4px;
  }



  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    .instructions-panel {
      width: 95vw;
      padding: 20px;
      max-height: 95vh;
    }
    
    .title-logo {
      width: min(200px, 50vw);
      height: min(200px, 50vw);
    }
    
    .game-mode-buttons {
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }
    
    .game-mode-btn {
      min-width: 80%;
      max-width: 300px;
      padding: 18px 20px;
    }
    
         .team-selection {
       padding: 15px;
     }

     .team-selection-title {
       font-size: 18px;
       margin-bottom: 15px;
     }

     .team-buttons-container {
       gap: 15px;
     }
     
     .team-btn {
       min-width: 120px;
       padding: 14px 24px;
       font-size: 14px;
     }
    
    .selected-mode-info {
      margin: 15px 0;
      padding: 12px;
    }
  }

  @media (max-width: 480px) {
    .instructions-panel {
      padding: 15px;
    }
    
    .game-mode-title {
      font-size: 20px;
    }
    
    .team-selection {
      padding: 12px;
    }

    .team-selection-title {
      font-size: 16px;
    }

    .team-buttons-container {
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .team-btn {
      min-width: 200px;
      padding: 16px 20px;
    }
  }

  /* ===== ARCADE MODE POWER-UP SYSTEM STYLES ===== */
  .powerup-container {
    position: fixed;
    bottom: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
    z-index: 1000;
  }

  /* FORCE BOTTOM RIGHT POSITIONING - HIGHEST SPECIFICITY */
  #powerup-container.powerup-container {
    position: fixed !important;
    bottom: 10px !important;
    right: 10px !important;
    z-index: 1000 !important;
  }

  .powerup-button {
    width: 85px;
    height: 85px;
    border-radius: 50%;
    border: 3px solid #ffd700;
    background: linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    pointer-events: auto;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 
      0 4px 15px rgba(255, 107, 53, 0.4),
      inset 0 2px 4px rgba(255, 255, 255, 0.2),
      inset 0 -2px 4px rgba(0, 0, 0, 0.1);
  }

  .powerup-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s ease;
  }

  .powerup-button:hover {
    transform: scale(1.15) rotate(5deg);
    box-shadow: 
      0 8px 30px rgba(255, 107, 53, 0.6),
      0 0 20px rgba(255, 215, 0, 0.4),
      inset 0 2px 6px rgba(255, 255, 255, 0.3);
    border-color: #ffed4e;
    border-width: 4px;
  }

  .powerup-button:hover::before {
    left: 100%;
  }

  .powerup-button:active {
    transform: scale(1.05) rotate(2deg);
    transition: all 0.1s ease;
  }

  .powerup-button.on-cooldown {
    background: linear-gradient(135deg, #666, #888, #777);
    border-color: #aaa;
    cursor: not-allowed;
    transform: scale(0.85);
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.3),
      inset 0 2px 4px rgba(0, 0, 0, 0.2);
    filter: grayscale(0.7);
  }

  .powerup-button.on-cooldown:hover {
    transform: scale(0.85);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .powerup-button.activating {
    animation: powerup-activation 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes powerup-activation {
    0% { 
      transform: scale(1) rotate(0deg);
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
    }
    30% { 
      transform: scale(1.4) rotate(15deg);
      box-shadow: 0 12px 40px rgba(255, 215, 0, 0.8);
      border-color: #ffed4e;
      border-width: 5px;
    }
    60% {
      transform: scale(1.2) rotate(-5deg);
      box-shadow: 0 10px 35px rgba(255, 107, 53, 0.7);
    }
    100% { 
      transform: scale(1) rotate(0deg);
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
    }
  }

  .powerup-icon {
    font-size: 36px;
    color: white;
    text-shadow: 
      2px 2px 4px rgba(0, 0, 0, 0.8),
      0 0 10px rgba(255, 255, 255, 0.3);
    z-index: 2;
    transition: all 0.3s ease;
  }

  .powerup-button:hover .powerup-icon {
    font-size: 40px;
    text-shadow: 
      3px 3px 6px rgba(0, 0, 0, 0.8),
      0 0 15px rgba(255, 255, 255, 0.5);
  }

  .powerup-cooldown-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: conic-gradient(from 0deg, transparent 0%, rgba(0, 0, 0, 0.8) 0%);
    border-radius: 50%;
    transition: background 0.1s ease;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    color: white;
    font-weight: bold;
    font-size: 14px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }

  .powerup-key-hint {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    pointer-events: none;
    border: 1px solid rgba(255, 215, 0, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    opacity: 0;
    transition: all 0.3s ease;
  }

  .powerup-button:hover .powerup-key-hint {
    opacity: 1;
    top: -35px;
  }

  .powerup-effect-display {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 
      3px 3px 6px rgba(0, 0, 0, 0.8),
      0 0 20px rgba(255, 215, 0, 0.6);
    pointer-events: none;
    z-index: 2000;
    opacity: 0;
    animation: powerup-effect-flash 2.5s ease-out;
  }

  @keyframes powerup-effect-flash {
    0% { 
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.3) rotate(-10deg);
    }
    15% { 
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.3) rotate(5deg);
    }
    30% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1) rotate(-2deg);
    }
    70% { 
      opacity: 1;
      transform: translate(-50%, -50%) scale(1) rotate(0deg);
    }
    100% { 
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8) rotate(0deg);
    }
  }

  .arcade-mode-indicator {
    position: fixed;
    top: 20px;
    left: 20px;
    background: linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42);
    color: white;
    padding: 12px 24px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 16px;
    border: 3px solid #ffd700;
    box-shadow: 
      0 4px 15px rgba(255, 107, 53, 0.4),
      inset 0 2px 4px rgba(255, 255, 255, 0.2);
    z-index: 1000;
    display: none;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .arcade-mode-indicator.visible {
    display: block;
    animation: arcade-mode-pulse 3s infinite;
  }

  @keyframes arcade-mode-pulse {
    0%, 100% { 
      box-shadow: 
        0 4px 15px rgba(255, 107, 53, 0.4),
        inset 0 2px 4px rgba(255, 255, 255, 0.2);
      transform: scale(1);
    }
    50% { 
      box-shadow: 
        0 8px 30px rgba(255, 215, 0, 0.6),
        0 0 20px rgba(255, 107, 53, 0.4),
        inset 0 2px 6px rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
  }

  /* ===== ENHANCED POWER-UP PANEL STYLES ===== */
  .powerup-panel {
    position: fixed;
    top: 100px;
    left: 20px;
    background: linear-gradient(135deg, rgba(255, 102, 0, 0.95), rgba(255, 140, 0, 0.95), rgba(255, 165, 0, 0.95));
    border-radius: 20px;
    padding: 25px;
    border: 3px solid rgba(255, 215, 0, 0.8);
    backdrop-filter: blur(15px);
    box-shadow: 
      0 10px 40px rgba(255, 102, 0, 0.5),
      inset 0 2px 4px rgba(255, 255, 255, 0.2),
      inset 0 -2px 4px rgba(0, 0, 0, 0.1);
    min-width: 280px;
    max-width: 320px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 998;
  }

  .powerup-panel.hidden {
    transform: translateX(-110%);
    opacity: 0;
  }

  .powerup-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
    border-radius: 17px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .powerup-panel:hover::before {
    opacity: 1;
  }

  .powerup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.4);
  }

  .powerup-title {
    font-size: 18px;
    font-weight: bold;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 
      2px 2px 4px rgba(0, 0, 0, 0.8),
      0 0 10px rgba(255, 255, 255, 0.3);
  }

  .powerup-active {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 193, 7, 0.3));
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 12px;
    border: 2px solid rgba(255, 215, 0, 0.6);
    box-shadow: 
      0 4px 15px rgba(255, 215, 0, 0.2),
      inset 0 2px 4px rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }

  .powerup-active:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 6px 20px rgba(255, 215, 0, 0.3),
      inset 0 2px 6px rgba(255, 255, 255, 0.3);
  }

  .powerup-name {
    font-size: 16px;
    font-weight: bold;
    color: #FFD700;
    margin-bottom: 6px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }

  .powerup-description {
    font-size: 13px;
    color: #ffffff;
    opacity: 0.95;
    line-height: 1.4;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
  }

  .powerup-cooldown {
    font-size: 11px;
    color: #ffcccc;
    margin-top: 6px;
    font-style: italic;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
  }

  .powerup-instructions {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(20, 20, 20, 0.4));
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .powerup-key {
    display: inline-block;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: bold;
    color: #ffffff;
    margin-right: 6px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    box-shadow: 
      0 2px 4px rgba(0, 0, 0, 0.3),
      inset 0 1px 2px rgba(255, 255, 255, 0.3);
  }

  /* ===== RESPONSIVE DESIGN ENHANCEMENTS ===== */
  @media (max-width: 1024px) {
    .powerup-container {
      bottom: 10px;
      right: 10px;
      gap: 8px;
    }
    
    #powerup-container.powerup-container {
      bottom: 10px !important;
      right: 10px !important;
      gap: 8px !important;
    }
    
    .powerup-button {
      width: 75px;
      height: 75px;
    }
    
    .powerup-icon {
      font-size: 30px;
    }
    
    .powerup-panel {
      min-width: 220px;
        margin: 0 auto;
        display: block;
      max-width: 280px;
      padding: 20px;
    }
  }

  @media (max-width: 768px) {
    .powerup-container {
      bottom: 10px;
      right: 10px;
      gap: 6px;
    }
    
    #powerup-container.powerup-container {
      bottom: 10px !important;
      right: 10px !important;
      gap: 6px !important;
    }
    
    .powerup-button {
      width: 65px;
      height: 65px;
    }
    
    .powerup-icon {
      font-size: 26px;
    }
    
    .powerup-button:hover .powerup-icon {
      font-size: 28px;
    }
    
    .powerup-key-hint {
      font-size: 10px;
      padding: 4px 6px;
    }
    
    .powerup-panel {
      min-width: 220px;
      max-width: 250px;
      padding: 18px;
      top: 80px;
      left: 10px;
    }
    
    .powerup-title {
      font-size: 16px;
      letter-spacing: 1px;
    }
    
    .arcade-mode-indicator {
      padding: 10px 18px;
      font-size: 14px;
      top: 15px;
      left: 15px;
    }
  }

  @media (max-width: 480px) {
    .powerup-container {
      flex-direction: row;
      bottom: 10px;
      right: 50%;
      transform: translateX(50%);
      gap: 6px;
    }
    
    #powerup-container.powerup-container {
      flex-direction: row !important;
      bottom: 10px !important;
      right: 50% !important;
      transform: translateX(50%) !important;
      gap: 6px !important;
    }
    
    .powerup-button {
      width: 55px;
      height: 55px;
    }
    
    .powerup-icon {
      font-size: 22px;
    }
    
    .powerup-key-hint {
      top: -25px;
      font-size: 9px;
    }
    
    .powerup-panel {
      position: fixed;
      top: auto;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 90vw;
      max-width: 90vw;
      padding: 15px;
    }
    
    .powerup-panel.hidden {
      transform: translateX(-50%) translateY(100%);
    }
    
    .arcade-mode-indicator {
      padding: 8px 15px;
      font-size: 12px;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
    }
  }

  /* ===== ENHANCED VISUAL EFFECTS ===== */
  .powerup-ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 215, 0, 0.4);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
  }

  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  .powerup-glow {
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    border-radius: 50%;
    background: linear-gradient(45deg, #ffd700, #ff8c42, #ffd700);
    opacity: 0;
    z-index: -1;
    animation: glow 2s ease-in-out infinite alternate;
  }

  @keyframes glow {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 0.3;
      transform: scale(1.05);
    }
  }

  .powerup-button.ready .powerup-glow {
    animation-duration: 1.5s;
  }

  /* ===== POWERUP EFFECT DISPLAY ===== */
  .powerup-effect-display {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    background: rgba(0, 0, 0, 0.9);
    color: #ffd700;
    padding: 30px 40px;
    border-radius: 15px;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    border: 3px solid #ffd700;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
    display: none;
    pointer-events: none;
    animation: powerup-effect-flash 2.5s ease-out;
  }

  @keyframes powerup-effect-flash {
    0% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.5);
    }
    20% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.2);
    }
    40% {
      transform: translate(-50%, -50%) scale(1);
    }
    60% {
      opacity: 1;
    }
    100% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(1);
    }
  }

  /* ===== FEEDBACK ANIMATIONS ===== */
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  /* Removed first duplicate FORCE positioning rules - using clean CSS architecture instead */

  /* Removed second duplicate FORCE positioning rules - using clean CSS architecture instead */

  /* ===== ENHANCED GAME MODE SELECTION POLISH ===== */
  .game-mode-btn.fifa {
    background: linear-gradient(135deg, #1e3c72, #2a5298, #3b6eb8);
    border: 3px solid #4a90e2;
    box-shadow: 
      0 6px 20px rgba(30, 60, 114, 0.4),
      inset 0 2px 4px rgba(255, 255, 255, 0.2);
  }

  .game-mode-btn.fifa:hover {
    background: linear-gradient(135deg, #2a5298, #3b6eb8, #4a90e2);
    box-shadow: 
      0 8px 30px rgba(30, 60, 114, 0.6),
      0 0 20px rgba(74, 144, 226, 0.4),
      inset 0 2px 6px rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.arcade {
    background: linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42);
    border: 3px solid #ffd700;
    box-shadow: 
      0 6px 20px rgba(255, 107, 53, 0.4),
      inset 0 2px 4px rgba(255, 255, 255, 0.2);
  }

  .game-mode-btn.arcade:hover {
    background: linear-gradient(135deg, #f7931e, #ff8c42, #ffb366);
    box-shadow: 
      0 8px 30px rgba(255, 107, 53, 0.6),
      0 0 20px rgba(255, 215, 0, 0.4),
      inset 0 2px 6px rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.pickup {
    background: linear-gradient(135deg, #9c27b0, #673ab7, #7b1fa2);
    border: 3px solid #e91e63;
    box-shadow: 
      0 6px 20px rgba(156, 39, 176, 0.4),
      inset 0 2px 4px rgba(255, 255, 255, 0.2);
  }

  .game-mode-btn.pickup:hover {
    background: linear-gradient(135deg, #673ab7, #7b1fa2, #9c27b0);
    box-shadow: 
      0 8px 30px rgba(156, 39, 176, 0.6),
      0 0 20px rgba(233, 30, 99, 0.4),
      inset 0 2px 6px rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.tournament {
    background: linear-gradient(135deg, #ffd700, #ffed4a, #fff59d);
    border: 3px solid #ff6f00;
    box-shadow: 
      0 6px 20px rgba(255, 215, 0, 0.4),
      inset 0 2px 4px rgba(255, 255, 255, 0.2);
  }

  .game-mode-btn.tournament:hover {
    background: linear-gradient(135deg, #ffed4a, #fff59d, #fffde7);
    box-shadow: 
      0 8px 30px rgba(255, 215, 0, 0.6),
      0 0 20px rgba(255, 111, 0, 0.4),
      inset 0 2px 6px rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
  }

  .game-mode-btn.selected {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 
      0 10px 35px rgba(255, 215, 0, 0.5),
      0 0 25px rgba(255, 255, 255, 0.3),
      inset 0 3px 8px rgba(255, 255, 255, 0.4);
  }

  /* Enhanced notification animations */
  @keyframes slideInDown {
    from { 
      transform: translateX(-50%) translateY(-100%); 
      opacity: 0; 
    }
    to { 
      transform: translateX(-50%) translateY(0); 
      opacity: 1; 
    }
  }

  @keyframes slideOutUp {
    from { 
      transform: translateX(-50%) translateY(0); 
      opacity: 1; 
    }
    to { 
      transform: translateX(-50%) translateY(-100%); 
      opacity: 0; 
    }
  }

  /* ===== TOURNAMENT MODE STYLES ===== */
  .tournament-selection {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .tournament-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .tournament-title {
    font-size: 32px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    margin-bottom: 8px;
  }

  .tournament-subtitle {
    font-size: 16px;
    color: #cccccc;
    opacity: 0.9;
  }

  .tournament-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }

  .tournament-section {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 15px;
    padding: 25px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    backdrop-filter: blur(10px);
  }

  .tournament-section h3 {
    color: #FFD700;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
  }

  /* Tournament Creation Form */
  .tournament-create-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .form-group label {
    color: #ffffff;
    font-weight: bold;
    font-size: 14px;
  }

  .form-group input,
  .form-group select {
    padding: 12px;
    border-radius: 8px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    background: rgba(0, 0, 0, 0.5);
    color: #ffffff;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .form-group input:focus,
  .form-group select:focus {
    border-color: #FFD700;
    outline: none;
  }

  .tournament-create-btn {
    padding: 15px 25px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000000;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
  }

  .tournament-create-btn:hover {
    background: linear-gradient(135deg, #FFED4A, #FFB347);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
  }

  /* Active Tournaments List */
  .active-tournaments {
    min-height: 100px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .no-tournaments {
    color: #888888;
    text-align: center;
    font-style: italic;
    padding: 20px;
  }

  .tournament-item {
    background: rgba(255, 215, 0, 0.1);
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .tournament-item:hover {
    background: rgba(255, 215, 0, 0.2);
    border-color: rgba(255, 215, 0, 0.5);
    transform: translateY(-2px);
  }

  .tournament-item-name {
    color: #FFD700;
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 5px;
  }

  .tournament-item-details {
    color: #cccccc;
    font-size: 12px;
    margin-bottom: 8px;
  }

  .tournament-item-status {
    color: #00FF00;
    font-size: 12px;
    font-weight: bold;
  }

  /* Tournament Lobby */
  .tournament-lobby {
    padding: 20px;
  }

  .tournament-info {
    text-align: center;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    border: 2px solid rgba(255, 215, 0, 0.3);
  }

  .tournament-name {
    font-size: 24px;
    font-weight: bold;
    color: #FFD700;
    margin-bottom: 8px;
  }

  .tournament-details {
    font-size: 14px;
    color: #cccccc;
    margin-bottom: 8px;
  }

  .tournament-status {
    font-size: 16px;
    font-weight: bold;
    color: #00FF00;
  }

  .tournament-content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 25px;
    margin-bottom: 25px;
  }

  /* Tournament Players */
  .tournament-players {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 15px;
    padding: 20px;
    border: 2px solid rgba(255, 255, 255, 0.2);
  }

  .tournament-players h3 {
    color: #FFD700;
    font-size: 18px;
    margin-bottom: 15px;
    text-align: center;
  }

  .players-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .player-slot {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .player-slot.filled {
    background: rgba(0, 255, 0, 0.2);
    border-color: rgba(0, 255, 0, 0.4);
  }

  .player-slot.online {
    border-color: rgba(0, 255, 0, 0.6);
  }

  .player-slot.offline {
    border-color: rgba(255, 0, 0, 0.4);
    background: rgba(255, 0, 0, 0.1);
  }

  .player-name {
    color: #ffffff;
    font-weight: bold;
    font-size: 14px;
  }

  .player-status {
    color: #cccccc;
    font-size: 12px;
    margin-top: 4px;
  }

  /* Tournament Bracket */
  .tournament-bracket {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 15px;
    padding: 20px;
    border: 2px solid rgba(255, 255, 255, 0.2);
  }

  .tournament-bracket h3 {
    color: #FFD700;
    font-size: 18px;
    margin-bottom: 15px;
    text-align: center;
  }

  .bracket-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .bracket-round {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .bracket-round-title {
    color: #FFD700;
    font-weight: bold;
    text-align: center;
    margin-bottom: 10px;
  }

  .bracket-match {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    border: 2px solid rgba(255, 255, 255, 0.2);
  }

  .bracket-match.scheduled {
    border-color: rgba(255, 215, 0, 0.4);
  }

  .bracket-match.in-progress {
    border-color: rgba(0, 255, 0, 0.4);
    background: rgba(0, 255, 0, 0.1);
  }

  .bracket-match.completed {
    border-color: rgba(128, 128, 128, 0.4);
    background: rgba(128, 128, 128, 0.1);
  }

  .match-players {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .match-player {
    color: #ffffff;
    font-weight: bold;
    font-size: 14px;
  }

  .match-player.winner {
    color: #00FF00;
  }

  .match-vs {
    color: #FFD700;
    font-weight: bold;
  }

  .match-status {
    text-align: center;
    color: #cccccc;
    font-size: 12px;
  }

  /* Tournament Controls */
  .tournament-controls {
    display: flex;
    gap: 15px;
    justify-content: flex-start;
    flex-wrap: wrap;
  }

  .tournament-btn {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 140px;
  }

  .tournament-btn.join {
    background: linear-gradient(135deg, #00FF00, #00CC00);
    color: #000000;
  }

  .tournament-btn.join:hover {
    background: linear-gradient(135deg, #00CC00, #00AA00);
    transform: translateY(-2px);
  }

  .tournament-btn.leave {
    background: linear-gradient(135deg, #FF4444, #CC3333);
    color: #ffffff;
  }

  .tournament-btn.leave:hover {
    background: linear-gradient(135deg, #CC3333, #AA2222);
    transform: translateY(-2px);
  }

  .tournament-btn.ready {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000000;
  }

  .tournament-btn.ready:hover {
    background: linear-gradient(135deg, #FFA500, #FF8C00);
    transform: translateY(-2px);
  }

  .tournament-btn.back {
    background: linear-gradient(135deg, #666666, #444444);
    color: #ffffff;
  }

  .tournament-btn.back:hover {
    background: linear-gradient(135deg, #555555, #333333);
    transform: translateY(-2px);
  }

  /* Tournament Ready Check */
  .tournament-ready-check {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    z-index: 10000;
  }

  .ready-check-content {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 20, 0.95));
    border-radius: 20px;
    padding: 40px;
    border: 3px solid #FFD700;
    backdrop-filter: blur(15px);
    box-shadow: 0 10px 40px rgba(255, 215, 0, 0.3);
    text-align: center;
    max-width: 500px;
    width: 100%;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
  }

  .ready-check-title {
    font-size: 28px;
    font-weight: bold;
    color: #FFD700;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .ready-check-details {
    margin-bottom: 25px;
  }

  .opponent-info {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 15px;
    margin-bottom: 10px;
  }

  .vs-label {
    color: #FFD700;
    font-weight: bold;
    font-size: 20px;
  }

  .opponent-name {
    color: #ffffff;
    font-weight: bold;
    font-size: 20px;
  }

  .match-info {
    color: #cccccc;
    font-size: 14px;
  }

  .ready-check-timer {
    margin-bottom: 25px;
  }

  .timer-circle {
    width: 100px;
    height: 100px;
    border: 4px solid #FFD700;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    margin: 0 auto 10px;
    background: rgba(255, 215, 0, 0.1);
  }

  .timer-circle span {
    color: #FFD700;
    font-weight: bold;
    font-size: 18px;
  }

  .timer-label {
    color: #cccccc;
    font-size: 14px;
  }

  .ready-check-controls {
    display: flex;
    gap: 20px;
    justify-content: flex-start;
    margin-bottom: 25px;
  }

  .ready-btn {
    padding: 15px 30px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 140px;
  }

  .ready-btn.confirm {
    background: linear-gradient(135deg, #00FF00, #00CC00);
    color: #000000;
  }

  .ready-btn.confirm:hover {
    background: linear-gradient(135deg, #00CC00, #00AA00);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 255, 0, 0.4);
  }

  .ready-btn.cancel {
    background: linear-gradient(135deg, #FF4444, #CC3333);
    color: #ffffff;
  }

  .ready-btn.cancel:hover {
    background: linear-gradient(135deg, #CC3333, #AA2222);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
  }

  .ready-status {
    display: flex;
    justify-content: space-around;
    gap: 20px;
  }

  .player-ready-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
  }

  .status-label {
    color: #cccccc;
    font-size: 14px;
    font-weight: bold;
  }

  .status-indicator {
    font-size: 16px;
    font-weight: bold;
  }

  /* Responsive Tournament UI */
  @media (max-width: 768px) {
    .tournament-options {
      grid-template-columns: 1fr;
    }

    .tournament-content {
      grid-template-columns: 1fr;
    }

    .players-grid {
      grid-template-columns: 1fr;
    }

    .ready-check-controls {
      flex-direction: column;
      align-items: center;
    }

    .ready-status {
      flex-direction: column;
      gap: 10px;
    }
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  /* ===== ENHANCED PLAYER STATUS HUD STYLES ===== */
  .player-status-hud {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    border-radius: 15px;
    padding: 20px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    min-width: 280px;
    z-index: 1000;
    transition: all 0.3s ease;
  }

  .role-indicator {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .role-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    font-size: 20px;
    color: white;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }

  .role-icon.goalkeeper {
    background: linear-gradient(135deg, #FF9800, #F57C00);
    box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
  }

  .role-icon.defender {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
  }

  .role-icon.midfielder {
    background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
  }

  .role-icon.striker {
    background: linear-gradient(135deg, #F44336, #D32F2F);
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
  }

  .role-info {
    flex: 1;
  }

  .role-name {
    font-size: 16px;
    font-weight: bold;
    color: #ffffff;
    margin-bottom: 2px;
  }

  .role-description {
    font-size: 12px;
    color: #cccccc;
    opacity: 0.9;
  }

  .stamina-container {
    margin-bottom: 15px;
  }

  .stamina-label {
    font-size: 12px;
    color: #cccccc;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .stamina-bar {
    width: 100%;
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .stamina-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease, background 0.3s ease;
    border-radius: 5px;
    width: 100%;
  }

  .stamina-fill.low {
    background: linear-gradient(90deg, #FF5722, #FF9800);
  }

  .stamina-fill.critical {
    background: linear-gradient(90deg, #F44336, #FF5722);
    animation: pulse 1s infinite;
  }

  .stamina-percentage {
    font-size: 11px;
    color: #ffffff;
    text-align: right;
    margin-top: 3px;
    font-weight: bold;
  }

  .ball-possession-indicator {
    background: linear-gradient(135deg, #FFD700, #FFA000);
    border-radius: 8px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 2px solid #FFEB3B;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    animation: possession-pulse 1.5s infinite;
  }

  @keyframes possession-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.9; }
  }

  .possession-icon {
    font-size: 16px;
  }

  .possession-text {
    font-size: 12px;
    font-weight: bold;
    color: #000000;
  }

  /* ===== ACTION FEEDBACK SYSTEM ===== */
  .action-feedback-container {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    z-index: 2000;
    pointer-events: none;
    max-width: 300px;
  }

  .action-feedback {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 10px;
    border-left: 4px solid;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .action-feedback.show {
    transform: translateX(0);
    opacity: 1;
  }

  .action-feedback.success {
    border-left-color: #4CAF50;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
  }

  .action-feedback.info {
    border-left-color: #2196F3;
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.1));
  }

  .action-feedback.warning {
    border-left-color: #FF9800;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 152, 0, 0.1));
  }

  .action-feedback.error {
    border-left-color: #F44336;
    background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(244, 67, 54, 0.1));
  }

  .feedback-icon {
    font-size: 18px;
    flex-shrink: 0;
  }

  .feedback-content {
    flex: 1;
  }

  .feedback-title {
    font-size: 14px;
    font-weight: bold;
    color: #ffffff;
    margin-bottom: 2px;
  }

  .feedback-message {
    font-size: 12px;
    color: #cccccc;
    line-height: 1.3;
  }



  /* ===== TEAM FORMATION DISPLAY ===== */
  .team-formation-display {
    position: fixed;
    top: 50%;
    left: 20px;
    transform: translateY(-50%);
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    border-radius: 15px;
    padding: 20px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    min-width: 200px;
    z-index: 999;
    transition: all 0.3s ease;
  }

  .formation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .formation-title {
    font-size: 14px;
    font-weight: bold;
    color: #ffffff;
    text-transform: uppercase;
  }

  .formation-toggle {
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.3s ease;
  }

  .formation-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .formation-field {
    position: relative;
    width: 160px;
    height: 240px;
    background: linear-gradient(135deg, #2E7D32, #388E3C);
    border-radius: 8px;
    border: 2px solid #4CAF50;
    display: grid;
    grid-template-areas: 
      "gk gk"
      "lb rb"
      "cm1 cm2"
      "st st";
    grid-template-rows: 1fr 1fr 1fr 1fr;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 12px;
  }

  .field-player {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    font-size: 11px;
    font-weight: bold;
    color: #000000;
    width: 35px;
    height: 35px;
    margin: auto;
    border: 2px solid #ffffff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .field-player:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .field-player.active {
    background: #FFD700;
    border-color: #FFA000;
    animation: player-highlight 2s infinite;
  }

  @keyframes player-highlight {
    0%, 100% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
    50% { box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6); }
  }

  #player-gk { grid-area: gk; }
  #player-lb { grid-area: lb; }
  #player-rb { grid-area: rb; }
  #player-cm1 { grid-area: cm1; }
  #player-cm2 { grid-area: cm2; }
  #player-st { grid-area: st; }

  /* ===== MOBILE RESPONSIVENESS FOR NEW ELEMENTS ===== */
  @media (max-width: 768px) {
    .player-status-hud {
      bottom: 10px;
      left: 10px;
      min-width: 240px;
      padding: 15px;
    }



    .team-formation-display {
      left: 10px;
      min-width: 180px;
      padding: 15px;
    }

    .formation-field {
      width: 140px;
      height: 200px;
    }

    .field-player {
      width: 30px;
      height: 30px;
      font-size: 10px;
    }

    .action-feedback-container {
      right: 10px;
      max-width: 250px;
    }
  }

  @media (max-width: 480px) {
    .player-status-hud {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 15px 15px 0 0;
      min-width: auto;
    }



    .team-formation-display {
      display: none; /* Hide on very small screens */
    }
  }

  /* ===== STOPPAGE TIME NOTIFICATION SYSTEM ===== */
  .stoppage-time-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #FFD700, #FFA500, #FF8C00);
    color: #000000;
    padding: 25px 40px;
    border-radius: 15px;
    border: 3px solid #FFD700;
    box-shadow: 0 8px 32px rgba(255, 215, 0, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.3);
    z-index: 10000;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    animation: stoppageTimeSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    backdrop-filter: blur(5px);
  }

  .stoppage-time-notification.hide {
    animation: stoppageTimeSlideOut 0.5s ease-in-out forwards;
  }

  .stoppage-time-icon {
    font-size: 28px;
    margin-bottom: 10px;
    animation: stoppageTimePulse 1.5s ease-in-out infinite;
  }

  .stoppage-time-message {
    font-size: 16px;
    margin-top: 10px;
    opacity: 0.9;
  }

  /* Pulsing animation for phase indicator during stoppage time */
  .phase-indicator.stoppage-time {
    animation: stoppageTimePhasePulse 2s ease-in-out infinite;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000000;
    border: 2px solid #FFD700;
  }

  @keyframes stoppageTimeSlideIn {
    0% {
      transform: translate(-50%, -50%) scale(0.3);
      opacity: 0;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.1);
    }
    100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
  }

  @keyframes stoppageTimeSlideOut {
    0% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
    }
  }

  @keyframes stoppageTimePulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
  }

  @keyframes stoppageTimePhasePulse {
    0%, 100% {
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
      transform: scale(1);
    }
    50% {
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.9);
      transform: scale(1.05);
    }
  }

  /* Spectator Mode Animations */
  @keyframes slideInLeft {
    0% {
      opacity: 0;
      transform: translateX(-100%);
    }
    100% {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes slideOutLeft {
    0% {
      opacity: 1;
      transform: translateX(0);
    }
    100% {
      opacity: 0;
      transform: translateX(-100%);
    }
  }

  @keyframes slideOutDown {
    0% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(100%);
    }
  }

  /* ===== PHASE 1 MOBILE CONTROLS (ZERO DESKTOP IMPACT) ===== */
  
  /* Mobile Device Detection & Base Mobile Styles */
  .mobile-controls {
    display: none; /* Hidden by default - only shown on mobile */
    position: fixed;
    z-index: 9999;
    pointer-events: auto;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
  }

  /* Force mobile controls to show when mobile is detected by JavaScript */
  .mobile-controls.mobile-active {
    display: block !important;
  }
  
  /* Virtual Joystick for Movement */
  .virtual-joystick {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 120px;
    height: 120px;
    background: rgba(0, 0, 0, 0.3);
    border: 3px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .joystick-knob {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    position: relative;
    transition: all 0.1s ease;
  }
  
  /* Action Buttons */
  .mobile-actions {
    position: fixed;
    bottom: 30px;
    right: 30px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .mobile-action-btn {
    width: 60px;
    height: 60px;
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    color: white;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
  }
  
  .mobile-action-btn:active {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(0.95);
  }
  
  .mobile-action-btn.primary {
    background: rgba(0, 123, 255, 0.8);
    border-color: rgba(0, 123, 255, 1);
  }
  
  .mobile-action-btn.secondary {
    background: rgba(40, 167, 69, 0.8);
    border-color: rgba(40, 167, 69, 1);
  }
  
  /* Mobile Performance Indicator */
  .mobile-performance-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-family: 'Inter', sans-serif;
  }
  
  /* Improved mobile detection - more reliable than pointer: coarse */
  @media (max-width: 768px) {
    .mobile-controls {
      display: block;
    }
    
    /* Hide desktop-only elements on mobile */
    .desktop-only {
      display: none !important;
    }
    
    /* Optimize UI spacing for mobile */
    .team-selection {
      padding: 10px;
    }
    
    .team-selection h2 {
      font-size: 18px;
    }
    
    .team-btn {
      min-height: 50px;
      font-size: 16px;
    }
    
    /* Optimize scoreboard for mobile */
    .scoreboard {
      font-size: 16px;
      padding: 8px 12px;
    }
    
    .score-display {
      font-size: 20px;
    }
  }
  
  /* Additional mobile-specific optimizations */
  @media (max-width: 480px) {
    .virtual-joystick {
      width: 100px;
      height: 100px;
      bottom: 20px;
      left: 20px;
    }
    
    .joystick-knob {
      width: 35px;
      height: 35px;
    }
    
    .mobile-actions {
      bottom: 20px;
      right: 20px;
    }
    
    .mobile-action-btn {
      width: 50px;
      height: 50px;
      font-size: 9px;
    }
  }

  /* ===== PHASE 2 ENHANCED MOBILE UI (HYTOPIA SDK COMPLIANT) ===== */
  
  /* Enhanced Mobile Scoreboard - Larger and More Prominent */
  .enhanced-mobile-scoreboard {
    display: none; /* Hidden by default - only shown on mobile */
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    padding: 20px 30px;
    z-index: 9998;
    font-family: 'Arial Black', Arial, sans-serif;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    min-width: 280px;
    text-align: center;
  }
  
  .mobile-team-score {
    display: inline-block;
    margin: 0 15px;
    text-align: center;
  }
  
  .mobile-team-name {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 5px;
    text-transform: uppercase;
  }
  
  .mobile-team-red { color: #FF4444; }
  .mobile-team-blue { color: #4488FF; }
  
  .mobile-score-number {
    font-size: 32px;
    font-weight: 900;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }
  
  .mobile-game-time {
    margin-top: 15px;
    font-size: 14px;
    color: #CCCCCC;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 10px;
  }
  
  /* Simplified Mobile Menu System */
  .mobile-game-menu {
    display: none; /* Hidden by default */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border-radius: 20px;
    padding: 30px;
    z-index: 10001;
    min-width: 300px;
    text-align: center;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }
  
  .mobile-menu-title {
    font-size: 24px;
    font-weight: bold;
    color: white;
    margin-bottom: 25px;
    text-transform: uppercase;
  }
  
  .mobile-menu-button {
    display: block;
    width: 100%;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 15px 20px;
    margin: 10px 0;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .mobile-menu-button:hover {
    background: linear-gradient(135deg, #45a049, #4CAF50);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
  }
  
  .mobile-menu-button.danger {
    background: linear-gradient(135deg, #f44336, #da190b);
  }
  
  .mobile-menu-button.danger:hover {
    background: linear-gradient(135deg, #da190b, #f44336);
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
  }
  
  /* Enhanced Mobile Team Selection */
  .mobile-team-selection {
    display: none; /* Hidden by default */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border-radius: 20px;
    padding: 30px;
    z-index: 10001;
    min-width: 320px;
    text-align: center;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }
  
  .mobile-team-button {
    display: block;
    width: 100%;
    padding: 20px;
    margin: 15px 0;
    border: 3px solid;
    border-radius: 15px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
  }
  
  .mobile-team-red-btn {
    background: linear-gradient(135deg, rgba(255, 68, 68, 0.8), rgba(244, 67, 54, 0.8));
    border-color: #FF4444;
    color: white;
  }
  
  .mobile-team-blue-btn {
    background: linear-gradient(135deg, rgba(68, 136, 255, 0.8), rgba(33, 150, 243, 0.8));
    border-color: #4488FF;
    color: white;
  }
  
  .mobile-team-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  }
  
  /* Mobile Game Status Overlay */
  .mobile-game-status {
    display: none; /* Hidden by default */
    position: fixed;
    bottom: 120px; /* Above mobile controls */
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 25px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: bold;
    z-index: 9999;
    border: 2px solid rgba(255, 255, 255, 0.3);
    min-width: 200px;
    text-align: center;
  }
  
  /* Enhanced Mobile Controls Layout - Override Phase 1 */
  @media (max-width: 768px) {
    .enhanced-mobile-scoreboard,
    .mobile-game-status {
      display: block !important;
    }
    
    /* Hide original scoreboard on mobile for Phase 2 */
    .scoreboard {
      display: none !important;
    }
    
    /* Enhanced Virtual Joystick for Phase 2 */
    .virtual-joystick {
      width: 140px !important;
      height: 140px !important;
      bottom: 40px !important;
      left: 40px !important;
      background: radial-gradient(circle, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2)) !important;
      border: 4px solid rgba(255, 255, 255, 0.5) !important;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
    }
    
    .joystick-knob {
      width: 50px !important;
      height: 50px !important;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(200, 200, 200, 0.8)) !important;
      border: 2px solid rgba(0, 0, 0, 0.3) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4) !important;
    }
    
    /* Enhanced Action Buttons for Phase 2 */
    .mobile-actions {
      bottom: 40px !important;
      right: 40px !important;
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      grid-gap: 15px !important;
      flex-direction: unset !important;
    }
    
    .mobile-action-btn {
      width: 70px !important;
      height: 70px !important;
      font-size: 12px !important;
      border: 3px solid rgba(255, 255, 255, 0.6) !important;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
    }
    
    .mobile-action-btn.primary {
      background: linear-gradient(135deg, #FF6B6B, #EE5A52) !important;
      color: white !important;
    }
    
    .mobile-action-btn.secondary {
      background: linear-gradient(135deg, #4ECDC4, #44A08D) !important;
      color: white !important;
    }
  }
  
  @media (max-width: 480px) {
    /* Extra small screens - even larger touch targets */
    .mobile-action-btn {
      width: 75px !important;
      height: 75px !important;
      font-size: 11px !important;
    }
    
    .virtual-joystick {
      width: 150px !important;
      height: 150px !important;
    }
    
    .joystick-knob {
      width: 55px !important;
      height: 55px !important;
    }
    
    .enhanced-mobile-scoreboard {
      min-width: 250px;
      padding: 15px 20px;
    }
    
    .mobile-score-number {
      font-size: 28px;
    }
  }
</style>

<div class="instructions-panel" id="instructionsPanel">
  <div class="title-container">
    <img src="{{CDN_ASSETS_URL}}/ui/logos/Gnarly-nutmeg.png" alt="Gnarly Nutmeg Soccer Logo" class="title-logo">
  </div>
  
  <div class="how-to-play-container">
    <button class="how-to-play-btn">
      How to Play
      <div class="how-to-play-tooltip">
        <p>⚽ Use WASD or Arrow keys to move</p>
        <p>⚽ Left Click to pass</p>
        <p>⚽ Type /pass in chat to force a pass when you have the ball</p>
        <p>⚽ Press F to request pass from teammate</p>
        <p>⚽ Hold Right Mouse Button to charge a shot / Release to shoot</p>
        <p>⚽ Space bar to tackle or dodge</p>
        <p>⚽ Highest score when time expires wins!</p>
        <p>⚽ Select your game mode and team to get started!</p>
      </div>
    </button>
  </div>

  <!-- Game Mode Selection -->
  <div class="game-mode-selection" id="gameModeSelection">
    <div class="game-mode-title">Choose Game Mode</div>
    <div class="game-mode-buttons">
      <button class="game-mode-btn fifa" id="fifaModeBtn">
        🏆 FIFA Mode
        <div class="mode-description">Realistic Soccer Simulation</div>
        <div class="mode-features">• Pure soccer gameplay • 2 x 5-minute halves • No power-ups</div>
      </button>
      <button class="game-mode-btn arcade" id="arcadeModeBtn">
        🎪 Arcade Mode
        <div class="mode-description">Enhanced Soccer Action</div>
        <div class="mode-features">• Unlimited number-key power-ups • 2 x 5-minute halves • Special effects</div>
      </button>
      <button class="game-mode-btn tournament" id="tournamentModeBtn">
        🏆 Tournament Mode
        <div class="mode-description">Competitive Bracket Soccer</div>
        <div class="mode-features">• Competitive brackets • Player coordination • Match scheduling</div>
      </button>
      <!-- PICKUP MODE - TEMPORARILY DISABLED (READY FOR FUTURE UPGRADE)
      <button class="game-mode-btn pickup" id="pickupModeBtn">
        🎯 Pickup Mode
        <div class="mode-description">Collectible Ability Soccer</div>
        <div class="mode-features">• Physical pickups to collect • F-key uses collected ability • 2 x 5-minute halves</div>
      </button>
      -->
    </div>
    
    <div class="selected-mode-info" id="selectedModeInfo" style="display: none;">
      <h3 id="modeInfoTitle">Select a Game Mode</h3>
      <p id="modeInfoDescription"></p>
      <div class="features-list" id="modeInfoFeatures"></div>
    </div>
  </div>
  
  <!-- Player Count Selection (new section) -->
  <div class="player-count-selection" id="playerCountSelection" style="display: none;">
    <div class="player-count-title">Choose Player Count</div>
    <div class="player-count-buttons">
      <button class="game-mode-btn single-player" id="singlePlayerBtn">
        👤 Single Player
        <div class="mode-description">Play Against AI</div>
        <div class="mode-features">• You + 5 AI vs 6 AI • Immediate game start</div>
      </button>
      <button class="game-mode-btn multiplayer" id="multiplayerBtn">
        👥 Multiplayer
        <div class="mode-description">1v1 Human Match</div>
        <div class="mode-features">• Human vs Human • Each player on different teams • 4 AI teammates each</div>
      </button>
    </div>
    
    <div class="multiplayer-lobby" id="multiplayerLobby" style="display: none;">
      <div class="lobby-message">Waiting for second player to join...</div>
      <div class="player-count-display">
        <span class="current-players">1</span> / <span class="required-players">2</span> players
      </div>
    </div>
  </div>
  
  <!-- Tournament Mode Selection and Lobby -->
  <div class="tournament-selection" id="tournamentSelection" style="display: none;">
    <div class="tournament-header">
      <div class="tournament-title">🏆 Tournament Mode</div>
      <div class="tournament-subtitle">Competitive Bracket Soccer</div>
    </div>
    
    <!-- Tournament Creation/Join Options -->
    <div class="tournament-options" id="tournamentOptions">
      <div class="tournament-section">
        <h3>Join Existing Tournament</h3>
        <div class="active-tournaments" id="activeTournaments">
          <div class="no-tournaments">No active tournaments available</div>
        </div>
      </div>
      
      <div class="tournament-section">
        <h3>Create New Tournament</h3>
        <div class="tournament-create-form">
          <div class="form-group">
            <label>Tournament Name:</label>
            <input type="text" id="tournamentName" placeholder="Enter tournament name" maxlength="30">
          </div>
          
          <div class="form-group">
            <label>Tournament Type:</label>
            <select id="tournamentType">
              <option value="single-elimination">Single Elimination</option>
              <option value="double-elimination">Double Elimination</option>
              <option value="round-robin">Round Robin</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Max Players:</label>
            <select id="tournamentMaxPlayers">
              <option value="4">4 Players</option>
              <option value="8" selected>8 Players</option>
              <option value="16">16 Players</option>
              <option value="32">32 Players</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Game Mode:</label>
            <select id="tournamentGameMode">
              <option value="fifa" selected>FIFA Mode</option>
              <option value="arcade">Arcade Mode</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Registration Time:</label>
            <select id="tournamentRegistrationTime">
              <option value="5">5 Minutes</option>
              <option value="10" selected>10 Minutes</option>
              <option value="15">15 Minutes</option>
              <option value="30">30 Minutes</option>
            </select>
          </div>
          
          <button class="tournament-create-btn" id="createTournamentBtn">
            🏆 Create Tournament
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tournament Lobby (shown when in a tournament) -->
    <div class="tournament-lobby" id="tournamentLobby" style="display: none;">
      <div class="tournament-info">
        <div class="tournament-name" id="tournamentLobbyName">Tournament Name</div>
        <div class="tournament-details" id="tournamentLobbyDetails">8 Players • Single Elimination • FIFA Mode</div>
        <div class="tournament-status" id="tournamentLobbyStatus">Registration Open</div>
      </div>
      
      <div class="tournament-content">
        <!-- Tournament Players List -->
        <div class="tournament-players">
          <h3>Registered Players (<span id="playerCount">0</span>/<span id="maxPlayers">8</span>)</h3>
          <div class="players-grid" id="tournamentPlayersGrid">
            <!-- Players will be populated here -->
          </div>
        </div>
        
        <!-- Tournament Bracket -->
        <div class="tournament-bracket" id="tournamentBracket" style="display: none;">
          <h3>Tournament Bracket</h3>
          <div class="bracket-container" id="bracketContainer">
            <!-- Bracket will be populated here -->
          </div>
        </div>
        
        <!-- Tournament Controls -->
        <div class="tournament-controls">
          <button class="tournament-btn join" id="joinTournamentBtn">
            ✅ Join Tournament
          </button>
          <button class="tournament-btn leave" id="leaveTournamentBtn" style="display: none;">
            ❌ Leave Tournament
          </button>
          <button class="tournament-btn ready" id="readyCheckBtn" style="display: none;">
            🔔 Ready for Match
          </button>
          <button class="tournament-btn back" id="backToLobbyBtn">
            🏠 Back to Lobby
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tournament Match Ready Check -->
    <div class="tournament-ready-check" id="tournamentReadyCheck" style="display: none;">
      <div class="ready-check-content">
        <div class="ready-check-title">🔔 Match Ready Check</div>
        <div class="ready-check-details">
          <div class="opponent-info">
            <span class="vs-label">VS</span>
            <span class="opponent-name" id="readyCheckOpponent">Opponent</span>
          </div>
          <div class="match-info" id="readyCheckMatchInfo">Round 1 • FIFA Mode</div>
        </div>
        
        <div class="ready-check-timer">
          <div class="timer-circle">
            <span id="readyCheckTimer">5:00</span>
          </div>
          <div class="timer-label">Time to ready up</div>
        </div>
        
        <div class="ready-check-controls">
          <button class="ready-btn confirm" id="confirmReadyBtn">
            ✅ I'm Ready
          </button>
          <button class="ready-btn cancel" id="cancelReadyBtn">
            ❌ Not Ready
          </button>
        </div>
        
        <div class="ready-status">
          <div class="player-ready-status">
            <span class="status-label">You:</span>
            <span class="status-indicator" id="yourReadyStatus">❓ Waiting</span>
          </div>
          <div class="player-ready-status">
            <span class="status-label">Opponent:</span>
            <span class="status-indicator" id="opponentReadyStatus">❓ Waiting</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="game-over-content" style="display: none;">
    <div class="game-over-header">
      <div class="game-over-message" id="game-over-title">Match Complete</div>
      <div class="final-score">
        <span class="red-score" id="final-red-score">0</span>
        -
        <span class="blue-score" id="final-blue-score">0</span>
      </div>
      <div id="winner-announcement" style="color: #FFD700; text-align: center; margin: 10px 0; font-size: 18px; font-weight: bold;"></div>
      <div id="match-info" style="color: #ccc; text-align: center; margin-bottom: 20px; font-size: 14px;"></div>
    </div>

    <!-- Team Statistics -->
    <div class="team-stats-container">
      <div class="team-stats-header">Team Statistics</div>
      <div class="team-stats-grid">
        <div class="team-stat-column red-team">
          <div class="team-name">Red Team</div>
          <div class="stat-row">
            <span class="stat-label">Goals:</span>
            <span class="stat-value" id="red-team-goals">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Shots:</span>
            <span class="stat-value" id="red-team-shots">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Passes:</span>
            <span class="stat-value" id="red-team-passes">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Tackles:</span>
            <span class="stat-value" id="red-team-tackles">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Saves:</span>
            <span class="stat-value" id="red-team-saves">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Distance:</span>
            <span class="stat-value" id="red-team-distance">0m</span>
          </div>
        </div>
        
        <div class="team-stat-column blue-team">
          <div class="team-name">Blue Team</div>
          <div class="stat-row">
            <span class="stat-label">Goals:</span>
            <span class="stat-value" id="blue-team-goals">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Shots:</span>
            <span class="stat-value" id="blue-team-shots">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Passes:</span>
            <span class="stat-value" id="blue-team-passes">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Tackles:</span>
            <span class="stat-value" id="blue-team-tackles">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Saves:</span>
            <span class="stat-value" id="blue-team-saves">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Distance:</span>
            <span class="stat-value" id="blue-team-distance">0m</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Player Statistics -->
    <div class="player-stats-container">
      <div class="player-stats-header">Player Statistics</div>
      <div class="player-stats-tabs">
        <button class="tab-button active" onclick="showPlayerTab('red')">Red Team</button>
        <button class="tab-button" onclick="showPlayerTab('blue')">Blue Team</button>
      </div>
      <div id="red-players-stats" class="player-stats-content">
        <!-- Red team player stats will be populated here -->
      </div>
      <div id="blue-players-stats" class="player-stats-content" style="display: none;">
        <!-- Blue team player stats will be populated here -->
      </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <div style="display: flex; gap: 15px; justify-content: flex-start; align-items: center;">
        <button onclick="viewStatsToggle()" style="
          background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        border: none;
        padding: 12px 24px;
          border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        font-weight: bold;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(99, 102, 241, 0.4)'"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)'">
          📊 View Full Stats
        </button>
        <button onclick="returnToLobby()" style="
          background: linear-gradient(135deg, #10b981, #059669);
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 8px;
          font-size: 18px;
          cursor: pointer;
          font-weight: bold;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
          🏠 Back to Lobby
        </button>
      </div>
      <div style="margin-top: 15px; color: #888; font-size: 14px;">
        Game completed! Ready to start a new match?
      </div>
    </div>
  </div>

  <!-- Team Selection Section -->
  <div class="team-selection" id="teamSelection" style="display: none;">
    <div class="team-selection-title">Choose Your Team</div>
    <div class="team-buttons-container">
      <div class="team-column">
        <button id="redTeamBtn" class="team-btn red">
          🔴 Join Red Team
        </button>
        <div class="player-count" id="red-team-count">Players: 0/6</div>
      </div>
      <div class="team-column">
        <button id="blueTeamBtn" class="team-btn blue">
          🔵 Join Blue Team
        </button>
        <div class="player-count" id="blue-team-count">Players: 0/6</div>
      </div>
    </div>
    

  </div>
</div>

<!-- Power Bar Template -->
<template id="power-bar-template">
  <div style="
    width: 92px;
    height: 8px;
    background: rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
  ">
    <div style="
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, 
        #27ae60 0%, 
        #27ae60 85%, 
        #f39c12 92%,
        #e74c3c 96%
      );
      background-size: 400% 100%;
      background-position: left;
      transition: width 0.05s linear;
    "></div>
  </div>
</template>

<!-- Phase 1: Enhanced Scripts with Modern Features -->
<script>
  // ===== GPU MEMORY MANAGEMENT =====
  // Client-side GPU memory management and WebGL context recovery
  function setupGPUMemoryManagement() {
    // Monitor WebGL context loss
    const checkCanvas = () => {
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.addEventListener('webglcontextlost', (event) => {
          event.preventDefault();
          console.error("🚨 WebGL context lost - GPU memory exhausted!");
          console.log("💡 To recover: Refresh the page or restart the browser");
          
          // Show user-friendly error message
          const errorMessage = document.createElement('div');
          errorMessage.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 68, 68, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-size: 18px;
            font-weight: bold;
            z-index: 10000;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
          `;
          errorMessage.innerHTML = `
            🚨 GPU Memory Exhausted<br>
            <span style="font-size: 14px; font-weight: normal;">
              Please refresh the page or restart your browser
            </span>
          `;
          document.body.appendChild(errorMessage);
          
          // Auto-refresh after 5 seconds
          setTimeout(() => {
            window.location.reload();
          }, 5000);
        });
        
        canvas.addEventListener('webglcontextrestored', () => {
          console.log("✅ WebGL context restored");
        });
        
        console.log("🛡️ Client-side GPU memory monitoring enabled");
      } else {
        // If canvas not found, try again after a delay
        setTimeout(checkCanvas, 1000);
      }
    };
    
    checkCanvas();
  }
  
  // Start GPU memory management when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupGPUMemoryManagement);
  } else {
    setupGPUMemoryManagement();
  }
  
  // ===== SCENE UI REGISTRATIONS =====
  // Register the power-bar SceneUI template to prevent "template power-bar not registered" errors
  hytopia.registerSceneUITemplate('power-bar', (id, onState) => {
    const powerBarTemplate = document.getElementById('power-bar-template');
    const powerBarClone = powerBarTemplate.content.cloneNode(true);
    const powerBarElement = powerBarClone.querySelector('div');
    const powerBarFill = powerBarElement.querySelector('div');
    
    // Update power bar fill based on state
    onState(state => {
      if (state && typeof state.percentage === 'number') {
        powerBarFill.style.width = `${Math.max(0, Math.min(100, state.percentage))}%`;
      }
    });
    
    return powerBarClone;
  });

  // ===== PHASE 1: MODERN HUD VARIABLES =====
  let powerBarInterval = null;
  let powerBarPercentage = 0;
  let timeUntilStart = 0;
  let timeUntilStartInterval = null;
  let selectedGameMode = null; // Will be set to 'fifa' or 'arcade'
  
  // New Phase 1 variables
  let currentGameStats = {
    red: { goals: 0, shots: 0, passes: 0, possession: 50 },
    blue: { goals: 0, shots: 0, passes: 0, possession: 50 }
  };
  let playerStats = {};
  let matchPhase = "waiting";
  let audioEnabled = true;

  // ===== LOADING PROGRESS SYSTEM =====
  function showLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.add('visible');
    }
  }

  function hideLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.classList.remove('visible');
    }
  }

  function updateLoadingProgress(current, total, message, percentage) {
    const messageEl = document.getElementById('loading-message');
    const progressFill = document.getElementById('loading-progress-fill');
    const percentageEl = document.getElementById('loading-percentage');
    
    if (messageEl) messageEl.textContent = message || 'Loading...';
    if (progressFill) progressFill.style.width = `${percentage || 0}%`;
    if (percentageEl) percentageEl.textContent = `${percentage || 0}%`;
  }

  function showLoadingError(message) {
    const messageEl = document.getElementById('loading-message');
    const progressFill = document.getElementById('loading-progress-fill');
    
    if (messageEl) {
      messageEl.textContent = message || 'Loading failed. Please refresh and try again.';
      messageEl.style.color = '#ff4444';
    }
    if (progressFill) {
      progressFill.style.background = 'linear-gradient(90deg, #ff4444, #cc3333)';
    }
    
    // Hide loading overlay after showing error briefly
    setTimeout(() => {
      hideLoadingOverlay();
    }, 3000);
  }

  // ===== AUDIO SYSTEM =====
  function playUISound(soundType) {
    if (!audioEnabled) return;
    
    hytopia.sendData({
      type: "play-ui-sound",
      sound: soundType
    });
  }

  function playGoalCelebration(team) {
    if (!audioEnabled) return;
    
    hytopia.sendData({
      type: "play-goal-celebration",
      team: team
    });
  }

  // ===== GAME MODE SELECTION FUNCTIONS =====
  function selectGameMode(mode, event) {
    // Prevent any default behavior that might trigger cursor mode change
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    console.log(`Game mode selected: ${mode}`); // Debug log
    selectedGameMode = mode;
    
    // Play UI sound without sending to server immediately
    if (audioEnabled) {
      console.log("Playing UI sound locally"); // Debug log
    }
    
    // Update button states
    document.querySelectorAll('.game-mode-btn').forEach(btn => {
      btn.classList.remove('selected');
    });
    document.querySelector(`.game-mode-btn.${mode}`).classList.add('selected');
    
    // Show mode info
    const infoPanel = document.getElementById('selectedModeInfo');
    const titleEl = document.getElementById('modeInfoTitle');
    const descEl = document.getElementById('modeInfoDescription');
    const featuresEl = document.getElementById('modeInfoFeatures');
    
    if (mode === 'fifa') {
      titleEl.textContent = '🏆 FIFA Mode Selected';
      descEl.textContent = 'Experience realistic soccer simulation with authentic gameplay mechanics and timing.';
      featuresEl.innerHTML = `
        • 2 x 5-minute halves with possible overtime<br>
        • Pure soccer gameplay - no power-ups or special abilities<br>
        • Realistic physics and player movement<br>
        • Focus on skill, strategy, and teamwork<br>
        • Traditional soccer rules and mechanics
      `;
    } else if (mode === 'arcade') {
      titleEl.textContent = '🎪 Arcade Mode Selected';
      descEl.textContent = 'Fast-paced soccer action with enhanced gameplay features and special effects.';
      featuresEl.innerHTML = `
        • 2 x 5-minute halves for rapid gameplay<br>
        • Power-ups and special abilities for enhanced action<br>
        • Enhanced physics with special moves<br>
        • Particle effects and visual enhancements<br>
        • Style points and arcade-style scoring
      `;
    } else if (mode === 'tournament') {
      titleEl.textContent = '🏆 Tournament Mode Selected';
      descEl.textContent = 'Compete in organized tournaments with brackets, rankings, and competitive play.';
      featuresEl.innerHTML = `
        • Tournament bracket system with eliminations<br>
        • Player registration and match scheduling<br>
        • Ready check system for coordinated matches<br>
        • Competitive FIFA-style gameplay (no power-ups)<br>
        • Tournament statistics and leaderboards
      `;
    }
    
    infoPanel.style.display = 'block';
    
    // Update power-up panel visibility based on selected mode
    updatePowerUpPanelVisibility(mode);
    
    // Show/hide arcade power-up UI based on selected mode
    if (mode === "arcade") {
      showArcadeModeUI();
    } else {
      hideArcadeModeUI();
    }
    
    // Delay server communication to avoid immediate cursor mode switch
    setTimeout(() => {
      // Send mode selection to server only when user proceeds
      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        console.log("Sending game mode to server:", mode); // Debug log
        hytopia.sendData({
          type: "select-game-mode",
          mode: mode
        });
      }
    }, 100);
    
    // Show different UI flow based on mode
    if (mode === 'tournament') {
      // Show tournament UI instead of player count selection
      setTimeout(() => {
        const tournamentElement = document.getElementById('tournamentSelection');
        if (tournamentElement) {
          tournamentElement.style.display = 'block';
          
          // Smooth scroll to tournament UI
          tournamentElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
          console.log('✅ Tournament UI displayed successfully');
        } else {
          console.error('❌ Tournament UI element not found!');
        }
      }, 500);
    } else {
      // Show player count selection after a brief delay (normal flow)
      setTimeout(() => {
        document.getElementById('playerCountSelection').style.display = 'block';
        
        // Smooth scroll to player count selection
        document.getElementById('playerCountSelection').scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 500);
    }
  }

  // Make function globally accessible
  window.selectGameMode = selectGameMode;

  // ===== PLAYER COUNT SELECTION FUNCTIONS =====
  let selectedPlayerCount = null;
  let isMultiplayerLobby = false;

  function selectPlayerCount(playerCount, event) {
    // ENHANCED DEBUGGING AND ERROR HANDLING
    console.log(`🎮 selectPlayerCount called with: ${playerCount}`);
    
    // Prevent any default behavior that might trigger cursor mode change
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    // Validate playerCount parameter
    if (!playerCount || (playerCount !== 'single' && playerCount !== 'multiplayer')) {
      console.error('❌ Invalid playerCount parameter:', playerCount);
      return;
    }
    
    // Ensure game mode was selected first
    if (!selectedGameMode) {
      console.error('❌ No game mode selected yet');
      alert('Please select a game mode (FIFA or Arcade) first!');
      return;
    }
    
    console.log(`✅ Player count selected: ${playerCount}`);
    selectedPlayerCount = playerCount;
    
    // Maintain cursor state throughout function
    document.body.style.cursor = 'default';
    document.documentElement.style.cursor = 'default';
    
    playUISound("button-click");
    
    // Update button states with error handling
    const playerCountButtons = document.querySelectorAll('.player-count-buttons .game-mode-btn');
    console.log(`Found ${playerCountButtons.length} player count buttons`);
    
    playerCountButtons.forEach(btn => {
      btn.classList.remove('selected');
      btn.style.cursor = 'pointer'; // Ensure buttons maintain pointer cursor
    });
    
    if (playerCount === 'single') {
      const singleBtn = document.getElementById('singlePlayerBtn');
      if (!singleBtn) {
        console.error('❌ Single player button not found!');
        return;
      }
      
      singleBtn.classList.add('selected');
      singleBtn.style.cursor = 'pointer';
      console.log('✅ Single player button selected');
      
      // Hide multiplayer lobby
      const multiplayerLobby = document.getElementById('multiplayerLobby');
      if (multiplayerLobby) {
        multiplayerLobby.style.display = 'none';
      }
      
      // Show team selection immediately for single player
      setTimeout(() => {
        // Maintain cursor state before DOM operations
        document.body.style.cursor = 'default';
        document.documentElement.style.cursor = 'default';
        
        const teamSelection = document.getElementById('teamSelection');
        if (teamSelection) {
          teamSelection.style.display = 'block';
          console.log('✅ Team selection shown for single player');
          
          // Smooth scroll to team selection
          teamSelection.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        } else {
          console.error('❌ Team selection element not found!');
        }
        
        // Re-apply cursor state after scroll
        setTimeout(() => {
          document.body.style.cursor = 'default';
          document.documentElement.style.cursor = 'default';
        }, 100);
      }, 300);
      
    } else if (playerCount === 'multiplayer') {
      const multiBtn = document.getElementById('multiplayerBtn');
      if (!multiBtn) {
        console.error('❌ Multiplayer button not found!');
        return;
      }
      
      multiBtn.classList.add('selected');
      multiBtn.style.cursor = 'pointer';
      isMultiplayerLobby = true;
      console.log('✅ Multiplayer button selected');
      
      // Show multiplayer lobby
      const multiplayerLobby = document.getElementById('multiplayerLobby');
      if (multiplayerLobby) {
        multiplayerLobby.style.display = 'block';
        console.log('✅ Multiplayer lobby shown');
      } else {
        console.error('❌ Multiplayer lobby element not found!');
      }
      
      // Send to server that we want multiplayer mode
      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        hytopia.sendData({
          type: "join-multiplayer-lobby"
        });
        console.log('✅ Multiplayer lobby message sent to server');
      } else {
        console.warn('⚠️  Hytopia not available, multiplayer lobby simulation only');
      }
      
      // For now, simulate waiting for second player
      // In real implementation, this would be handled by server events
      setTimeout(() => {
        // Maintain cursor state in async operation
        document.body.style.cursor = 'default';
        document.documentElement.style.cursor = 'default';
        
        // Simulate second player joining after 3 seconds for demo
        handleSecondPlayerJoined();
      }, 3000);
    }
    
    // Final cursor state enforcement
    setTimeout(() => {
      document.body.style.cursor = 'default';
      document.documentElement.style.cursor = 'default';
    }, 10);
  }

  function handleSecondPlayerJoined() {
    console.log("🎮 Second player joined multiplayer lobby");
    
    // Update player count display with error handling
    const currentPlayersElement = document.querySelector('.current-players');
    if (currentPlayersElement) {
      currentPlayersElement.textContent = '2';
      console.log('✅ Player count display updated');
    } else {
      console.error('❌ Current players element not found');
    }
    
    // Update lobby message with error handling
    const lobbyMessage = document.querySelector('.lobby-message');
    if (lobbyMessage) {
      lobbyMessage.textContent = 'Match ready! Players will be assigned to different teams.';
      console.log('✅ Lobby message updated');
    } else {
      console.error('❌ Lobby message element not found');
    }
    
    // Hide lobby and show team selection after brief delay
    setTimeout(() => {
      const multiplayerLobby = document.getElementById('multiplayerLobby');
      const teamSelection = document.getElementById('teamSelection');
      
      if (multiplayerLobby) {
        multiplayerLobby.style.display = 'none';
        console.log('✅ Multiplayer lobby hidden');
      } else {
        console.error('❌ Multiplayer lobby element not found');
      }
      
      if (teamSelection) {
        teamSelection.style.display = 'block';
        console.log('✅ Team selection shown for multiplayer');
        
        // Update team selection title for multiplayer
        const teamTitle = document.querySelector('.team-selection-title');
        if (teamTitle) {
          teamTitle.textContent = 'Teams Auto-Assigned - Choose Your Team Color';
          console.log('✅ Team selection title updated for multiplayer');
        } else {
          console.error('❌ Team selection title element not found');
        }
        
        // Smooth scroll to team selection
        teamSelection.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      } else {
        console.error('❌ Team selection element not found');
      }
    }, 2000);
  }

  // Make functions globally accessible
  window.selectPlayerCount = selectPlayerCount;
  window.handleSecondPlayerJoined = handleSecondPlayerJoined;

  // ===== SIMPLIFIED BUTTON CLICK HANDLER (HYTOPIA-COMPLIANT) =====
  function handleButtonClick(event, callback) {
    // Simple event handling without fighting the Hytopia framework
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    // Execute the callback
    if (typeof callback === 'function') {
      try {
        callback();
      } catch (error) {
        console.warn('Error in button callback:', error);
      }
    }
  }

  // ===== ENHANCED SCORE ANIMATIONS =====
  function animateScoreChange(team, newScore) {
    const scoreElement = document.getElementById(`${team}-score`);
    const banner = document.getElementById(`${team}-banner`);
    
    playUISound("score-change");
    
    // Ensure score is visible first
    scoreElement.textContent = newScore;
    
    // Then animate
    scoreElement.style.transform = "scale(1.5)";
    scoreElement.style.color = "#FFD700";
    banner.style.boxShadow = `0 0 20px ${team === 'red' ? '#ff4444' : '#4444ff'}`;
    
    setTimeout(() => {
      scoreElement.style.transform = "scale(1)";
      scoreElement.style.color = "#ffffff";
      banner.style.boxShadow = "none";
    }, 300);
  }

  // ===== STATISTICS PANEL =====
  function updateStatisticsPanel() {
    const statsPanel = document.getElementById("stats-panel");
    if (!statsPanel) return;

    const redStats = currentGameStats.red;
    const blueStats = currentGameStats.blue;

    document.getElementById("red-shots").textContent = redStats.shots;
    document.getElementById("blue-shots").textContent = blueStats.shots;
    document.getElementById("red-passes").textContent = redStats.passes;
    document.getElementById("blue-passes").textContent = blueStats.passes;
    
    const possessionBar = document.getElementById("possession-bar-fill");
    possessionBar.style.width = `${redStats.possession}%`;
    
    document.getElementById("red-possession").textContent = `${redStats.possession}%`;
    document.getElementById("blue-possession").textContent = `${blueStats.possession}%`;
  }

  function toggleStatsPanel() {
    const statsPanel = document.getElementById("stats-panel");
    const toggleBtn = document.getElementById("stats-toggle");
    
    playUISound("button-click");
    
    if (statsPanel.classList.contains("hidden")) {
      statsPanel.classList.remove("hidden");
      toggleBtn.textContent = "📊";
    } else {
      statsPanel.classList.add("hidden");
      toggleBtn.textContent = "📊";
    }
  }

  function togglePowerUpPanel() {
    const powerUpPanel = document.getElementById("powerup-panel");
    const toggleBtn = document.getElementById("powerup-toggle");
    
    playUISound("button-click");
    
    if (powerUpPanel.classList.contains("hidden")) {
      powerUpPanel.classList.remove("hidden");
      toggleBtn.textContent = "🎪";
    } else {
      powerUpPanel.classList.add("hidden");
      toggleBtn.textContent = "🎪";
    }
  }

  // Show/hide power-up panel based on game mode
  function updatePowerUpPanelVisibility(gameMode) {
    const powerUpPanel = document.getElementById("powerup-panel");
    const powerUpToggle = document.getElementById("powerup-toggle");
    
    if (gameMode === "arcade") {
      // Show power-up panel and toggle button in arcade mode
      if (powerUpToggle) {
      powerUpToggle.style.display = "flex";
      }
      if (powerUpPanel) {
      powerUpPanel.classList.remove("hidden");
      }
    } else {
      // Hide power-up panel and toggle button in FIFA mode
      if (powerUpToggle) {
      powerUpToggle.style.display = "none";
      }
      if (powerUpPanel) {
      powerUpPanel.classList.add("hidden");
      }
    }
  }

  // Update active power-up display
  function updateActivePowerUp(powerUpData) {
    const activePowerUp = document.getElementById("active-powerup");
    const powerUpName = document.getElementById("powerup-name");
    const powerUpDescription = document.getElementById("powerup-description");
    const powerUpCooldown = document.getElementById("powerup-cooldown");
    
    if (powerUpData && powerUpData.type) {
      activePowerUp.style.display = "block";
      
      // Map power-up types to display names and descriptions
      const powerUpInfo = {
        'freeze_blast': { name: '🧊 Freeze Blast', desc: 'Freezes nearby opponents for 4 seconds' },
        'speed_boost': { name: '⚡ Speed Boost', desc: 'Doubles movement speed for 8 seconds' },
        
        'fireball': { name: '🔥 Fireball', desc: 'Launches an explosive fireball' },
        'mega_kick': { name: '⚽ Mega Kick', desc: 'Next ball kick has 3x power and speed' },
        'shield': { name: '🛡️ Shield', desc: 'Blocks one attack' },
        'speed': { name: '⚡ Speed Enhancement', desc: 'Increased movement speed' },
        'power': { name: '💪 Power Enhancement', desc: 'Increased shot power' },
        'precision': { name: '🎯 Precision Enhancement', desc: 'Improved accuracy' },
        'shuriken': { name: '🥷 Shuriken Throw', desc: 'Launches stunning projectile that can be dodged' }
      };
      
      const info = powerUpInfo[powerUpData.type] || { name: powerUpData.type, desc: 'Unknown power-up' };
      powerUpName.textContent = info.name;
      powerUpDescription.textContent = info.desc;
      
      if (powerUpData.cooldownRemaining && powerUpData.cooldownRemaining > 0) {
        powerUpCooldown.textContent = `Cooldown: ${powerUpData.cooldownRemaining}s`;
        powerUpCooldown.style.display = "block";
      } else {
        powerUpCooldown.style.display = "none";
      }
    } else {
      activePowerUp.style.display = "none";
    }
  }

  // ===== ENHANCED TIMER SYSTEM =====
  function updateMatchTimer(data) {
    const timeLeft = document.getElementById("time-left");
    const phaseIndicator = document.getElementById("phase-indicator");
    
    matchPhase = data.status;
    
    switch(data.status) {
      case "waiting":
        timeLeft.textContent = "Waiting for players...";
        phaseIndicator.textContent = "LOBBY";
        phaseIndicator.className = "phase-indicator waiting";
        break;
      case "starting":
        timeLeft.textContent = "Starting...";
        phaseIndicator.textContent = "STARTING";
        phaseIndicator.className = "phase-indicator starting";
        break;
      case "playing":
        // Check if we're in stoppage time (halfTimeRemaining <= 0)
        const isStoppageTime = data.halfTimeRemaining <= 0;
        
        if (isStoppageTime && data.stoppageTimeAdded > 0) {
          // Display stoppage time format (5+X for 5-minute halves)
          const stoppageSeconds = Math.abs(data.halfTimeRemaining);
          timeLeft.textContent = `5+${stoppageSeconds}`;
          phaseIndicator.textContent = `HALF ${data.currentHalf} +${Math.floor(stoppageSeconds/60) || 1}'`;
          phaseIndicator.className = "phase-indicator playing stoppage-time";
        } else {
          // Display regular half time remaining
          const halfMinutes = Math.floor(data.halfTimeRemaining / 60);
          const halfSeconds = data.halfTimeRemaining % 60;
          timeLeft.textContent = `${halfMinutes}:${halfSeconds.toString().padStart(2, '0')}`;
          phaseIndicator.textContent = `HALF ${data.currentHalf}`;
          phaseIndicator.className = "phase-indicator playing";
        }
        break;
      case "halftime":
        // Display halftime - manual system (no countdown)
        timeLeft.textContent = "HALFTIME";
        phaseIndicator.textContent = "HALFTIME";
        phaseIndicator.className = "phase-indicator halftime";
        break;
      case "overtime":
        // Display overtime time remaining (using half time remaining for consistency)
        const otMinutes = Math.floor(data.halfTimeRemaining / 60);
        const otSeconds = data.halfTimeRemaining % 60;
        timeLeft.textContent = `${otMinutes}:${otSeconds.toString().padStart(2, '0')}`;
        phaseIndicator.textContent = "OVERTIME";
        phaseIndicator.className = "phase-indicator overtime";
        break;
      case "goal-scored":
        timeLeft.textContent = "GOAL!";
        phaseIndicator.textContent = "GOAL!";
        phaseIndicator.className = "phase-indicator goal";
        break;
      case "finished":
        timeLeft.textContent = "Game Over";
        phaseIndicator.textContent = "FINISHED";
        phaseIndicator.className = "phase-indicator finished";
        break;
    }
  }

  function toggleAudio() {
    audioEnabled = !audioEnabled;
    const audioBtn = document.getElementById("audio-toggle");
    audioBtn.textContent = audioEnabled ? "🔊" : "🔇";
    audioBtn.title = audioEnabled ? "Mute Audio" : "Enable Audio";
    
    playUISound("button-click");
  }

  // ===== DEBUG FUNCTIONS =====
  function testScoreDisplay() {
    console.log("Testing score display...");
    const redScore = document.getElementById("red-score");
    const blueScore = document.getElementById("blue-score");
    
    if (redScore && blueScore) {
      redScore.textContent = "5";
      blueScore.textContent = "3";
      console.log("Test scores set: Red 5, Blue 3");
      console.log("Red score element:", redScore);
      console.log("Blue score element:", blueScore);
      console.log("Red score styles:", window.getComputedStyle(redScore));
      console.log("Blue score styles:", window.getComputedStyle(blueScore));
    } else {
      console.error("Score elements not found!");
    }
  }

  // Add debug function to global scope for testing
  window.testScoreDisplay = testScoreDisplay;

  // ===== TEAM SELECTION =====
  function selectTeam(team, event) {
    // Prevent any default behavior that might trigger cursor mode change
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    console.log(`Team selected: ${team}`);
    
    // Ensure a game mode and player count have been selected
    if (!selectedGameMode) {
      alert("Please select a game mode first!");
      return;
    }
    
    if (!selectedPlayerCount) {
      alert("Please select single player or multiplayer first!");
      return;
    }
    
    // Play UI sound locally without server communication
    if (audioEnabled) {
      console.log("Playing team selection sound locally");
    }
    
    const buttons = document.querySelectorAll(".team-btn");
    buttons.forEach((btn) => btn.classList.remove("selected"));

    const selectedBtn = team === "red" ? document.getElementById("redTeamBtn") : document.getElementById("blueTeamBtn");
    selectedBtn.classList.add("selected");

    // Determine if this is single player mode based on our new flow
    const singlePlayerMode = (selectedPlayerCount === 'single');
    const multiplayerMode = (selectedPlayerCount === 'multiplayer');

    // Hide the instructions panel
    document.getElementById("instructionsPanel").classList.add("hidden");
    
    // Send team selection to server after a brief delay to ensure UI transition completes
    setTimeout(() => {
      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        console.log(`Sending team selection to server: ${team} (${selectedPlayerCount} player mode)`);
        hytopia.sendData({
          type: "team-selected",
          team: team,
          singlePlayerMode: singlePlayerMode,
          multiplayerMode: multiplayerMode,
          playerCount: selectedPlayerCount,
          gameMode: selectedGameMode
        });
      }
    }, 200);
  }

  // ===== INITIALIZATION =====
  // Initialize score display
  function initializeScoreDisplay() {
    console.log("🎯 Initializing main scoreboard...");
    
    // Initialize main scoreboard
    const redScore = document.getElementById("red-score");
    const blueScore = document.getElementById("blue-score");
    const phaseIndicator = document.getElementById("phase-indicator");
    const timeLeft = document.getElementById("time-left");
    const mainScoreboard = document.getElementById("main-scoreboard");
    
    if (redScore && blueScore) {
      redScore.textContent = "0";
      blueScore.textContent = "0";
      
      // Force visibility with important styles
      redScore.style.cssText = `
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        color: #ffffff !important;
        font-size: 28px !important;
        font-weight: bold !important;
        z-index: 10 !important;
        pointer-events: none !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5) !important;
        transition: all 0.3s ease !important;
        min-height: 35px !important;
      `;
      
      blueScore.style.cssText = `
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        color: #ffffff !important;
        font-size: 28px !important;
        font-weight: bold !important;
        z-index: 10 !important;
        pointer-events: none !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5) !important;
        transition: all 0.3s ease !important;
        min-height: 35px !important;
      `;
      
      console.log("✅ Main scoreboard initialized with scores:", redScore.textContent, blueScore.textContent);
    } else {
      console.error("❌ Could not find main score elements!");
    }
    
    // Initialize other UI elements
    if (phaseIndicator) {
      phaseIndicator.textContent = "LOBBY";
      phaseIndicator.className = "phase-indicator waiting";
    }
    
    if (timeLeft) {
      timeLeft.textContent = "Waiting for players...";
    }
    
    // Ensure main scoreboard is visible
    if (mainScoreboard) {
      mainScoreboard.style.cssText = `
        position: fixed !important;
        top: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        display: flex !important;
        align-items: center !important;
        gap: 20px !important;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9)) !important;
        border-radius: 15px !important;
        padding: 15px 25px !important;
        border: 2px solid rgba(255, 255, 255, 0.2) !important;
        backdrop-filter: blur(10px) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        z-index: 1000 !important;
        visibility: visible !important;
        opacity: 1 !important;
      `;
      console.log("✅ Main scoreboard container forced visible");
    }
    
    console.log("✅ Score display initialization complete");
  }

  // Add click event listeners immediately (DOM is already loaded since script is at bottom)
  const redTeamBtn = document.getElementById("redTeamBtn");
  const blueTeamBtn = document.getElementById("blueTeamBtn");
  const fifaModeBtn = document.getElementById("fifaModeBtn");
  const arcadeModeBtn = document.getElementById("arcadeModeBtn");
  // const pickupModeBtn = document.getElementById("pickupModeBtn"); // PICKUP MODE DISABLED
  
  console.log("Red button:", redTeamBtn); // Debug log
  console.log("Blue button:", blueTeamBtn); // Debug log
  console.log("FIFA button:", fifaModeBtn); // Debug log
  console.log("Arcade button:", arcadeModeBtn); // Debug log
  // console.log("Pickup button:", pickupModeBtn); // Debug log - PICKUP MODE DISABLED
  
  // Team selection event listeners with universal handler
  if (redTeamBtn && blueTeamBtn) {
    redTeamBtn.addEventListener("click", (e) => {
      handleButtonClick(e, () => selectTeam("red", e));
    });
    blueTeamBtn.addEventListener("click", (e) => {
      handleButtonClick(e, () => selectTeam("blue", e));
    });
    console.log("Team selection event listeners added successfully"); // Debug log
  } else {
    console.error("Could not find team buttons!"); // Debug log
  }
  
  // Game mode selection event listeners with universal handler
  const tournamentModeBtn = document.getElementById("tournamentModeBtn");
  console.log("Tournament button:", tournamentModeBtn); // Debug log
  
  if (fifaModeBtn && arcadeModeBtn) {
    fifaModeBtn.addEventListener("click", (e) => {
      handleButtonClick(e, () => selectGameMode("fifa", e));
    });
    arcadeModeBtn.addEventListener("click", (e) => {
      handleButtonClick(e, () => selectGameMode("arcade", e));
    });
    
    // Tournament mode event listener
    if (tournamentModeBtn) {
      tournamentModeBtn.addEventListener("click", (e) => {
        handleButtonClick(e, () => selectGameMode("tournament", e));
      });
      console.log("Tournament mode event listener added successfully"); // Debug log
    } else {
      console.error("Could not find tournament mode button!"); // Debug log
    }

    // ===== TOURNAMENT CREATION & MANAGEMENT EVENT HANDLERS =====
    
    // Tournament Creation Button Handler
    const createTournamentBtn = document.getElementById("createTournamentBtn");
    if (createTournamentBtn) {
      createTournamentBtn.addEventListener("click", (e) => {
        handleButtonClick(e, () => handleTournamentCreation(e));
      });
      console.log("✅ Tournament creation event listener added successfully");
    } else {
      console.error("❌ Could not find tournament creation button!");
    }

    // Tournament Join Button Handler
    const joinTournamentBtn = document.getElementById("joinTournamentBtn");
    if (joinTournamentBtn) {
      joinTournamentBtn.addEventListener("click", (e) => {
        handleButtonClick(e, () => handleTournamentJoin(e));
      });
      console.log("✅ Tournament join event listener added successfully");
    } else {
      console.error("❌ Could not find tournament join button!");
    }

    // Tournament Leave Button Handler
    const leaveTournamentBtn = document.getElementById("leaveTournamentBtn");
    if (leaveTournamentBtn) {
      leaveTournamentBtn.addEventListener("click", (e) => {
        handleButtonClick(e, () => handleTournamentLeave(e));
      });
      console.log("✅ Tournament leave event listener added successfully");
    } else {
      console.error("❌ Could not find tournament leave button!");
    }

    // Ready Check Button Handler
    const confirmReadyBtn = document.getElementById("confirmReadyBtn");
    if (confirmReadyBtn) {
      confirmReadyBtn.addEventListener("click", (e) => {
        handleButtonClick(e, () => handleReadyConfirm(e));
      });
      console.log("✅ Ready confirm event listener added successfully");
    } else {
      console.error("❌ Could not find ready confirm button!");
    }

    // Back to Lobby Button Handler
    const backToLobbyBtn = document.getElementById("backToLobbyBtn");
    if (backToLobbyBtn) {
      backToLobbyBtn.addEventListener("click", (e) => {
        handleButtonClick(e, () => handleBackToLobby(e));
      });
      console.log("✅ Back to lobby event listener added successfully");
    } else {
      console.error("❌ Could not find back to lobby button!");
    }
    
    // PICKUP MODE EVENT LISTENER DISABLED
    // pickupModeBtn.addEventListener("click", (e) => {
    //   handleButtonClick(e, () => selectGameMode("pickup", e));
    // });
    console.log("Game mode event listeners added successfully"); // Debug log
  } else {
    console.error("Could not find game mode buttons!"); // Debug log
  }

  // CRITICAL FIX: Add Player Count Selection Button Event Listeners
  const singlePlayerBtn = document.getElementById("singlePlayerBtn");
  const multiplayerBtn = document.getElementById("multiplayerBtn");
  
  console.log("Single Player button:", singlePlayerBtn); // Debug log
  console.log("Multiplayer button:", multiplayerBtn); // Debug log
  
  if (singlePlayerBtn) {
    singlePlayerBtn.addEventListener("click", (e) => {
      console.log("Single Player button clicked"); // Debug log
      handleButtonClick(e, () => selectPlayerCount("single", e));
    });
    console.log("Single Player event listener added successfully"); // Debug log
  } else {
    console.error("Could not find Single Player button!"); // Debug log
  }
  
  if (multiplayerBtn) {
    multiplayerBtn.addEventListener("click", (e) => {
      console.log("Multiplayer button clicked"); // Debug log
      handleButtonClick(e, () => selectPlayerCount("multiplayer", e));
    });
    console.log("Multiplayer event listener added successfully"); // Debug log
  } else {
    console.error("Could not find Multiplayer button!"); // Debug log
  }

  // Enhanced UI initialization with comprehensive button setup
  function initializeAllButtons() {
    console.log('🎮 Initializing all button event handlers...');
    
    // Ensure all buttons have proper cursor and pointer events
    const allButtons = document.querySelectorAll('button, .btn, .team-btn, .game-mode-btn');
    let successCount = 0;
    
    allButtons.forEach((button, index) => {
      try {
        // Force proper styling
        button.style.cursor = 'pointer';
        button.style.pointerEvents = 'auto';
        
        // Add visual feedback on hover
        button.addEventListener('mouseenter', () => {
          button.style.cursor = 'pointer';
        });
        
        button.addEventListener('mouseleave', () => {
          button.style.cursor = 'pointer';
        });
        
        successCount++;
      } catch (error) {
        console.error(`❌ Error initializing button ${index}:`, error);
      }
    });
    
    console.log(`✅ Successfully initialized ${successCount} buttons`);
    
    // Specific validation for critical buttons
    const criticalButtons = [
      'singlePlayerBtn',
      'multiplayerBtn',
      'redTeamBtn',
      'blueTeamBtn',
      'fifaModeBtn',
      'arcadeModeBtn',
      'tournamentModeBtn'
      // 'pickupModeBtn' // PICKUP MODE DISABLED
    ];
    
    criticalButtons.forEach(buttonId => {
      const button = document.getElementById(buttonId);
      if (button) {
        console.log(`✅ Found critical button: ${buttonId}`);
        button.style.cursor = 'pointer';
        button.style.pointerEvents = 'auto';
      } else {
        console.error(`❌ Critical button missing: ${buttonId}`);
      }
    });
  }

  // Initialize the UI with error handling
  try {
    initializeScoreDisplay();
    initializeAllButtons();
    console.log('✅ UI initialization completed successfully');
  } catch (error) {
    console.error('❌ UI initialization error:', error);
  }

  // Final safety check - ensure all buttons are responsive
  setTimeout(() => {
    const allButtons = document.querySelectorAll('button, .btn, .team-btn, .game-mode-btn, .control-btn, .how-to-play-btn, .tab-button');
    let buttonIssues = 0;
    
    allButtons.forEach((button, index) => {
      if (!button.style.cursor || button.style.cursor === 'default') {
        button.style.cursor = 'pointer';
        buttonIssues++;
      }
      if (button.style.pointerEvents === 'none') {
        button.style.pointerEvents = 'auto';
        buttonIssues++;
      }
    });
    
    if (buttonIssues > 0) {
      console.warn(`🔧 Fixed ${buttonIssues} button cursor/pointer issues`);
    }
    
    console.log(`✅ Final button check: ${allButtons.length} buttons verified as clickable`);
  }, 1000);
  
  // ===== MESSAGE HANDLERS =====
  // Listen for messages from the server
  if (typeof hytopia !== 'undefined' && hytopia.onMessage) {
    hytopia.onMessage((data) => {
      if (data.type === "game-mode-confirmed") {
        console.log(`Game mode confirmed: ${data.mode}`);
        // Update UI to show the confirmed mode
        const selectedModeInfo = document.getElementById('selectedModeInfo');
        if (selectedModeInfo) {
          selectedModeInfo.style.borderColor = '#00FF00';
          setTimeout(() => {
            selectedModeInfo.style.borderColor = 'rgba(255, 215, 0, 0.3)';
          }, 1000);
        }
      }
      else if (data.type === "multiplayer-waiting") {
        console.log("Received multiplayer waiting message");
        // Update the multiplayer lobby display
        const currentPlayers = document.querySelector('.current-players');
        if (currentPlayers) {
          currentPlayers.textContent = data.playerCount.toString();
        }
        
        const lobbyMessage = document.querySelector('.lobby-message');
        if (lobbyMessage) {
          lobbyMessage.textContent = data.message || "Waiting for second player to join...";
        }
      }
      else if (data.type === "team-assigned") {
        console.log(`Team assigned: ${data.team}`);
        // Show notification about team assignment
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: linear-gradient(135deg, #6366f1, #4f46e5);
          color: white;
          padding: 20px 30px;
          border-radius: 15px;
          font-weight: bold;
          z-index: 10001;
          box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
          border: 3px solid rgba(255, 255, 255, 0.3);
          text-align: center;
          animation: slideInDown 0.7s ease-out;
        `;
        
        const teamColor = data.team === 'red' ? '🔴' : '🔵';
        notification.innerHTML = `
          <div style="font-size: 32px; margin-bottom: 10px;">${teamColor}</div>
          <h2 style="margin: 0 0 10px 0; font-size: 20px;">Team Assignment</h2>
          <div style="font-size: 16px;">${data.message}</div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOutUp 0.5s ease-in';
          setTimeout(() => {
            if (notification.parentNode) {
              document.body.removeChild(notification);
            }
          }, 500);
        }, 3000);
      }
      // ===== TOURNAMENT MESSAGE HANDLERS =====
      else if (data.type === "tournament-created") {
        console.log("✅ Tournament created successfully:", data.tournament);
        
        // Show success message
        showTournamentSuccess(`Tournament "${data.tournament.name}" created successfully!`);
        
        // Re-enable create button
        const button = document.getElementById("createTournamentBtn");
        if (button) {
          button.disabled = false;
          button.textContent = "🏆 Create Tournament";
        }
        
        // Clear form
        document.getElementById("tournamentName").value = "";
        
        // Store tournament ID for future reference
        window.currentTournamentId = data.tournament.id;
        
        // Switch to tournament lobby view
        const tournamentSelection = document.getElementById("tournamentSelection");
        const tournamentLobby = document.getElementById("tournamentLobby");
        
        if (tournamentSelection) tournamentSelection.style.display = "none";
        if (tournamentLobby) {
          tournamentLobby.style.display = "block";
          
          // Update lobby information
          const lobbyName = document.getElementById("tournamentLobbyName");
          const lobbyDetails = document.getElementById("tournamentLobbyDetails");
          const lobbyStatus = document.getElementById("tournamentLobbyStatus");
          
          if (lobbyName) lobbyName.textContent = data.tournament.name;
          if (lobbyDetails) lobbyDetails.textContent = `${data.tournament.maxPlayers} Players • ${data.tournament.type} • ${data.tournament.gameMode.toUpperCase()} Mode`;
          if (lobbyStatus) lobbyStatus.textContent = "Registration Open";
        }
      }
      else if (data.type === "tournament-error") {
        console.error("❌ Tournament error:", data.message);
        showTournamentError(data.message);
        
        // Re-enable create button
        const button = document.getElementById("createTournamentBtn");
        if (button) {
          button.disabled = false;
          button.textContent = "🏆 Create Tournament";
        }
      }
      else if (data.type === "tournament-joined") {
        console.log("✅ Successfully joined tournament");
        showTournamentSuccess("Successfully joined tournament!");
        
        // Store tournament ID
        window.currentTournamentId = data.tournamentId;
        
        // Update UI to show joined state
        const joinBtn = document.getElementById("joinTournamentBtn");
        const leaveBtn = document.getElementById("leaveTournamentBtn");
        
        if (joinBtn) joinBtn.style.display = "none";
        if (leaveBtn) leaveBtn.style.display = "block";
      }
      else if (data.type === "tournament-left") {
        console.log("✅ Successfully left tournament");
        showTournamentSuccess("Left tournament");
        
        // Clear tournament ID
        window.currentTournamentId = null;
        
        // Update UI to show left state
        const joinBtn = document.getElementById("joinTournamentBtn");
        const leaveBtn = document.getElementById("leaveTournamentBtn");
        
        if (joinBtn) joinBtn.style.display = "block";
        if (leaveBtn) leaveBtn.style.display = "none";
      }
      else if (data.type === "tournament-list-updated") {
        console.log("🏆 Tournament list updated:", data.tournaments);
        
        // Update the active tournaments display
        const activeTournaments = document.getElementById("activeTournaments");
        if (activeTournaments) {
          if (data.tournaments && data.tournaments.length > 0) {
            activeTournaments.innerHTML = "";
            
            data.tournaments.forEach(tournament => {
              const tournamentDiv = document.createElement('div');
              tournamentDiv.className = 'tournament-item';
              tournamentDiv.style.cssText = `
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                padding: 15px;
                margin: 10px 0;
                cursor: pointer;
                transition: all 0.3s ease;
              `;
              
              tournamentDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${tournament.name}</div>
                <div style="font-size: 14px; color: #ccc;">
                  ${tournament.players}/${tournament.maxPlayers} players • ${tournament.type} • ${tournament.gameMode.toUpperCase()}
                </div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                  Status: ${tournament.status}
                </div>
              `;
              
              // Add click handler to join tournament
              tournamentDiv.onclick = () => {
                window.selectedTournamentId = tournament.id;
                console.log("Selected tournament:", tournament.id);
                
                // Visual feedback
                document.querySelectorAll('.tournament-item').forEach(item => {
                  item.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                });
                tournamentDiv.style.borderColor = '#FFD700';
                
                showTournamentSuccess(`Selected: ${tournament.name}`);
              };
              
              activeTournaments.appendChild(tournamentDiv);
            });
          } else {
            activeTournaments.innerHTML = '<div class="no-tournaments">No active tournaments available</div>';
          }
        }
      }
      else if (data.type === "tournament-started") {
        console.log("🏆 Tournament started!");
        showTournamentSuccess("Tournament has started! Get ready for your matches.");
        
        // Update tournament status
        const lobbyStatus = document.getElementById("tournamentLobbyStatus");
        if (lobbyStatus) lobbyStatus.textContent = "Tournament In Progress";
        
        // Show bracket if available
        const bracket = document.getElementById("tournamentBracket");
        if (bracket) bracket.style.display = "block";
      }
      else if (data.type === "tournament-match-ready-check") {
        console.log("🔔 Match ready check started");
        
        // Store match information
        window.currentMatchId = data.matchId;
        
        // Show ready check UI
        const readyCheck = document.getElementById("tournamentReadyCheck");
        const opponent = document.getElementById("readyCheckOpponent");
        const matchInfo = document.getElementById("readyCheckMatchInfo");
        
        if (readyCheck) readyCheck.style.display = "block";
        if (opponent) opponent.textContent = data.opponent || "Unknown";
        if (matchInfo) matchInfo.textContent = `Round ${data.round || 1} • ${data.gameMode?.toUpperCase() || 'FIFA'} Mode`;
        
        // Start countdown timer
        startReadyCheckTimer(data.timeLimit || 300); // 5 minutes default
      }
      else if (data.type === "tournament-match-start") {
        console.log("🏆 Tournament match starting!");
        showTournamentSuccess("Your tournament match is starting!");
        
        // Hide ready check UI
        const readyCheck = document.getElementById("tournamentReadyCheck");
        if (readyCheck) readyCheck.style.display = "none";
      }
    });
  }

  // Ready Check Timer Function
  function startReadyCheckTimer(seconds) {
    const timerElement = document.getElementById("readyCheckTimer");
    let timeLeft = seconds;
    
    const timer = setInterval(() => {
      const minutes = Math.floor(timeLeft / 60);
      const secs = timeLeft % 60;
      
      if (timerElement) {
        timerElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
      }
      
      timeLeft--;
      
      if (timeLeft < 0) {
        clearInterval(timer);
        if (timerElement) timerElement.textContent = "0:00";
        
        // Hide ready check UI if time runs out
        const readyCheck = document.getElementById("tournamentReadyCheck");
        if (readyCheck) readyCheck.style.display = "none";
        
        showTournamentError("Ready check timed out");
      }
    }, 1000);
    
    // Store timer reference for cleanup
    window.readyCheckTimer = timer;
  }
  
  // Add debugging function to test score visibility
  function testScoreDisplay() {
    const redScore = document.getElementById("red-score");
    const blueScore = document.getElementById("blue-score");
    
    console.log("=== SCORE ELEMENT DEBUG ===");
    console.log("Red score element:", redScore);
    console.log("Blue score element:", blueScore);
    
    if (redScore) {
      console.log("Red score computed style:", window.getComputedStyle(redScore));
      console.log("Red score display:", window.getComputedStyle(redScore).display);
      console.log("Red score visibility:", window.getComputedStyle(redScore).visibility);
      console.log("Red score opacity:", window.getComputedStyle(redScore).opacity);
      console.log("Red score color:", window.getComputedStyle(redScore).color);
      console.log("Red score text content:", redScore.textContent);
      console.log("Red score innerHTML:", redScore.innerHTML);
      
      // Force visibility
      redScore.style.display = "flex !important";
      redScore.style.visibility = "visible !important";
      redScore.style.opacity = "1 !important";
      redScore.style.color = "#ffffff !important";
      redScore.style.fontSize = "28px !important";
      redScore.style.fontWeight = "bold !important";
      redScore.style.zIndex = "9999 !important";
      redScore.style.background = "rgba(255, 0, 0, 0.5) !important"; // Temporary red background for debugging
    }
    
    if (blueScore) {
      console.log("Blue score computed style:", window.getComputedStyle(blueScore));
      console.log("Blue score display:", window.getComputedStyle(blueScore).display);
      console.log("Blue score visibility:", window.getComputedStyle(blueScore).visibility);
      console.log("Blue score opacity:", window.getComputedStyle(blueScore).opacity);
      console.log("Blue score color:", window.getComputedStyle(blueScore).color);
      console.log("Blue score text content:", blueScore.textContent);
      console.log("Blue score innerHTML:", blueScore.innerHTML);
      
      // Force visibility
      blueScore.style.display = "flex !important";
      blueScore.style.visibility = "visible !important";
      blueScore.style.opacity = "1 !important";
      blueScore.style.color = "#ffffff !important";
      blueScore.style.fontSize = "28px !important";
      blueScore.style.fontWeight = "bold !important";
      blueScore.style.zIndex = "9999 !important";
      blueScore.style.background = "rgba(0, 0, 255, 0.5) !important"; // Temporary blue background for debugging
    }
    
    console.log("=== END DEBUG ===");
  }
  
  // Test score display after a short delay
  setTimeout(() => {
    testScoreDisplay();
  }, 2000);
  
  // Add global test function for manual testing
  window.forceUpdateScores = function(red = 1, blue = 1) {
    console.log(`🎯 Forcing score update: Red ${red}, Blue ${blue}`);
    
    // Update ONLY the main scoreboard (single system)
    const redScore = document.getElementById("red-score");
    const blueScore = document.getElementById("blue-score");
    const mainScoreboard = document.getElementById("main-scoreboard");
    
    if (redScore && blueScore) {
      redScore.textContent = red;
      blueScore.textContent = blue;
      console.log("✅ MAIN SCOREBOARD updated to:", red, "vs", blue);
    } else {
      console.error("❌ Could not find main score elements!");
    }
    
    // Ensure scoreboard container is visible
    if (mainScoreboard) {
      mainScoreboard.style.display = "flex";
      mainScoreboard.style.visibility = "visible";
      mainScoreboard.style.opacity = "1";
      console.log("✅ Main scoreboard container forced visible");
    }
  };
  
  // Request initial game state from server
  setTimeout(() => {
    console.log("Requesting initial game state...");
    hytopia.sendData({
      type: "request-game-state"
    });
  }, 1000);

  // Test scoreboard visibility after initialization
  setTimeout(() => {
    console.log("🧪 Testing scoreboard visibility...");
    window.forceUpdateScores(0, 0); // Reset to 0-0 but ensure visibility
  }, 2000);

  // ===== ENHANCED PLAYER STATUS & FEEDBACK SYSTEM =====
  
  // Player status tracking
  let playerStatus = {
    role: "player",
    stamina: 100,
    hasBall: false,
    stats: {
      shots: 0,
      passes: 0,
      tackles: 0,
      distance: 0
    }
  };

  // Role configurations
  const roleConfigs = {
    goalkeeper: {
      name: "Goalkeeper",
      description: "Protect the goal",
      icon: "🥅",
      className: "goalkeeper"
    },
    "left-back": {
      name: "Left Back",
      description: "Defend left side",
      icon: "🛡️",
      className: "defender"
    },
    "right-back": {
      name: "Right Back", 
      description: "Defend right side",
      icon: "🛡️",
      className: "defender"
    },
    "central-midfielder-1": {
      name: "Central Mid",
      description: "Control the field",
      icon: "⚡",
      className: "midfielder"
    },
    "central-midfielder-2": {
      name: "Central Mid",
      description: "Support attack",
      icon: "⚡",
      className: "midfielder"
    },
    striker: {
      name: "Striker",
      description: "Score goals",
      icon: "⚽",
      className: "striker"
    }
  };

  // Initialize enhanced UI systems
  function initializeEnhancedUI() {
    console.log("🎮 Initializing enhanced UI systems...");
    
    // Show player status HUD
    const playerHUD = document.getElementById("player-status-hud");
    if (playerHUD) {
      playerHUD.style.display = "block";
      updatePlayerRole("player");
    }



    // Initialize stamina
    updateStamina(100);
    
    console.log("✅ Enhanced UI systems initialized");
  }

  // Update player role display
  function updatePlayerRole(role) {
    const config = roleConfigs[role] || {
      name: "Player",
      description: "Ready to play",
      icon: "⚽",
      className: "player"
    };

    const roleIcon = document.getElementById("role-icon");
    const roleName = document.getElementById("role-name");
    const roleDescription = document.getElementById("role-description");

    if (roleIcon && roleName && roleDescription) {
      roleIcon.textContent = config.icon;
      roleIcon.className = `role-icon ${config.className}`;
      roleName.textContent = config.name;
      roleDescription.textContent = config.description;
    }

    playerStatus.role = role;
    console.log(`🎭 Player role updated to: ${config.name}`);
  }

  // Update stamina display
  function updateStamina(percentage) {
    const staminaFill = document.getElementById("stamina-fill");
    const staminaPercentage = document.getElementById("stamina-percentage");

    if (staminaFill && staminaPercentage) {
      staminaFill.style.width = `${percentage}%`;
      
      // Calculate speed penalty based on stamina level (matching server logic)
      let speedMultiplier = 1.0;
      if (percentage >= 75) {
        speedMultiplier = 1.0;      // 100% speed (75-100% stamina)
      } else if (percentage >= 50) {
        speedMultiplier = 0.9;      // 90% speed (50-75% stamina)
      } else if (percentage >= 25) {
        speedMultiplier = 0.75;     // 75% speed (25-50% stamina)
      } else if (percentage >= 10) {
        speedMultiplier = 0.6;      // 60% speed (10-25% stamina)
      } else {
        speedMultiplier = 0.4;      // 40% speed (0-10% stamina)
      }
      
      // Show speed penalty if applicable
      if (speedMultiplier < 1.0) {
        staminaPercentage.textContent = `${Math.round(percentage)}% (${Math.round(speedMultiplier * 100)}% speed)`;
      } else {
        staminaPercentage.textContent = `${Math.round(percentage)}%`;
      }

      // Update stamina bar color based on level
      staminaFill.className = "stamina-fill";
      if (percentage < 30) {
        staminaFill.classList.add("critical");
      } else if (percentage < 60) {
        staminaFill.classList.add("low");
      }
    }

    playerStatus.stamina = percentage;
  }

  // Show/hide ball possession indicator
  function updateBallPossession(hasBall) {
    const possessionIndicator = document.getElementById("ball-possession");
    
    if (possessionIndicator) {
      possessionIndicator.style.display = hasBall ? "flex" : "none";
    }

    playerStatus.hasBall = hasBall;
  }



  // Show action feedback
  function showActionFeedback(type, title, message, duration = 3000) {
    const container = document.getElementById("action-feedback-container");
    if (!container) return;

    const feedback = document.createElement("div");
    feedback.className = `action-feedback ${type}`;
    
    const icons = {
      success: "✅",
      info: "ℹ️", 
      warning: "⚠️",
      error: "❌"
    };

    feedback.innerHTML = `
      <div class="feedback-icon">${icons[type] || "ℹ️"}</div>
      <div class="feedback-content">
        <div class="feedback-title">${title}</div>
        <div class="feedback-message">${message}</div>
      </div>
    `;

    container.appendChild(feedback);

    // Trigger animation
    setTimeout(() => feedback.classList.add("show"), 10);

    // Remove after duration
    setTimeout(() => {
      feedback.classList.remove("show");
      setTimeout(() => {
        if (feedback.parentNode) {
          feedback.parentNode.removeChild(feedback);
        }
      }, 300);
    }, duration);
  }

  // Toggle formation display
  function toggleFormationDisplay() {
    const formationDisplay = document.getElementById("team-formation-display");
    if (formationDisplay) {
      const isVisible = formationDisplay.style.display !== "none";
      formationDisplay.style.display = isVisible ? "none" : "block";
    }
  }

  // Highlight active player in formation
  function highlightPlayerInFormation(role) {
    // Remove all active classes
    document.querySelectorAll(".field-player").forEach(player => {
      player.classList.remove("active");
    });

    // Map roles to formation elements
    const roleMapping = {
      goalkeeper: "player-gk",
      "left-back": "player-lb",
      "right-back": "player-rb", 
      "central-midfielder-1": "player-cm1",
      "central-midfielder-2": "player-cm2",
      striker: "player-st"
    };

    const playerId = roleMapping[role];
    if (playerId) {
      const playerElement = document.getElementById(playerId);
      if (playerElement) {
        playerElement.classList.add("active");
      }
    }
  }

  // Enhanced game state handler for new UI features
  function handleEnhancedGameState(data) {
    // Update player role if provided
    if (data.playerRole) {
      updatePlayerRole(data.playerRole);
      highlightPlayerInFormation(data.playerRole);
    }

    // Update stamina if provided
    if (data.stamina !== undefined) {
      updateStamina(data.stamina);
    }

    // Update ball possession
    if (data.ballPossession !== undefined) {
      updateBallPossession(data.ballPossession);
    }



    // Show action feedback if provided
    if (data.actionFeedback) {
      const { type, title, message } = data.actionFeedback;
      showActionFeedback(type, title, message);
    }

    // Show formation display during game
    if (data.status === "playing" || data.status === "starting") {
      const formationDisplay = document.getElementById("team-formation-display");
      if (formationDisplay && formationDisplay.style.display === "none") {
        formationDisplay.style.display = "block";
      }
    }
  }

  // Initialize enhanced UI on load
  setTimeout(() => {
    initializeEnhancedUI();
    
    // Test the new features
    setTimeout(() => {
      console.log("🧪 Testing enhanced UI features...");
      showActionFeedback("success", "Welcome!", "Enhanced UI system loaded successfully");
      updatePlayerRole("striker");
      updateStamina(85);

      
      // Test ball possession after a delay
      setTimeout(() => {
        updateBallPossession(true);
        showActionFeedback("info", "Ball Possession", "You now have control of the ball!");
      }, 2000);
      
      // Test stamina drain
      setTimeout(() => {
        updateStamina(45);
        showActionFeedback("warning", "Low Stamina", "Your stamina is getting low!");
      }, 4000);
      
      // Test role change
      setTimeout(() => {
        updatePlayerRole("goalkeeper");
        showActionFeedback("info", "Role Change", "You are now the goalkeeper!");
      }, 6000);
    }, 1000);
  }, 500);

  // ===== DATA HANDLER =====
  hytopia.onData((data) => {
    console.log("Received data:", data.type, data);
    
    // Debug score data specifically
    if (data.type === "game-state" && data.score) {
      console.log("Score data received:", data.score);
    }
    
    if (data.type === "game-state") {
      console.log("🎯 Processing game-state data:", data);
      
      // Update main scoreboard elements
      const redScore = document.getElementById("red-score");
      const blueScore = document.getElementById("blue-score");
      const mainScoreboard = document.getElementById("main-scoreboard");
      
      // ONLY update the score if score data is actually provided
      if (data.score && typeof data.score === 'object' && redScore && blueScore) {
        // Don't update scores if we're in goal-scored status - the goal-scored event handles it
        if (data.status !== "goal-scored") {
          console.log(`📊 BEFORE UPDATE - Red: ${redScore.textContent}, Blue: ${blueScore.textContent}`);
          redScore.textContent = data.score.red;
          blueScore.textContent = data.score.blue;
          console.log(`📊 AFTER UPDATE - Red: ${redScore.textContent}, Blue: ${blueScore.textContent}`);
          console.log("✅ MAIN SCOREBOARD UPDATED:", data.score.red, "vs", data.score.blue);
      } else {
          console.log("⏸️ SKIPPING score update - in goal-scored status, letting goal-scored event handle it");
        }
      } else {
        console.log("🔄 Game-state update without score data - keeping current score");
      }
      
      // Show/hide scoreboard based on game status
      if (mainScoreboard) {
        if (data.status && (data.status === "starting" || data.status === "playing" || data.status === "overtime" || data.status === "goal-scored")) {
          mainScoreboard.style.display = "flex";
          mainScoreboard.style.opacity = "1";
          mainScoreboard.style.visibility = "visible";
          console.log("✅ Scoreboard shown - game status:", data.status);
        } else if (data.status === "waiting") {
          // Keep scoreboard visible but show lobby state
          mainScoreboard.style.display = "flex";
          console.log("✅ Scoreboard visible in lobby - game status:", data.status);
        }
      }
      
      // Update timer with enhanced display
      updateMatchTimer(data);
      
      // Update statistics if provided
      if (data.stats) {
        currentGameStats = data.stats;
        updateStatisticsPanel();
      }

      // Handle enhanced UI features
      handleEnhancedGameState(data);
      
      console.log("✅ Game state update complete");
    }

    if (data.type === "team-counts") {
      console.log("Processing team-counts data:", data);
      // Update team counts (sent separately from game-state)
      document.getElementById("red-team-count").textContent = `Players: ${data.red}/${data.maxPlayers}`;
      document.getElementById("blue-team-count").textContent = `Players: ${data.blue}/${data.maxPlayers}`;
    }

    if (data.type === "countdown") {
      showCountdown(data.count);
    }

    if (data.type === "stoppage-time-notification") {
      console.log("⏱️ Stoppage time notification received:", data);
      showStoppageTimeNotification(data);
    }

    if (data.type === "power-bar") {
      updatePowerBar(data.percentage);
    }

    if (data.type === "cooldown") {
      showCooldownMessage(data.message, data.duration);
    }

    if (data.type === "ability") {
      showAbility(data.iconUrl);
    }

    // New Phase 1 data handlers
    if (data.type === "player-stats") {
      playerStats = data.stats;
      updatePlayerStatsDisplay();
    }

    if (data.type === "match-stats") {
      currentGameStats = data.stats;
      updateStatisticsPanel();
    }

    if (data.type === "game-over") {
      console.log("🎯 GAME OVER EVENT RECEIVED:", data);
      showEnhancedGameOver(data);
    }

    if (data.type === "regulation-time-stats") {
      showRegulationTimeStats(data);
    }

    if (data.type === "game-reset") {
      handleGameReset(data);
    }

    if (data.type === "goal-scored") {
      console.log("🥅 GOAL SCORED! Team:", data.team, "Score:", data.score);
      
      // Update main scoreboard immediately when goal is scored
      const redScore = document.getElementById("red-score");
      const blueScore = document.getElementById("blue-score");
      
      if (redScore && blueScore && data.score) {
        console.log(`🥅 BEFORE GOAL UPDATE - Red: ${redScore.textContent}, Blue: ${blueScore.textContent}`);
        redScore.textContent = data.score.red;
        blueScore.textContent = data.score.blue;
        console.log(`🥅 AFTER GOAL UPDATE - Red: ${redScore.textContent}, Blue: ${blueScore.textContent}`);
        console.log("✅ GOAL EVENT - Main scoreboard updated:", data.score.red, "vs", data.score.blue);
        
        // Add goal celebration animation
        const scoringTeam = data.team === "red" ? redScore : blueScore;
        scoringTeam.style.animation = "scoreUpdate 1s ease-out";
        setTimeout(() => {
          scoringTeam.style.animation = "";
        }, 1000);
        
        // Run animated score change for both teams
        animateScoreChange("red", data.score.red);
        animateScoreChange("blue", data.score.blue);
      } else {
        console.error("❌ Could not find scoreboard elements or score data for goal update!");
      }
      
      // Show enhanced goal celebration and play sound
      showEnhancedGoal(data.team);
      playGoalCelebration(data.team);
    }

            // Handle powerup feedback from numbered key activation
    if (data.type === "powerup-feedback") {
      console.log("Powerup feedback received:", data);
      showPowerupFeedback(data);
    }

    // Handle specific power-up activation responses
    if (data.type === "powerup-activated") {
      console.log("Powerup activated response:", data);
      showPowerupFeedback({
        success: true,
        powerUpType: data.powerUpType,
        message: data.message || `${getPowerupName(data.powerUpType)} activated!`
      });
    }

    // Handle action feedback from server
    if (data.type === "action-feedback") {
      console.log("Action feedback received:", data);
      showActionFeedback(data.feedbackType, data.title, data.message);
    }

    // Handle FIRST HALF COMPLETE! display
    if (data.type === "halftime-stats") {
      console.log("🏟️ FIRST HALF COMPLETE! received:", data);
      showHalftimeStats(data);
    }



    // Handle loading progress updates
    if (data.type === "loading-progress") {
      console.log("Loading progress:", data);
      showLoadingOverlay();
      updateLoadingProgress(data.current, data.total, data.message, data.percentage);
    }

    // Handle loading completion
    if (data.type === "loading-complete") {
      console.log("Loading complete");
      hideLoadingOverlay();
    }

    // Handle loading errors
    if (data.type === "loading-error") {
      console.log("Loading error:", data.message);
      showLoadingError(data.message);
    }

    // Handle spectator mode activation
    if (data.type === "spectator-mode-active") {
      console.log("Spectator mode activated:", data.message);
      showSpectatorMode(data.message);
    }

    // Handle background loading started (Phase 2)
    if (data.type === "background-loading-started") {
      console.log("Background loading started:", data.message);
      showBackgroundLoadingIndicator(data.message);
    }

    // Handle background loading complete (Phase 2)
    if (data.type === "background-loading-complete") {
      console.log("Background loading complete:", data.message);
      hideBackgroundLoadingIndicator();
    }

    // Handle regular player stats updates
    if (data.type === "player-stats-update") {
      console.log("Player stats update received:", data);
      updatePlayerStats(data.playerStats);
    }
  });

  // ===== BACKGROUND LOADING INDICATOR (PHASE 2) =====
  function showBackgroundLoadingIndicator(message) {
    let indicator = document.getElementById("background-loading-indicator");
    
    if (!indicator) {
      indicator = document.createElement('div');
      indicator.id = "background-loading-indicator";
      indicator.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        background: linear-gradient(135deg, rgba(0, 100, 200, 0.9), rgba(0, 150, 255, 0.9));
        color: white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: bold;
        z-index: 9998;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateX(100%);
      `;
      document.body.appendChild(indicator);
    }
    
    indicator.textContent = `⚙️ ${message}`;
    indicator.style.opacity = "1";
    indicator.style.transform = "translateX(0)";
  }
  
  function hideBackgroundLoadingIndicator() {
    const indicator = document.getElementById("background-loading-indicator");
    if (indicator) {
      indicator.style.opacity = "0";
      indicator.style.transform = "translateX(100%)";
      
      setTimeout(() => {
        if (indicator.parentNode) {
          indicator.parentNode.removeChild(indicator);
        }
      }, 300);
    }
  }

  // ===== ENHANCED GOAL CELEBRATION =====
  function showEnhancedGoal(team) {
    const goalText = document.querySelector(".game-text");
    const goalOverlay = document.getElementById("goal-overlay");
    
    goalText.className = `game-text ${team} enhanced`;
    goalText.style.display = "block";
    
    if (goalOverlay) {
      goalOverlay.className = `goal-overlay ${team}`;
      goalOverlay.style.display = "block";
      
      setTimeout(() => {
        goalOverlay.style.display = "none";
      }, 2000);
    }
    
    setTimeout(() => {
      goalText.style.display = "none";
    }, 3000);
  }

  // ===== UTILITY FUNCTIONS =====
  function showCountdown(count) {
    const countdownText = document.getElementById("countdown-display");
    countdownText.textContent = count;
    countdownText.style.display = "block";
    
    playUISound("countdown");
    
    setTimeout(() => {
      countdownText.style.display = "none";
    }, 1000);
  }

  // ===== STOPPAGE TIME NOTIFICATION SYSTEM =====
  function showStoppageTimeNotification(data) {
    // Create the notification element
    const notification = document.createElement('div');
    notification.className = 'stoppage-time-notification';
    notification.innerHTML = `
      <div class="stoppage-time-icon">⏱️</div>
      <div><strong>STOPPAGE TIME</strong></div>
      <div class="stoppage-time-message">${data.message}</div>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Note: Audio is handled directly by the backend when stoppage time is added
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.classList.add('hide');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 500); // Wait for animation to complete
    }, 3000);
  }



  function updatePlayerStatsDisplay() {
    // Update individual player stats if panel is visible
    const playerStatsPanel = document.getElementById("player-stats-panel");
    if (playerStatsPanel && !playerStatsPanel.classList.contains("hidden")) {
      // Implementation for detailed player stats
    }
  }

  function updatePowerBar(percentage) {
    powerBarPercentage = percentage;
    
    // Find all power bars and update them
    const powerBars = document.querySelectorAll('[data-power-bar]');
    powerBars.forEach(bar => {
      const fillElement = bar.querySelector('div > div');
      if (fillElement) {
        fillElement.style.width = `${percentage}%`;
      }
    });
  }

  function showCooldownMessage(message, duration) {
    const cooldownMsg = document.getElementById("cooldown-message");
    cooldownMsg.textContent = message;
    cooldownMsg.classList.add("visible");
    
    setTimeout(() => {
      cooldownMsg.classList.remove("visible");
    }, duration);
  }

  function showAbility(iconUrl) {
    const abilityIcon = document.getElementById("ability-icon");
    abilityIcon.src = iconUrl;
    abilityIcon.classList.add("visible");
    
    setTimeout(() => {
      abilityIcon.classList.remove("visible");
    }, 3000);
  }

  // ===== POWERUP FEEDBACK =====
  function showPowerupFeedback(data) {
    // Create or update powerup feedback notification
    let notification = document.getElementById("powerup-notification");
    
    if (!notification) {
      notification = document.createElement('div');
      notification.id = "powerup-notification";
      notification.style.cssText = `
        position: fixed;
        top: 150px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 25px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 16px;
        z-index: 9999;
        transition: all 0.3s ease;
        opacity: 0;
        pointer-events: none;
        max-width: 300px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
      `;
      document.body.appendChild(notification);
    }

    // Style based on success/failure
    if (data.success) {
      notification.style.background = "linear-gradient(135deg, rgba(0, 200, 0, 0.9), rgba(0, 150, 0, 0.9))";
      notification.style.color = "#ffffff";
      notification.style.borderColor = "#00ff00";
      notification.textContent = data.message || `🎮 POWERUP ACTIVATED!`;
      
      // Play success sound
      playUISound("button-click");
    } else {
      notification.style.background = "linear-gradient(135deg, rgba(200, 100, 0, 0.9), rgba(150, 80, 0, 0.9))";
      notification.style.color = "#ffffff";
      notification.style.borderColor = "#ffaa00";
      notification.textContent = data.message || "❌ Powerup failed";
    }

    // Show notification
    notification.style.opacity = "1";
    
    // Hide after 3 seconds
    setTimeout(() => {
      notification.style.opacity = "0";
    }, 3000);
  }

  // ===== ENHANCED GAME OVER FUNCTIONS =====
  function showEnhancedGameOver(data) {
    console.log("🎯 showEnhancedGameOver called with data:", data);
    
    const panel = document.getElementById("instructionsPanel");
    // Get all game-over-content divs and use the complete one (usually the last one)
    const gameOverElements = document.querySelectorAll("#game-over-content");
    const gameOverContent = gameOverElements[gameOverElements.length - 1]; // Use the last (complete) instance
    const howToPlayContainer = document.querySelector(".how-to-play-container");
    const teamSelection = document.querySelector(".team-selection");
    const gameModeSelection = document.getElementById("gameModeSelection");
    
    console.log("🎯 Found elements:", {
      panel: !!panel,
      gameOverContent: !!gameOverContent,
      gameOverElementsCount: gameOverElements.length,
      howToPlayContainer: !!howToPlayContainer,
      teamSelection: !!teamSelection,
      gameModeSelection: !!gameModeSelection
    });
    
    playUISound("game-over");
    
    // Hide other content
    if (howToPlayContainer) howToPlayContainer.style.display = "none";
    if (teamSelection) teamSelection.style.display = "none";
    if (gameModeSelection) gameModeSelection.style.display = "none";
    
    if (!gameOverContent) {
      console.error("❌ game-over-content element not found!");
      return;
    }
    
    gameOverContent.style.display = "block";
    console.log("🎯 Set game-over-content display to block");
    
    // Update header information
    const finalRedScore = document.getElementById("final-red-score");
    const finalBlueScore = document.getElementById("final-blue-score");
    const winnerAnnouncement = document.getElementById("winner-announcement");
    
    console.log("🎯 Score elements found:", {
      finalRedScore: !!finalRedScore,
      finalBlueScore: !!finalBlueScore,
      winnerAnnouncement: !!winnerAnnouncement
    });
    
    if (finalRedScore) finalRedScore.textContent = data.redScore;
    if (finalBlueScore) finalBlueScore.textContent = data.blueScore;
    
    console.log("🎯 Updated scores:", data.redScore, "vs", data.blueScore);
    
    // Update winner announcement
    if (winnerAnnouncement) {
    if (data.winner === 'tie') {
      winnerAnnouncement.textContent = "Match Tied!";
      winnerAnnouncement.style.color = "#FFD700";
    } else if (data.winner === 'red') {
      winnerAnnouncement.textContent = "Red Team Wins!";
      winnerAnnouncement.style.color = "#ff4444";
    } else if (data.winner === 'blue') {
      winnerAnnouncement.textContent = "Blue Team Wins!";
      winnerAnnouncement.style.color = "#4444ff";
      }
      console.log("🎯 Winner announcement set:", winnerAnnouncement.textContent);
    }
    
    // Update match info
    const matchInfo = document.getElementById("match-info");
    const duration = Math.floor(data.matchDuration / 60);
    const seconds = data.matchDuration % 60;
    const overtimeText = data.wasOvertime ? " (Including Overtime)" : "";
    matchInfo.textContent = `Match Duration: ${duration}:${seconds.toString().padStart(2, '0')}${overtimeText}`;
    
    // Update team statistics
    console.log("🎯 Updating team stats:", data.teamStats);
    updateTeamStats(data.teamStats);
    
    // Update player statistics
    console.log("🎯 Updating player stats:", data.playerStats);
    updatePlayerStats(data.playerStats);
    
    if (panel) {
    panel.classList.remove("hidden");
      console.log("🎯 Removed hidden class from instructions panel");
    } else {
      console.error("❌ Instructions panel not found!");
    }
  }

  function showRegulationTimeStats(data) {
    // Show a temporary overlay with regulation time stats
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      color: white;
      font-family: "Trebuchet MS", Arial, sans-serif;
    `;
    
    overlay.innerHTML = `
      <div style="text-align: center; background: rgba(20, 20, 20, 0.95); padding: 40px; border-radius: 20px; border: 3px solid #FFD700;">
        <h2 style="color: #FFD700; margin-bottom: 20px; font-size: 32px;">${data.message}</h2>
        <div style="font-size: 24px; margin-bottom: 20px;">
          Red ${data.redScore} - ${data.blueScore} Blue
        </div>
        <div style="color: #ccc; margin-bottom: 30px;">
          ${data.redScore === data.blueScore ? 'Proceeding to Overtime...' : 'Match Complete!'}
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 600px;">
          ${data.playerStats.slice(0, 6).map(player => `
            <div style="background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 8px; border-left: 4px solid ${player.team === 'red' ? '#ff4444' : '#4444ff'};">
              <div style="font-weight: bold; margin-bottom: 5px;">${player.name}</div>
              <div style="font-size: 12px; color: #ccc; margin-bottom: 10px;">${player.role}</div>
              <div style="display: flex; justify-content: space-between;">
                <span>Goals:</span>
                <span style="color: #FFD700; font-weight: bold;">${player.goals}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>Tackles:</span>
                <span style="color: #FFD700; font-weight: bold;">${player.tackles}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Remove overlay after 3 seconds
    setTimeout(() => {
      document.body.removeChild(overlay);
    }, 3000);
  }

  function updateTeamStats(teamStats) {
    console.log("🎯 updateTeamStats called with:", teamStats);
    
    // Update red team stats
    const redElements = {
      goals: document.getElementById("red-team-goals"),
      shots: document.getElementById("red-team-shots"),
      passes: document.getElementById("red-team-passes"),
      tackles: document.getElementById("red-team-tackles"),
      saves: document.getElementById("red-team-saves"),
      distance: document.getElementById("red-team-distance")
    };
    
    console.log("🎯 Red team elements found:", Object.keys(redElements).reduce((acc, key) => {
      acc[key] = !!redElements[key];
      return acc;
    }, {}));
    
    if (redElements.goals) redElements.goals.textContent = teamStats.red.goals;
    if (redElements.shots) redElements.shots.textContent = teamStats.red.shots;
    if (redElements.passes) redElements.passes.textContent = teamStats.red.passes;
    if (redElements.tackles) redElements.tackles.textContent = teamStats.red.tackles;
    if (redElements.saves) redElements.saves.textContent = teamStats.red.saves;
    if (redElements.distance) redElements.distance.textContent = Math.round(teamStats.red.distanceTraveled) + "m";
    
    // Update blue team stats
    const blueElements = {
      goals: document.getElementById("blue-team-goals"),
      shots: document.getElementById("blue-team-shots"),
      passes: document.getElementById("blue-team-passes"),
      tackles: document.getElementById("blue-team-tackles"),
      saves: document.getElementById("blue-team-saves"),
      distance: document.getElementById("blue-team-distance")
    };
    
    console.log("🎯 Blue team elements found:", Object.keys(blueElements).reduce((acc, key) => {
      acc[key] = !!blueElements[key];
      return acc;
    }, {}));
    
    if (blueElements.goals) blueElements.goals.textContent = teamStats.blue.goals;
    if (blueElements.shots) blueElements.shots.textContent = teamStats.blue.shots;
    if (blueElements.passes) blueElements.passes.textContent = teamStats.blue.passes;
    if (blueElements.tackles) blueElements.tackles.textContent = teamStats.blue.tackles;
    if (blueElements.saves) blueElements.saves.textContent = teamStats.blue.saves;
    if (blueElements.distance) blueElements.distance.textContent = Math.round(teamStats.blue.distanceTraveled) + "m";
    
    console.log("🎯 Team stats updated successfully");
  }

  function updatePlayerStats(playerStats) {
    // Ensure playerStats is an array before trying to filter
    if (!Array.isArray(playerStats)) {
      console.log("⚠️ updatePlayerStats called with non-array data:", typeof playerStats, playerStats);
      return;
    }
    
    const redPlayers = playerStats.filter(p => p.team === 'red');
    const bluePlayers = playerStats.filter(p => p.team === 'blue');
    
    // Update red team players
    const redContainer = document.getElementById("red-players-stats");
    redContainer.innerHTML = redPlayers.map(player => `
      <div class="player-stat-card red-player">
        <div>
          <div class="player-name">${player.name}</div>
          <div class="player-role">${player.role.replace(/-/g, ' ')}</div>
        </div>
        <div class="player-stat-group">
          <span class="stat-number">${player.goals}</span>
          <span class="stat-name">Goals</span>
        </div>
        <div class="player-stat-group">
          <span class="stat-number">${player.tackles}</span>
          <span class="stat-name">Tackles</span>
        </div>
        <div class="player-stat-group">
          <span class="stat-number">${player.distanceTraveled}m</span>
          <span class="stat-name">Distance</span>
        </div>
      </div>
    `).join('');
    
    // Update blue team players
    const blueContainer = document.getElementById("blue-players-stats");
    blueContainer.innerHTML = bluePlayers.map(player => `
      <div class="player-stat-card blue-player">
        <div>
          <div class="player-name">${player.name}</div>
          <div class="player-role">${player.role.replace(/-/g, ' ')}</div>
        </div>
        <div class="player-stat-group">
          <span class="stat-number">${player.goals}</span>
          <span class="stat-name">Goals</span>
        </div>
        <div class="player-stat-group">
          <span class="stat-number">${player.tackles}</span>
          <span class="stat-name">Tackles</span>
        </div>
        <div class="player-stat-group">
          <span class="stat-number">${player.distanceTraveled}m</span>
          <span class="stat-name">Distance</span>
        </div>
      </div>
    `).join('');
  }

  function showPlayerTab(team) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Show/hide player stats content
    document.getElementById('red-players-stats').style.display = team === 'red' ? 'block' : 'none';
    document.getElementById('blue-players-stats').style.display = team === 'blue' ? 'block' : 'none';
  }

  // Make function globally accessible
  window.showPlayerTab = showPlayerTab;

  // ===== SPECTATOR MODE FUNCTIONS =====
  function showSpectatorMode(message) {
    console.log("🎥 Spectator mode activated:", message);
    
    // Create spectator mode overlay
    const spectatorOverlay = document.createElement('div');
    spectatorOverlay.id = 'spectator-mode-overlay';
    spectatorOverlay.style.cssText = `
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 15px 20px;
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.9), rgba(79, 70, 229, 0.9));
      color: white;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      font-weight: 600;
      z-index: 9999;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideInLeft 0.5s ease-out;
    `;
    
    spectatorOverlay.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <div style="font-size: 20px;">🎥</div>
        <div>
          <div style="font-size: 14px; margin-bottom: 2px;">SPECTATOR MODE</div>
          <div style="font-size: 12px; color: rgba(255, 255, 255, 0.8);">${message}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(spectatorOverlay);
    
    // Add spectator controls
    showSpectatorControls();
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      spectatorOverlay.style.animation = 'slideOutLeft 0.5s ease-in';
      setTimeout(() => {
        if (spectatorOverlay.parentNode) {
          spectatorOverlay.parentNode.removeChild(spectatorOverlay);
        }
      }, 500);
    }, 5000);
    
    playUISound("notification");
  }

  function showSpectatorControls() {
    // Remove existing controls if they exist
    const existingControls = document.getElementById('spectator-controls');
    if (existingControls) {
      existingControls.remove();
    }
    
    // Create spectator controls panel
    const controlsPanel = document.createElement('div');
    controlsPanel.id = 'spectator-controls';
    controlsPanel.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      z-index: 9998;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      animation: slideInUp 0.5s ease-out;
    `;
    
    controlsPanel.innerHTML = `
      <div style="display: flex; gap: 15px; align-items: center;">
        <div style="color: #9333ea; font-weight: 600;">🎥 SPECTATOR</div>
        <div style="display: flex; gap: 10px;">
          <button onclick="spectateNext()" style="background: rgba(59, 130, 246, 0.8); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s;">Next Player</button>
          <button onclick="spectateCamera()" style="background: rgba(16, 185, 129, 0.8); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s;">Camera View</button>
          <button onclick="leaveSpectator()" style="background: rgba(239, 68, 68, 0.8); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s;">Leave</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(controlsPanel);
  }

  function spectateNext() {
    console.log("🎥 Spectator: Switch to next player");
    hytopia.sendData({
      type: "spectator-next-player"
    });
    playUISound("button-click");
  }

  function spectateCamera() {
    console.log("🎥 Spectator: Switch camera view");
    hytopia.sendData({
      type: "spectator-next-camera"
    });
    playUISound("button-click");
  }

  function leaveSpectator() {
    console.log("🎥 Spectator: Leave spectator mode");
    hytopia.sendData({
      type: "spectator-leave"
    });
    
    // Remove spectator controls
    const controls = document.getElementById('spectator-controls');
    if (controls) {
      controls.style.animation = 'slideOutDown 0.5s ease-in';
      setTimeout(() => {
        if (controls.parentNode) {
          controls.parentNode.removeChild(controls);
        }
      }, 500);
    }
    
    playUISound("button-click");
  }

  // Make spectator functions globally accessible
  window.spectateNext = spectateNext;
  window.spectateCamera = spectateCamera;
  window.leaveSpectator = leaveSpectator;

  function closeGameOverScreen() {
    const panel = document.getElementById("instructionsPanel");
    // Use the complete instance of game-over-content
    const gameOverElements = document.querySelectorAll("#game-over-content");
    const gameOverContent = gameOverElements[gameOverElements.length - 1];
    const howToPlayContainer = document.querySelector(".how-to-play-container");
    const teamSelection = document.querySelector(".team-selection");
    const gameModeSelection = document.getElementById("gameModeSelection");
    const selectedModeInfo = document.getElementById("selectedModeInfo");
    
    // Reset game mode selection
    selectedGameMode = null;
    document.querySelectorAll('.game-mode-btn').forEach(btn => {
      btn.classList.remove('selected');
    });
    if (selectedModeInfo) selectedModeInfo.style.display = "none";
    
    // Hide game over content and show normal lobby
    gameOverContent.style.display = "none";
    if (howToPlayContainer) howToPlayContainer.style.display = "block";
    if (gameModeSelection) gameModeSelection.style.display = "block";
    if (teamSelection) teamSelection.style.display = "none"; // Hide until mode is selected again
    
    playUISound("button-click");
  }

  /**
   * Enhanced game over screen functions for better user experience
   */
  function viewStatsToggle() {
    // Toggle between team stats and player stats view
    const teamStatsContainer = document.querySelector('.team-stats-container');
    const playerStatsContainer = document.querySelector('.player-stats-container');
    
    if (teamStatsContainer && playerStatsContainer) {
      const isTeamStatsVisible = teamStatsContainer.style.display !== 'none';
      
      if (isTeamStatsVisible) {
        // Currently showing team stats, switch to player stats
        teamStatsContainer.style.display = 'none';
        playerStatsContainer.style.display = 'block';
        
        // Update button text
        event.target.innerHTML = '📈 View Team Stats';
      } else {
        // Currently showing player stats, switch to team stats
        teamStatsContainer.style.display = 'block';
        playerStatsContainer.style.display = 'none';
        
        // Update button text
        event.target.innerHTML = '📊 View Player Stats';
      }
      
      playUISound("button-click");
    }
  }

  function returnToLobby() {
    console.log("🏠 Player requested return to lobby");
    
    // Send manual reset request to server
    hytopia.sendData({
      type: "manual-reset-game"
    });
    
    // Show loading message while reset is processed
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'reset-loading-overlay';
    loadingOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      color: white;
      font-family: "Trebuchet MS", Arial, sans-serif;
    `;
    
    loadingOverlay.innerHTML = `
      <div style="text-align: center; background: rgba(20, 20, 20, 0.95); padding: 40px; border-radius: 20px; border: 3px solid #10b981;">
        <div style="font-size: 32px; margin-bottom: 20px;">🏠</div>
        <h2 style="color: #10b981; margin-bottom: 20px; font-size: 24px;">Returning to Lobby...</h2>
        <div style="color: #ccc; margin-bottom: 20px;">Preparing new game environment</div>
        <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #10b981; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div>
      </div>
    `;
    
    document.body.appendChild(loadingOverlay);
    
    // The loading overlay will be removed when the "game-reset" event is received
    
    playUISound("button-click");
  }

  // Show FIRST HALF COMPLETE! overlay
  function showHalftimeStats(data) {
    console.log("🏟️ Displaying FIRST HALF COMPLETE!:", data);
    
    // Create FIRST HALF COMPLETE! overlay
    const halftimeOverlay = document.createElement('div');
    halftimeOverlay.id = 'halftime-stats-overlay';
    halftimeOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 10000;
      color: white;
      font-family: 'Inter', sans-serif;
      animation: fadeIn 0.5s ease-in;
      pointer-events: auto;
      cursor: default;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    `;
    
    // Create stats content
    const statsContent = document.createElement('div');
    statsContent.style.cssText = `
      background: linear-gradient(135deg, #1e3a8a, #3b82f6);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      max-width: 800px;
      width: 100%;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      animation: slideInUp 0.7s ease-out;
    `;
    
    // Create header
    const header = document.createElement('div');
    header.style.cssText = `
      margin-bottom: 30px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 20px;
    `;
    
    header.innerHTML = `
      <h1 style="font-size: 36px; margin: 0 0 10px 0; color: #FFD700;">
        🏟️ ${data.message || 'FIRST HALF COMPLETE!'}
      </h1>
      <div style="font-size: 24px; color: #87CEEB;">
        Score: Red ${data.redScore} - ${data.blueScore} Blue
      </div>
    `;
    
    // Create player stats section
    const playerStatsSection = document.createElement('div');
    playerStatsSection.style.cssText = `
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    `;
    
    // Filter players by team
    const redPlayers = data.playerStats.filter(p => p.team === 'red');
    const bluePlayers = data.playerStats.filter(p => p.team === 'blue');
    
    // Create team stats containers
    const redTeamStats = document.createElement('div');
    redTeamStats.style.cssText = `
      background: rgba(220, 38, 38, 0.2);
      border: 2px solid #dc2626;
      border-radius: 15px;
      padding: 20px;
    `;
    
    const blueTeamStats = document.createElement('div');
    blueTeamStats.style.cssText = `
      background: rgba(37, 99, 235, 0.2);
      border: 2px solid #2563eb;
      border-radius: 15px;
      padding: 20px;
    `;
    
    // Red team header
    redTeamStats.innerHTML = `
      <h3 style="color: #dc2626; margin: 0 0 15px 0; font-size: 20px;">
        🔴 Red Team
      </h3>
      ${redPlayers.map(player => `
        <div style="background: rgba(255, 255, 255, 0.1); margin: 8px 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between;">
          <div>
            <div style="font-weight: bold; color: #FFD700;">${player.name}</div>
            <div style="font-size: 12px; color: #87CEEB;">${player.role.replace(/-/g, ' ')}</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 14px;">⚽ ${player.goals} | 🦵 ${player.tackles}</div>
            <div style="font-size: 12px; color: #87CEEB;">${Math.round(player.distanceTraveled)}m</div>
          </div>
        </div>
      `).join('')}
    `;
    
    // Blue team header
    blueTeamStats.innerHTML = `
      <h3 style="color: #2563eb; margin: 0 0 15px 0; font-size: 20px;">
        🔵 Blue Team
      </h3>
      ${bluePlayers.map(player => `
        <div style="background: rgba(255, 255, 255, 0.1); margin: 8px 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between;">
          <div>
            <div style="font-weight: bold; color: #FFD700;">${player.name}</div>
            <div style="font-size: 12px; color: #87CEEB;">${player.role.replace(/-/g, ' ')}</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 14px;">⚽ ${player.goals} | 🦵 ${player.tackles}</div>
            <div style="font-size: 12px; color: #87CEEB;">${Math.round(player.distanceTraveled)}m</div>
          </div>
        </div>
      `).join('')}
    `;
    
    // Add manual start button section
    const countdownSection = document.createElement('div');
    countdownSection.style.cssText = `
      margin-top: 30px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      border: 3px solid rgba(255, 215, 0, 0.8);
      box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
      text-align: center;
      pointer-events: auto;
      z-index: 10001;
      position: relative;
    `;
    
    countdownSection.innerHTML = `
      <div style="font-size: 24px; color: #FFD700; margin-bottom: 20px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); animation: pulse 2s infinite;">
        ⏱️ HALFTIME BREAK
      </div>
      <div style="font-size: 18px; color: #87CEEB; margin-bottom: 30px; font-weight: 500;">
        Review the stats and click when ready to continue
      </div>
      <button id="start-second-half-btn" style="
        background: linear-gradient(135deg, #22c55e, #16a34a, #22c55e);
        color: white;
        border: 3px solid #22c55e;
        padding: 20px 40px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 15px;
        cursor: pointer !important;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        font-family: 'Inter', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        z-index: 10002;
        pointer-events: auto !important;
        min-width: 220px;
        margin: 0 auto;
        display: block;
        animation: glow 2s infinite alternate;
      ">
        🚀 START SECOND HALF
      </button>
    `;
    
    // Assemble the overlay
    playerStatsSection.appendChild(redTeamStats);
    playerStatsSection.appendChild(blueTeamStats);
    
    statsContent.appendChild(header);
    statsContent.appendChild(playerStatsSection);
    statsContent.appendChild(countdownSection);
    
    halftimeOverlay.appendChild(statsContent);
    document.body.appendChild(halftimeOverlay);
    
    // ✨ HYTOPIA-COMPLIANT BUTTON HANDLING ✨
    // Instead of addEventListener, add click handler attribute for Hytopia compatibility
    setTimeout(() => {
      const button = document.getElementById('start-second-half-btn');
      if (button) {
        console.log("🚀 Setting up Hytopia-compliant halftime button");
        
        // Use onclick attribute instead of addEventListener (Hytopia-compliant)
        button.setAttribute('onclick', 'startSecondHalf()');
        
        // Add hover effects with onmouseover/onmouseout (Hytopia-compliant)
        button.setAttribute('onmouseover', 'this.style.transform="scale(1.05)"; this.style.boxShadow="0 15px 40px rgba(34, 197, 94, 0.6)";');
        button.setAttribute('onmouseout', 'this.style.transform="scale(1.02)"; this.style.boxShadow="0 12px 35px rgba(34, 197, 94, 0.6)";');
        
        // Force cursor to pointer
        button.style.cursor = 'pointer !important';
        
        // Ensure button is always visible and clickable
        ensureHalftimeButtonVisible();
        
        console.log("✅ Hytopia-compliant halftime button setup complete");
      } else {
        console.error("❌ Could not find halftime button for setup");
      }
    }, 100);
    
    // Additional failsafe check after a longer delay
    setTimeout(() => {
      if (!ensureHalftimeButtonVisible()) {
        console.error("❌ CRITICAL: Halftime button not found after 1 second!");
      }
    }, 1000);
    
    // Listen for halftime end (triggered by button click)
    listenForHalftimeEnd();
    
    // Play halftime sound
    playUISound("game-start");
  }

  // Listen for halftime end (manual system)
  function listenForHalftimeEnd() {
    // Listen for game state updates to detect when halftime ends
    const halftimeMessageHandler = (data) => {
      console.log("🔄 Halftime listener received message:", data.type, "isHalftime:", data.isHalftime, "status:", data.status);
      
      if (data.type === "game-state" && !data.isHalftime && data.status === "playing") {
        console.log("✅ Halftime has ended, removing overlay");
        // Halftime has ended, remove the overlay
        removeHalftimeStatsOverlay();
      } else if (data.type === "game-state" && data.message === "Starting 2nd Half") {
        console.log("✅ Starting 2nd Half message received, removing overlay");
        // Also remove overlay when we get the specific 2nd half message
        removeHalftimeStatsOverlay();
      }
    };
    
    // Add the handler temporarily
    if (typeof hytopia !== 'undefined' && hytopia.onMessage) {
      hytopia.onMessage(halftimeMessageHandler);
    }
  }

  // Function to start second half (called by button click)
  function startSecondHalf() {
    console.log("🚀 Starting second half...");
    
    // Disable the button to prevent multiple clicks
    const button = document.getElementById('start-second-half-btn');
    if (button) {
      button.disabled = true;
      button.style.opacity = '0.5';
      button.style.cursor = 'not-allowed';
      button.textContent = '⏳ Starting...';
      button.style.animation = 'none'; // Stop the glow animation
      console.log("✅ Button disabled to prevent multiple clicks");
    }
    
    // Send event to server to start second half
    if (typeof hytopia !== 'undefined' && hytopia.sendData) {
      hytopia.sendData({
        type: 'start-second-half'
      });
      console.log("✅ Start second half event sent to server");
      
      // Add a failsafe to remove the overlay after a short delay
      // This ensures the UI responds even if the server message is delayed
      setTimeout(() => {
        console.log("🔄 Failsafe: Removing halftime overlay after 3 seconds");
        removeHalftimeStatsOverlay();
      }, 3000);
      
    } else {
      console.error("❌ Could not send start-second-half event - hytopia not available");
    }
    
    // Play button click sound
    playUISound("button-click");
  }

  // Failsafe function to ensure halftime button is always visible and clickable
  function ensureHalftimeButtonVisible() {
    const button = document.getElementById('start-second-half-btn');
    if (button) {
      // Force all critical styles
      button.style.display = 'inline-block';
      button.style.visibility = 'visible';
      button.style.opacity = '1';
      button.style.pointerEvents = 'auto';
      button.style.cursor = 'pointer';
      button.style.zIndex = '10002';
      button.style.position = 'relative';
      console.log("✅ Halftime button visibility ensured");
      return true;
    }
    console.warn("⚠️ Halftime button not found for visibility check");
    return false;
  }

  // Remove FIRST HALF COMPLETE! overlay
  function removeHalftimeStatsOverlay() {
    console.log("🔄 Attempting to remove FIRST HALF COMPLETE! overlay");
    const overlay = document.getElementById('halftime-stats-overlay');
    if (overlay) {
      console.log("✅ Halftime overlay found, removing with animation");
      overlay.style.animation = 'fadeOut 0.5s ease-out';
      setTimeout(() => {
        if (overlay.parentNode) {
          document.body.removeChild(overlay);
          console.log("✅ Halftime overlay successfully removed from DOM");
        }
      }, 500);
    } else {
      console.log("⚠️ Halftime overlay not found - may have been already removed");
    }
  }

  // Make functions globally accessible
  window.closeGameOverScreen = closeGameOverScreen;
  window.viewStatsToggle = viewStatsToggle;
  window.returnToLobby = returnToLobby;
  window.showHalftimeStats = showHalftimeStats;
  window.startSecondHalf = startSecondHalf;

  // ===== ENSURE ALL ONCLICK FUNCTIONS ARE AVAILABLE =====
  // Make all functions globally accessible to prevent "function not defined" errors
  window.toggleAudio = toggleAudio;
  window.toggleStatsPanel = toggleStatsPanel;
  window.togglePowerUpPanel = togglePowerUpPanel;
  window.selectTeam = selectTeam;
  window.selectGameMode = selectGameMode;
  window.showPlayerTab = showPlayerTab;
  window.closeGameOverScreen = closeGameOverScreen;
  
  // Add any missing functions with safe defaults
  if (typeof window.startPenaltyShootout === 'undefined') {
    window.startPenaltyShootout = function() {
      console.log('Penalty shootout functionality not yet implemented');
      alert('Penalty shootout mode coming soon!');
    };
  }

  // Error handling for any missing functions
  window.addEventListener('error', function(e) {
    if (e.message && e.message.includes('is not defined')) {
      console.warn('Function not defined error caught:', e.message);
      e.preventDefault(); // Prevent the error from breaking the UI
    }
  });

  // ===== HYTOPIA-COMPLIANT UI INITIALIZATION =====
  // No pointer lock blocking needed - server manages this with player.ui.lockPointer()

  // Add universal click handlers for inline onclick buttons
  document.addEventListener('DOMContentLoaded', function() {
    // Simple initialization without fighting Hytopia's pointer lock system
    console.log('🎮 UI initialized - using Hytopia-compliant pointer management');
    
    // Audio toggle button
    const audioToggle = document.getElementById('audio-toggle');
    if (audioToggle) {
      audioToggle.addEventListener('click', (e) => {
        handleButtonClick(e, toggleAudio);
      });
    }

    // Stats toggle button  
    const statsToggle = document.getElementById('stats-toggle');
    if (statsToggle) {
      statsToggle.addEventListener('click', (e) => {
        handleButtonClick(e, toggleStatsPanel);
      });
    }

    // Power-up toggle button
    const powerupToggle = document.getElementById('powerup-toggle');
    if (powerupToggle) {
      powerupToggle.addEventListener('click', (e) => {
        handleButtonClick(e, togglePowerUpPanel);
      });
    }

    // Game mode selection buttons
    const fifaModeBtn = document.getElementById('fifaModeBtn');
    if (fifaModeBtn) {
      fifaModeBtn.addEventListener('click', (e) => {
        handleButtonClick(e, () => selectGameMode('fifa', e));
      });
    }

    const arcadeModeBtn = document.getElementById('arcadeModeBtn');
    if (arcadeModeBtn) {
      arcadeModeBtn.addEventListener('click', (e) => {
        handleButtonClick(e, () => selectGameMode('arcade', e));
      });
    }

    // PICKUP MODE DISABLED FOR NOW
    // const pickupModeBtn = document.getElementById('pickupModeBtn');
    // if (pickupModeBtn) {
    //   pickupModeBtn.addEventListener('click', (e) => {
    //     handleButtonClick(e, () => selectGameMode('pickup', e));
    //   });
    // }

    // Player count selection buttons - NOW HANDLED ABOVE IN MAIN INITIALIZATION
    // Removed duplicate event listeners to prevent conflicts

    // Add event listeners to any other buttons that use onclick
    document.querySelectorAll('button[onclick]').forEach(button => {
      const originalOnclick = button.getAttribute('onclick');
      button.removeAttribute('onclick'); // Remove onclick to prevent conflicts
      
      button.addEventListener('click', (e) => {
        handleButtonClick(e, () => {
          // Safely execute the original onclick content
          try {
            eval(originalOnclick);
          } catch (error) {
            console.warn('Error executing onclick:', error);
          }
        });
      });
    });
  });

  function handleGameReset(data) {
    console.log("Game reset received:", data.message);
    
    // Remove loading overlay if it exists
    const loadingOverlay = document.getElementById('reset-loading-overlay');
    if (loadingOverlay) {
      document.body.removeChild(loadingOverlay);
    }
    
    // Reset UI state to lobby
    const panel = document.getElementById("instructionsPanel");
    // Use the complete instance of game-over-content
    const gameOverElements = document.querySelectorAll("#game-over-content");
    const gameOverContent = gameOverElements[gameOverElements.length - 1];
    const howToPlayContainer = document.querySelector(".how-to-play-container");
    const teamSelection = document.querySelector(".team-selection");
    const gameModeSelection = document.getElementById("gameModeSelection");
    const selectedModeInfo = document.getElementById("selectedModeInfo");
    
    // Reset game mode selection
    selectedGameMode = null;
    document.querySelectorAll('.game-mode-btn').forEach(btn => {
      btn.classList.remove('selected');
    });
    if (selectedModeInfo) selectedModeInfo.style.display = "none";
    
    // Clear team selection
    document.querySelectorAll('.team-btn').forEach(btn => {
      btn.classList.remove('selected');
    });
    
    // Show lobby UI
    gameOverContent.style.display = "none";
    if (howToPlayContainer) howToPlayContainer.style.display = "block";
    if (gameModeSelection) gameModeSelection.style.display = "block";
    if (teamSelection) teamSelection.style.display = "none"; // Hide until mode is selected again
    
    // Reset main scoreboard
    const mainScoreboard = document.getElementById("main-scoreboard");
    if (mainScoreboard) {
      mainScoreboard.style.display = "flex";
    }
    initializeScoreDisplay();
    
    // Show success notification with better styling
    showSuccessNotification(data.message || "Game reset successfully! Ready for a new match.");
    
    playUISound("button-click");
  }

  function showSuccessNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.2);
      animation: slideInDown 0.5s ease-out;
    `;
    
    notification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">✅</span>
        <span>${message}</span>
      </div>
    `;
    
      document.body.appendChild(notification);
      
    setTimeout(() => {
      notification.style.animation = 'slideOutUp 0.5s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 3000);
    }

  // ===== ARCADE MODE POWER-UP SYSTEM FUNCTIONS =====
  
  // Power-up cooldowns (in milliseconds)
  const POWERUP_COOLDOWNS = {
    'freeze_blast': 10000,    // 10 seconds
      
    'fireball': 12000,        // 12 seconds
    'mega_kick': 15000,       // 15 seconds
          'random_powerup': 3000    // 3 seconds for random activation
  };

  // Track cooldown states
  const powerupCooldownStates = {
    'freeze_blast': { onCooldown: false, endTime: 0 },
    
    'fireball': { onCooldown: false, endTime: 0 },
    'mega_kick': { onCooldown: false, endTime: 0 },
    'random_powerup': { onCooldown: false, endTime: 0 }
  };

  // Enhanced power-up activation with visual effects
  function activatePowerUpWithEffects(powerUpType) {
    const button = document.getElementById(`${powerUpType.replace('_', '-')}-btn`);
    if (!button) return false;

    // Check if on cooldown
    if (powerupCooldownStates[powerUpType] && powerupCooldownStates[powerUpType].onCooldown) {
      showPowerUpFeedback('Power-up on cooldown!', 'error');
      return false;
    }

    // Add activation animation
    button.classList.add('activating');
    
    // Create ripple effect
    createRippleEffect(button);
    
    // Add glow effect temporarily
    const glowElement = document.createElement('div');
    glowElement.className = 'powerup-glow';
    button.appendChild(glowElement);
    
    // Remove effects after animation
    setTimeout(() => {
      button.classList.remove('activating');
      if (glowElement.parentNode) {
        glowElement.parentNode.removeChild(glowElement);
      }
    }, 800);

    // Send activation to server
    if (typeof hytopia !== 'undefined' && hytopia.sendData) {
      hytopia.sendData({
        type: "activate-powerup",
        powerUpType: powerUpType
      });
    }

    // Start cooldown
    startPowerUpCooldown(powerUpType);
    
    // Show activation feedback
    showPowerUpActivationEffect(powerUpType);
    
    return true;
  }

  // Create ripple effect on button click
  function createRippleEffect(button) {
    const ripple = document.createElement('div');
    ripple.className = 'powerup-ripple';
    
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = rect.width / 2 - size / 2;
    const y = rect.height / 2 - size / 2;
    
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    
    button.appendChild(ripple);
    
    setTimeout(() => {
      if (ripple.parentNode) {
        ripple.parentNode.removeChild(ripple);
      }
    }, 600);
  }

  // Enhanced power-up activation effect
  function showPowerUpActivationEffect(powerUpType) {
    const effectDisplay = document.getElementById('powerup-effect-display');
    if (!effectDisplay) return;

    const powerUpEmojis = {
      'freeze_blast': '🧊 FREEZE!',
      
      'fireball': '🔥 FIREBALL!',
      'mega_kick': '⚽ MEGA KICK!',
      'random_powerup': '🎲 RANDOM!'
    };

    effectDisplay.textContent = powerUpEmojis[powerUpType] || '✨ POWER-UP!';
    effectDisplay.style.display = 'block';
    
    // Reset animation
    effectDisplay.style.animation = 'none';
    effectDisplay.offsetHeight; // Trigger reflow
    effectDisplay.style.animation = 'powerup-effect-flash 2.5s ease-out';
    
    setTimeout(() => {
      effectDisplay.style.display = 'none';
    }, 2500);
  }

  // Enhanced cooldown management
  function startPowerUpCooldown(powerUpType) {
    const cooldownTime = POWERUP_COOLDOWNS[powerUpType] || 5000;
    const endTime = Date.now() + cooldownTime;
    
    powerupCooldownStates[powerUpType] = {
      onCooldown: true,
      endTime: endTime
    };

    const button = document.getElementById(`${powerUpType.replace('_', '-')}-btn`);
    const overlay = document.getElementById(`${powerUpType.replace('_', '-')}-cooldown`);
    
    if (button) {
      button.classList.add('on-cooldown');
    }

    // Update cooldown display
    updateCooldownDisplay(powerUpType, cooldownTime);
  }

  // Update cooldown visual display
  function updateCooldownDisplay(powerUpType, totalTime) {
    const overlay = document.getElementById(`${powerUpType.replace('_', '-')}-cooldown`);
    const button = document.getElementById(`${powerUpType.replace('_', '-')}-btn`);
    
    if (!overlay || !button) return;

    const updateInterval = setInterval(() => {
      const now = Date.now();
      const endTime = powerupCooldownStates[powerUpType].endTime;
      const remaining = Math.max(0, endTime - now);
      const progress = 1 - (remaining / totalTime);
      
      // Update conic gradient
      overlay.style.background = `conic-gradient(from 0deg, transparent ${progress * 360}deg, rgba(0, 0, 0, 0.8) ${progress * 360}deg)`;
      
      // Show remaining time
      const remainingSeconds = Math.ceil(remaining / 1000);
      if (remainingSeconds > 0) {
        overlay.textContent = remainingSeconds;
      } else {
        overlay.textContent = '';
      }

      if (remaining <= 0) {
        clearInterval(updateInterval);
        
        // Reset cooldown state
        powerupCooldownStates[powerUpType] = { onCooldown: false, endTime: 0 };
        
        // Reset visual state
        button.classList.remove('on-cooldown');
        button.classList.add('ready');
        overlay.style.background = 'transparent';
        overlay.textContent = '';
        
        // Add ready glow effect
        setTimeout(() => {
          button.classList.remove('ready');
        }, 3000);
        
        // Show ready notification
        showPowerUpFeedback(`${powerUpType.replace('_', ' ').toUpperCase()} Ready!`, 'success');
      }
    }, 100);
  }

  // Show power-up feedback messages
  function showPowerUpFeedback(message, type = 'info') {
    const feedback = document.createElement('div');
    feedback.style.cssText = `
      position: fixed;
      top: 120px;
      right: 20px;
      background: ${type === 'error' ? 'rgba(220, 53, 69, 0.9)' : type === 'success' ? 'rgba(40, 167, 69, 0.9)' : 'rgba(255, 193, 7, 0.9)'};
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      z-index: 10001;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border: 2px solid ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#ffc107'};
      animation: slideInRight 0.3s ease;
    `;
    
    feedback.textContent = message;
    document.body.appendChild(feedback);
    
    setTimeout(() => {
      feedback.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        if (feedback.parentNode) {
          document.body.removeChild(feedback);
        }
      }, 300);
    }, 2000);
  }

  // Show arcade mode UI when in arcade mode (enhanced)
  function showArcadeModeUI() {
    const indicator = document.getElementById('arcade-mode-indicator');
    const container = document.getElementById('powerup-container');
    
    if (indicator) {
      indicator.classList.add('visible');
    }
    if (container) {
      container.style.display = 'flex';
      
      // Add entrance animation for power-up buttons
      const buttons = container.querySelectorAll('.powerup-button');
      buttons.forEach((button, index) => {
        button.style.opacity = '0';
        button.style.transform = 'scale(0.5) translateY(20px)';
        setTimeout(() => {
          button.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
          button.style.opacity = '1';
          button.style.transform = 'scale(1) translateY(0)';
        }, index * 100);
      });
    }
    
    // Set up keyboard controls
    setupPowerupKeyboardControls();
    
    // Initialize enhanced visual effects
    initializeEnhancedPowerUpSystem();
    
    console.log('🎪 Enhanced Arcade Mode UI activated!');
  }

  // Initialize enhanced power-up system
  function initializeEnhancedPowerUpSystem() {
    // Reset all cooldown states
    Object.keys(powerupCooldownStates).forEach(powerUp => {
      powerupCooldownStates[powerUp] = { onCooldown: false, endTime: 0 };
      
      // Reset button states
      const button = document.getElementById(`${powerUp.replace('_', '-')}-btn`);
      if (button) {
        button.classList.remove('on-cooldown', 'activating', 'ready');
        
        // Add ready glow effect for available power-ups
        setTimeout(() => {
          if (!powerupCooldownStates[powerUp].onCooldown) {
            button.classList.add('ready');
            setTimeout(() => button.classList.remove('ready'), 2000);
          }
        }, 1000);
      }
    });
    
    console.log('✨ Enhanced power-up system initialized');
  }

  // Hide arcade mode UI when in FIFA mode
  function hideArcadeModeUI() {
    const indicator = document.getElementById('arcade-mode-indicator');
    const container = document.getElementById('powerup-container');
    
    if (indicator) {
      indicator.classList.remove('visible');
    }
    if (container) {
      container.style.display = 'none';
    }
    
    console.log('🏆 FIFA Mode - Power-up UI hidden');
  }

  // Set up keyboard controls for power-ups
  function setupPowerupKeyboardControls() {
    document.addEventListener('keydown', function(event) {
      // Only handle power-up keys when arcade mode UI is visible
      const container = document.getElementById('powerup-container');
      if (!container || container.style.display === 'none') {
        return;
      }

      switch(event.key) {
        case '1':
          event.preventDefault();
          activatePowerUp('freeze_blast');
          break;
        case '2':
          event.preventDefault();
          activatePowerUp('speed');
          break;
        case '3':
          event.preventDefault();
          activatePowerUp('fireball');
          break;
        case '4':
          event.preventDefault();
          activatePowerUp('mega_kick');
          break;
        case '5':
          event.preventDefault();
          activatePowerUp('power');
          break;
        case '6':
          event.preventDefault();
          activatePowerUp('precision');
          break;
        case '7':
          event.preventDefault();
          activatePowerUp('stamina');
          break;
        case '8':
          event.preventDefault();
          activatePowerUp('shuriken');
          break;
        // F key removed - now used for teammate pass requests in game controller
        case 'u':
        case 'U':
          event.preventDefault();
          activatePowerUp('shield');
          break;
      }
    });
  }

  // Activate specific power-up (enhanced version)
  function activatePowerUp(powerUpType) {
    console.log(`🎮 Attempting to activate power-up: ${powerUpType}`);
    
    // Use the enhanced activation system
    const success = activatePowerUpWithEffects(powerUpType);
    
    if (success) {
      playUISound("button-click");
    }
  }

      // Activate random power-up (UI button functionality) - enhanced version
  function activateRandomPowerUp() {
    console.log(`🎲 Attempting to activate random power-up`);
    
    // Use the enhanced activation system
    const success = activatePowerUpWithEffects('random_powerup');
    
    if (success) {
      playUISound("button-click");
    }
  }

  // Start cooldown for a power-up
  function startPowerupCooldown(powerUpType) {
    const cooldownDuration = POWERUP_COOLDOWNS[powerUpType] || 3000;
    const cooldownState = powerupCooldownStates[powerUpType];
    
    if (cooldownState) {
      cooldownState.onCooldown = true;
      cooldownState.endTime = Date.now() + cooldownDuration;
      
      // Update button visual state
      updatePowerupButtonState(powerUpType, true);
      
      // Start cooldown visual countdown
      startCooldownAnimation(powerUpType, cooldownDuration);
      
      // Clear cooldown after duration
      setTimeout(() => {
        cooldownState.onCooldown = false;
        updatePowerupButtonState(powerUpType, false);
      }, cooldownDuration);
    }
  }

  // Update power-up button visual state
  function updatePowerupButtonState(powerUpType, onCooldown) {
    const buttonId = getPowerupButtonId(powerUpType);
    const button = document.getElementById(buttonId);
    
    if (button) {
      if (onCooldown) {
        button.classList.add('on-cooldown');
      } else {
        button.classList.remove('on-cooldown');
      }
    }
  }

  // Get button ID for power-up type
  function getPowerupButtonId(powerUpType) {
    const buttonMap = {
      'freeze_blast': 'freeze-blast-btn',
      'fireball': 'fireball-btn',
      'mega_kick': 'mega-kick-btn',
      'random_powerup': 'random-powerup-btn',
      'shield': 'shield-btn',
      'stamina': 'stamina-btn',
      'speed': 'speed-btn',
      'power': 'power-btn',
      'precision': 'precision-btn',
      'shuriken': 'shuriken-btn'
    };
    return buttonMap[powerUpType] || 'random-powerup-btn';
  }

  // Get human-readable power-up name
  function getPowerupName(powerUpType) {
    const nameMap = {
      'freeze_blast': 'Freeze Blast',
      'fireball': 'Fireball',
      'mega_kick': 'Mega Kick',
      'random_powerup': 'Random Power-up',
      'shield': 'Shield',
      'stamina': 'Stamina Potion',
      'speed': 'Speed Boost',
      'power': 'Power Enhancement',
      'precision': 'Precision Boost',
      'shuriken': 'Shuriken Throw'
    };
    return nameMap[powerUpType] || 'Unknown Power-up';
  }

  // Start cooldown animation
  function startCooldownAnimation(powerUpType, duration) {
    const overlayId = powerUpType.replace('_', '-') + '-cooldown';
    const overlay = document.getElementById(overlayId);
    
    if (!overlay) return;
    
    let startTime = Date.now();
    
    function updateCooldown() {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const degrees = 360 * (1 - progress);
      
      overlay.style.background = `conic-gradient(from 0deg, transparent ${degrees}deg, rgba(0, 0, 0, 0.7) ${degrees}deg)`;
      
      if (progress < 1) {
        requestAnimationFrame(updateCooldown);
      } else {
        overlay.style.background = 'conic-gradient(from 0deg, transparent 0%, rgba(0, 0, 0, 0.7) 0%)';
      }
    }
    
    requestAnimationFrame(updateCooldown);
  }

  // Show power-up activation visual feedback
  function showPowerupActivation(powerUpType) {
    const buttonId = getPowerupButtonId(powerUpType);
    const button = document.getElementById(buttonId);
    
    if (button) {
      button.classList.add('activating');
      setTimeout(() => {
        button.classList.remove('activating');
      }, 600);
    }
    
    // Show center screen effect
    const effectDisplay = document.getElementById('powerup-effect-display');
    if (effectDisplay) {
      const powerupName = getPowerupName(powerUpType);
      const powerupIcon = getPowerupIcon(powerUpType);
      
      effectDisplay.textContent = `${powerupIcon} ${powerupName.toUpperCase()} ACTIVATED!`;
      effectDisplay.style.display = 'block';
      
      setTimeout(() => {
        effectDisplay.style.display = 'none';
      }, 2000);
    }
  }

  // Get power-up icon
  function getPowerupIcon(powerUpType) {
    const iconMap = {
      'freeze_blast': '🧊',
      'fireball': '🔥',
      'mega_kick': '⚽',
      'random_powerup': '🎲',
      'shield': '🛡️',
      'stamina': '🧪',
      'speed': '⚡',
      'power': '💥',
      'precision': '🎯',
      'shuriken': '🥷'
    };
    return iconMap[powerUpType] || '⚡';
  }

  // Enhanced powerup feedback function
  function showPowerupFeedback(data) {
    console.log("Powerup feedback received:", data);
    
    let notification = document.getElementById("powerup-notification");
    
    if (!notification) {
      notification = document.createElement('div');
      notification.id = "powerup-notification";
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        z-index: 5000;
        text-align: center;
        border: 2px solid;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      document.body.appendChild(notification);
    }
    
    // Set colors based on success
    if (data.success) {
      notification.style.borderColor = '#4CAF50';
      notification.style.background = 'rgba(76, 175, 80, 0.2)';
      notification.style.color = '#4CAF50';
    } else {
      notification.style.borderColor = '#f44336';
      notification.style.background = 'rgba(244, 67, 54, 0.2)';
      notification.style.color = '#f44336';
    }
    
    // Set message
    let message = data.message || '';
    if (data.powerUpType && data.success) {
      const icon = getPowerupIcon(data.powerUpType);
      const name = getPowerupName(data.powerUpType);
      message = `${icon} ${name.toUpperCase()} ACTIVATED!`;
    }
    
    notification.textContent = message;
    notification.style.opacity = '1';
    
    // Hide after delay
    setTimeout(() => {
      notification.style.opacity = '0';
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 300);
    }, data.success ? 2000 : 3000);
  }

  // Forced pass function
  function forcePassToTeammate() {
    console.log("🎯 Forced pass button clicked");
    
    // Send a left mouse click simulation to trigger the pass
    hytopia.sendData({
      type: "force-pass",
      action: "pass-to-teammate"
    });
    
    // Show feedback
    showActionFeedback("info", "Pass", "Attempting pass to teammate...");
    
    playUISound("button-click");
  }



  // Make functions globally accessible
  window.activatePowerUp = activatePowerUp;
  window.activateRandomPowerUp = activateRandomPowerUp;
  window.showArcadeModeUI = showArcadeModeUI;
  window.hideArcadeModeUI = hideArcadeModeUI;
  window.showPowerupFeedback = showPowerupFeedback;
  window.forcePassToTeammate = forcePassToTeammate;

  // ===== PHASE 1 MOBILE CONTROLS SYSTEM (HYTOPIA SDK COMPLIANT) =====
  
  // Mobile device detection and initialization
  let isMobileDevice = false;
  let mobileControlsInitialized = false;
  
  // Virtual joystick state
  let joystickActive = false;
  let joystickCenter = { x: 0, y: 0 };
  let joystickInput = { x: 0, y: 0 };
  
  // Mobile input state
  let mobileInputState = {
    movement: { x: 0, y: 0 },
    actions: {
      shooting: false,
      passing: false,
      tackling: false,
      dodging: false
    }
  };
  
  // Enhanced device detection function
  function detectMobileDevice() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
    const touchCapable = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const screenWidth = window.innerWidth || document.documentElement.clientWidth;
    
    // Multiple detection methods for better reliability
    const isMobileUA = mobileRegex.test(userAgent.toLowerCase());
    const isMobileScreen = screenWidth <= 768;
    const isTouchDevice = touchCapable;
    const isSmallScreen = screenWidth <= 1024 && window.innerHeight <= 768;
    
    // Consider it mobile if any of these conditions are true
    isMobileDevice = isMobileUA || (isTouchDevice && isMobileScreen) || (isTouchDevice && isSmallScreen);
    
    console.log('📱 Enhanced mobile device detection:', {
      userAgent: userAgent,
      isMobile: isMobileDevice,
      isMobileUA: isMobileUA,
      touchCapable: isTouchDevice,
      screenWidth: screenWidth,
      screenHeight: window.innerHeight,
      reason: isMobileUA ? 'User Agent' : isTouchDevice && isMobileScreen ? 'Touch + Screen Size' : isTouchDevice && isSmallScreen ? 'Touch + Small Screen' : 'Not Mobile'
    });
    
    return isMobileDevice;
  }
  
  // Initialize mobile controls
  function initializeMobileControls() {
    if (mobileControlsInitialized || !detectMobileDevice()) {
      return;
    }
    
    console.log('📱 Initializing mobile controls...');
    
    // Create mobile controls container
    const mobileControlsContainer = document.createElement('div');
    mobileControlsContainer.id = 'mobile-controls-container';
    mobileControlsContainer.className = 'mobile-controls mobile-active';
    
    // Force visibility for mobile devices
    mobileControlsContainer.style.display = 'block';
    mobileControlsContainer.style.visibility = 'visible';
    
    // Create virtual joystick
    const virtualJoystick = document.createElement('div');
    virtualJoystick.className = 'virtual-joystick';
    virtualJoystick.id = 'virtual-joystick';
    
    const joystickKnob = document.createElement('div');
    joystickKnob.className = 'joystick-knob';
    joystickKnob.id = 'joystick-knob';
    
    virtualJoystick.appendChild(joystickKnob);
    
    // Create action buttons
    const mobileActions = document.createElement('div');
    mobileActions.className = 'mobile-actions';
    
    // Shoot button (Hytopia-compliant with onclick attributes)
    const shootButton = document.createElement('button');
    shootButton.className = 'mobile-action-btn primary';
    shootButton.id = 'mobile-shoot-btn';
    shootButton.textContent = 'KICK';
    shootButton.setAttribute('ontouchstart', 'handleMobileAction("shoot", true)');
    shootButton.setAttribute('ontouchend', 'handleMobileAction("shoot", false)');
    shootButton.setAttribute('onclick', 'handleMobileQuickAction("shoot")');
    
    // Pass button (Hytopia-compliant with onclick attributes)
    const passButton = document.createElement('button');
    passButton.className = 'mobile-action-btn secondary';
    passButton.id = 'mobile-pass-btn';
    passButton.textContent = 'PASS';
    passButton.setAttribute('ontouchstart', 'handleMobileAction("pass", true)');
    passButton.setAttribute('ontouchend', 'handleMobileAction("pass", false)');
    passButton.setAttribute('onclick', 'handleMobileQuickAction("pass")');
    
    // Tackle button (Hytopia-compliant with onclick attributes)
    const tackleButton = document.createElement('button');
    tackleButton.className = 'mobile-action-btn';
    tackleButton.id = 'mobile-tackle-btn';
    tackleButton.textContent = 'TACKLE';
    tackleButton.setAttribute('ontouchstart', 'handleMobileAction("tackle", true)');
    tackleButton.setAttribute('ontouchend', 'handleMobileAction("tackle", false)');
    tackleButton.setAttribute('onclick', 'handleMobileQuickAction("tackle")');
    
    // Dodge button (Hytopia-compliant with onclick attributes)
    const dodgeButton = document.createElement('button');
    dodgeButton.className = 'mobile-action-btn';
    dodgeButton.id = 'mobile-dodge-btn';
    dodgeButton.textContent = 'DODGE';
    dodgeButton.setAttribute('ontouchstart', 'handleMobileAction("dodge", true)');
    dodgeButton.setAttribute('ontouchend', 'handleMobileAction("dodge", false)');
    dodgeButton.setAttribute('onclick', 'handleMobileQuickAction("dodge")');
    
    // Add buttons to actions container
    mobileActions.appendChild(shootButton);
    mobileActions.appendChild(passButton);
    mobileActions.appendChild(tackleButton);
    mobileActions.appendChild(dodgeButton);
    
    // Create mobile performance indicator
    const performanceIndicator = document.createElement('div');
    performanceIndicator.className = 'mobile-performance-indicator';
    performanceIndicator.id = 'mobile-performance-indicator';
    performanceIndicator.textContent = 'Mobile Mode';
    
    // Add all elements to container
    mobileControlsContainer.appendChild(virtualJoystick);
    mobileControlsContainer.appendChild(mobileActions);
    mobileControlsContainer.appendChild(performanceIndicator);
    
    // Add container to document
    document.body.appendChild(mobileControlsContainer);
    
    // Initialize joystick event handling
    initializeJoystickEvents();
    
    // Notify server about mobile mode
    hytopia.sendData({
      type: "mobile-mode-enabled",
      deviceInfo: {
        userAgent: navigator.userAgent,
        screenWidth: window.innerWidth,
        screenHeight: window.innerHeight,
        touchCapable: 'ontouchstart' in window,
        devicePixelRatio: window.devicePixelRatio || 1
      }
    });
    
    mobileControlsInitialized = true;
    console.log('✅ Mobile controls initialized successfully');
  }
  
  // Initialize joystick touch events
  function initializeJoystickEvents() {
    const joystick = document.getElementById('virtual-joystick');
    const knob = document.getElementById('joystick-knob');
    
    if (!joystick || !knob) return;
    
    // Store joystick center position
    const joystickRect = joystick.getBoundingClientRect();
    joystickCenter = {
      x: joystickRect.left + joystickRect.width / 2,
      y: joystickRect.top + joystickRect.height / 2
    };
    
    // Touch start
    joystick.addEventListener('touchstart', function(e) {
      e.preventDefault();
      joystickActive = true;
      updateJoystickPosition(e.touches[0]);
    });
    
    // Touch move
    joystick.addEventListener('touchmove', function(e) {
      e.preventDefault();
      if (joystickActive) {
        updateJoystickPosition(e.touches[0]);
      }
    });
    
    // Touch end
    joystick.addEventListener('touchend', function(e) {
      e.preventDefault();
      joystickActive = false;
      resetJoystick();
    });
    
    // Update joystick center on window resize
    window.addEventListener('resize', function() {
      const joystickRect = joystick.getBoundingClientRect();
      joystickCenter = {
        x: joystickRect.left + joystickRect.width / 2,
        y: joystickRect.top + joystickRect.height / 2
      };
    });
  }
  
  // Handle mobile action quick press (for onclick events) - Hytopia-compliant
  function handleMobileQuickAction(action) {
    console.log(`📱 Quick action: ${action}`);
    // Simulate press and release for onclick events
    handleMobileAction(action, true);
    setTimeout(function() {
      handleMobileAction(action, false);
    }, 100);
  }
  
  // Update joystick position and input
  function updateJoystickPosition(touch) {
    const knob = document.getElementById('joystick-knob');
    if (!knob) return;
    
    const deltaX = touch.clientX - joystickCenter.x;
    const deltaY = touch.clientY - joystickCenter.y;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    const maxDistance = 40; // Max knob movement distance
    
    if (distance <= maxDistance) {
      knob.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
      joystickInput.x = deltaX / maxDistance;
      joystickInput.y = deltaY / maxDistance;
    } else {
      const angle = Math.atan2(deltaY, deltaX);
      const limitedX = Math.cos(angle) * maxDistance;
      const limitedY = Math.sin(angle) * maxDistance;
      
      knob.style.transform = `translate(${limitedX}px, ${limitedY}px)`;
      joystickInput.x = limitedX / maxDistance;
      joystickInput.y = limitedY / maxDistance;
    }
    
    // Update mobile input state
    mobileInputState.movement.x = joystickInput.x;
    mobileInputState.movement.y = -joystickInput.y; // Invert Y for game coordinates
    
    // Send movement data to server
    hytopia.sendData({
      type: "mobile-movement-input",
      movement: mobileInputState.movement
    });
  }
  
  // Reset joystick to center
  function resetJoystick() {
    const knob = document.getElementById('joystick-knob');
    if (knob) {
      knob.style.transform = 'translate(0px, 0px)';
    }
    
    joystickInput.x = 0;
    joystickInput.y = 0;
    mobileInputState.movement.x = 0;
    mobileInputState.movement.y = 0;
    
    // Send stop movement to server
    hytopia.sendData({
      type: "mobile-movement-input",
      movement: { x: 0, y: 0 }
    });
  }
  
  // Handle mobile action button presses with enhanced error handling
  function handleMobileAction(action, pressed) {
    try {
      console.log(`📱 Mobile action: ${action} ${pressed ? 'pressed' : 'released'}`);
      
      // Update input state
      const actionKey = action === 'shoot' ? 'shooting' : 
                       action === 'pass' ? 'passing' : 
                       action === 'tackle' ? 'tackling' : 'dodging';
      
      if (mobileInputState && mobileInputState.actions) {
        mobileInputState.actions[actionKey] = pressed;
      }
      
      // Send action to server with error handling
      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        hytopia.sendData({
          type: "mobile-action-input",
          action: action,
          pressed: pressed,
          timestamp: Date.now()
        });
      } else {
        console.warn('📱 Hytopia not available for mobile action:', action);
      }
      
      // Visual feedback with error handling
      if (pressed) {
        try {
          if (typeof playUISound === 'function') {
            playUISound('button-click');
          }
        } catch (soundError) {
          console.warn('📱 Sound error:', soundError);
        }
        
        // Add visual feedback to button
        const button = document.getElementById(`mobile-${action}-btn`);
        if (button) {
          button.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
          setTimeout(() => {
            if (action === 'shoot') {
              button.style.backgroundColor = 'rgba(0, 123, 255, 0.8)';
            } else if (action === 'pass') {
              button.style.backgroundColor = 'rgba(40, 167, 69, 0.8)';
            } else {
              button.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            }
          }, 200);
        }
      }
      
      console.log(`📱 Mobile action processed successfully: ${action}`);
      
    } catch (error) {
      console.error('📱 Error handling mobile action:', error);
    }
  }
  
  // Auto-initialize mobile controls when page loads (Multiple attempts for reliability)
  document.addEventListener('DOMContentLoaded', function() {
    console.log('📱 DOM loaded - attempting mobile controls initialization');
    setTimeout(initializeMobileControls, 500);
    setTimeout(initializeMobileControls, 1000);
    setTimeout(initializeMobileControls, 2000);
  });
  
  // Also try to initialize on window load
  window.addEventListener('load', function() {
    console.log('📱 Window loaded - attempting mobile controls initialization');
    setTimeout(initializeMobileControls, 100);
    setTimeout(initializeMobileControls, 1000);
  });
  
  // Additional backup initialization after Hytopia connects
  setTimeout(function() {
    console.log('📱 Backup initialization attempt');
    if (!mobileControlsInitialized && detectMobileDevice()) {
      initializeMobileControls();
    }
  }, 3000);
  
  // Force initialization for mobile devices - emergency backup
  setInterval(function() {
    if (!mobileControlsInitialized && detectMobileDevice()) {
      console.log('📱 Emergency backup initialization triggered');
      initializeMobileControls();
    }
  }, 5000);
  
  // Test mobile controls function (for debugging)
  function testMobileControls() {
    console.log('📱 Testing mobile controls...');
    
    // Force mobile detection
    isMobileDevice = true;
    
    // Force initialization
    mobileControlsInitialized = false;
    initializeMobileControls();
    
    // Test button visibility
    const controls = document.getElementById('mobile-controls-container');
    if (controls) {
      controls.style.display = 'block';
      controls.style.visibility = 'visible';
      controls.style.zIndex = '99999';
      console.log('📱 Mobile controls forced visible');
      
      // Add red debug border
      controls.style.border = '3px solid red';
      setTimeout(() => {
        controls.style.border = 'none';
      }, 3000);
      
      // Test button events (Hytopia-compliant onclick)
      setTimeout(() => {
        console.log('📱 Testing button events...');
        const shootBtn = document.getElementById('mobile-shoot-btn');
        if (shootBtn) {
          console.log('📱 Simulating shoot button click (Hytopia-compliant)...');
          handleMobileQuickAction('shoot');
        }
      }, 1000);
      
      return 'Mobile controls test completed - should be visible now with button test';
    } else {
      console.error('📱 Mobile controls container not found');
      return 'Mobile controls container not found';
    }
  }
  
  // Check mobile controls status
  function checkMobileControlsStatus() {
    const shootButton = document.getElementById('mobile-shoot-btn');
    const status = {
      isMobileDevice: isMobileDevice,
      controlsInitialized: mobileControlsInitialized,
      controlsContainer: !!document.getElementById('mobile-controls-container'),
      joystick: !!document.getElementById('virtual-joystick'),
      shootButton: !!shootButton,
      passButton: !!document.getElementById('mobile-pass-btn'),
      tackleButton: !!document.getElementById('mobile-tackle-btn'),
      dodgeButton: !!document.getElementById('mobile-dodge-btn'),
      screenWidth: window.innerWidth,
      screenHeight: window.innerHeight,
      touchCapable: 'ontouchstart' in window,
      hytopiaAvailable: typeof hytopia !== 'undefined',
      buttonEventsSet: shootButton ? (shootButton.getAttribute('onclick') && shootButton.getAttribute('ontouchstart')) : false
    };
    
    console.log('📱 Mobile Controls Status:', status);
    
    // Test button events if available (Hytopia-compliant)
    if (shootButton) {
      console.log('📱 Testing shoot button event setup (Hytopia-compliant)...');
      console.log('📱 Shoot button onclick:', shootButton.getAttribute('onclick'));
      console.log('📱 Shoot button ontouchstart:', shootButton.getAttribute('ontouchstart'));
      console.log('📱 Shoot button ontouchend:', shootButton.getAttribute('ontouchend'));
    }
    
    return status;
  }
  
  // Make mobile functions globally accessible (Hytopia-compliant)
  window.initializeMobileControls = initializeMobileControls;
  window.handleMobileAction = handleMobileAction;
  window.handleMobileQuickAction = handleMobileQuickAction;
  window.detectMobileDevice = detectMobileDevice;
  window.testMobileControls = testMobileControls;
  window.checkMobileControlsStatus = checkMobileControlsStatus;

  // ===== TOURNAMENT SYSTEM FUNCTIONS =====

  // Tournament Creation Handler
  function handleTournamentCreation(e) {
    try {
      console.log('🏆 Creating tournament...');
      
      // Get form values
      const tournamentName = document.getElementById("tournamentName").value.trim();
      const tournamentType = document.getElementById("tournamentType").value;
      const maxPlayers = parseInt(document.getElementById("tournamentMaxPlayers").value);
      const gameMode = document.getElementById("tournamentGameMode").value;
      const registrationTime = parseInt(document.getElementById("tournamentRegistrationTime").value);

      // Validate form data
      if (!tournamentName) {
        showTournamentError("Please enter a tournament name");
        return;
      }

      if (tournamentName.length < 3) {
        showTournamentError("Tournament name must be at least 3 characters");
        return;
      }

      if (tournamentName.length > 30) {
        showTournamentError("Tournament name must be 30 characters or less");
        return;
      }

      // Disable button to prevent double submission
      const button = document.getElementById("createTournamentBtn");
      if (button) {
        button.disabled = true;
        button.textContent = "Creating...";
      }

      // Send tournament creation request to server
      const tournamentData = {
        type: "tournament-create",
        name: tournamentName,
        tournamentType: tournamentType,
        maxPlayers: maxPlayers,
        gameMode: gameMode,
        registrationTime: registrationTime
      };

      console.log('🏆 Sending tournament creation data:', tournamentData);

      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        hytopia.sendData(tournamentData);
      } else {
        console.error('❌ Hytopia not available for tournament creation');
        showTournamentError("Connection error - please try again");
        
        // Re-enable button
        if (button) {
          button.disabled = false;
          button.textContent = "🏆 Create Tournament";
        }
      }

    } catch (error) {
      console.error('❌ Tournament creation error:', error);
      showTournamentError("Failed to create tournament - please try again");
      
      // Re-enable button
      const button = document.getElementById("createTournamentBtn");
      if (button) {
        button.disabled = false;
        button.textContent = "🏆 Create Tournament";
      }
    }
  }

  // Tournament Join Handler
  function handleTournamentJoin(e) {
    try {
      console.log('🏆 Joining tournament...');
      
      // Get the active tournament ID (would be set when tournament list is displayed)
      const selectedTournamentId = window.selectedTournamentId;
      
      if (!selectedTournamentId) {
        showTournamentError("No tournament selected");
        return;
      }

      // Send join request to server
      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        hytopia.sendData({
          type: "tournament-join",
          tournamentId: selectedTournamentId
        });
      } else {
        console.error('❌ Hytopia not available for tournament join');
        showTournamentError("Connection error - please try again");
      }

    } catch (error) {
      console.error('❌ Tournament join error:', error);
      showTournamentError("Failed to join tournament - please try again");
    }
  }

  // Tournament Leave Handler
  function handleTournamentLeave(e) {
    try {
      console.log('🏆 Leaving tournament...');
      
      // Get the current tournament ID
      const currentTournamentId = window.currentTournamentId;
      
      if (!currentTournamentId) {
        showTournamentError("No tournament to leave");
        return;
      }

      // Send leave request to server
      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        hytopia.sendData({
          type: "tournament-leave",
          tournamentId: currentTournamentId
        });
      } else {
        console.error('❌ Hytopia not available for tournament leave');
        showTournamentError("Connection error - please try again");
      }

    } catch (error) {
      console.error('❌ Tournament leave error:', error);
      showTournamentError("Failed to leave tournament - please try again");
    }
  }

  // Ready Check Confirm Handler
  function handleReadyConfirm(e) {
    try {
      console.log('🏆 Confirming ready for match...');
      
      // Get the current tournament and match info
      const currentTournamentId = window.currentTournamentId;
      const currentMatchId = window.currentMatchId;
      
      if (!currentTournamentId || !currentMatchId) {
        showTournamentError("No active match found");
        return;
      }

      // Send ready confirmation to server
      if (typeof hytopia !== 'undefined' && hytopia.sendData) {
        hytopia.sendData({
          type: "tournament-ready",
          tournamentId: currentTournamentId,
          matchId: currentMatchId,
          ready: true
        });
      } else {
        console.error('❌ Hytopia not available for ready check');
        showTournamentError("Connection error - please try again");
      }

    } catch (error) {
      console.error('❌ Ready check error:', error);
      showTournamentError("Failed to confirm ready - please try again");
    }
  }

  // Back to Lobby Handler
  function handleBackToLobby(e) {
    try {
      console.log('🏆 Returning to lobby...');
      
      // Hide tournament UI and show main lobby
      const tournamentSelection = document.getElementById("tournamentSelection");
      const tournamentLobby = document.getElementById("tournamentLobby");
      const mainGameModes = document.getElementById("game-modes");
      
      if (tournamentSelection) tournamentSelection.style.display = "none";
      if (tournamentLobby) tournamentLobby.style.display = "none";
      if (mainGameModes) mainGameModes.style.display = "block";
      
      // Clear tournament state
      window.selectedTournamentId = null;
      window.currentTournamentId = null;
      window.currentMatchId = null;
      
      console.log('✅ Returned to main lobby');

    } catch (error) {
      console.error('❌ Back to lobby error:', error);
    }
  }

  // Tournament Error Display
  function showTournamentError(message) {
    console.error('🏆 Tournament Error:', message);
    
    // Create error notification
    const errorNotification = document.createElement('div');
    errorNotification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 10001;
      box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.3);
      animation: slideInRight 0.5s ease-out;
      max-width: 300px;
    `;
    
    errorNotification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 20px;">❌</span>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(errorNotification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (errorNotification.parentNode) {
        errorNotification.style.animation = 'slideOutRight 0.5s ease-in';
        setTimeout(() => {
          if (errorNotification.parentNode) {
            errorNotification.parentNode.removeChild(errorNotification);
          }
        }, 500);
      }
    }, 5000);
  }

  // Tournament Success Display
  function showTournamentSuccess(message) {
    console.log('🏆 Tournament Success:', message);
    
    // Create success notification
    const successNotification = document.createElement('div');
    successNotification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #059669, #047857);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 10001;
      box-shadow: 0 4px 20px rgba(5, 150, 105, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.3);
      animation: slideInRight 0.5s ease-out;
      max-width: 300px;
    `;
    
    successNotification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 20px;">✅</span>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(successNotification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
      if (successNotification.parentNode) {
        successNotification.style.animation = 'slideOutRight 0.5s ease-in';
        setTimeout(() => {
          if (successNotification.parentNode) {
            successNotification.parentNode.removeChild(successNotification);
          }
        }, 500);
      }
    }, 3000);
  }

  // Make tournament functions globally accessible
  window.handleTournamentCreation = handleTournamentCreation;
  window.handleTournamentJoin = handleTournamentJoin;
  window.handleTournamentLeave = handleTournamentLeave;
  window.handleReadyConfirm = handleReadyConfirm;
  window.handleBackToLobby = handleBackToLobby;
  window.showTournamentError = showTournamentError;
  window.showTournamentSuccess = showTournamentSuccess;

  // ===== PHASE 2 ENHANCED MOBILE UI (HYTOPIA SDK COMPLIANT) =====
  
  // Enhanced mobile UI state
  let enhancedMobileUIInitialized = false;
  let mobilePerformanceMonitor = null;
  let touchGestureHandler = null;
  
  // Initialize Phase 2 enhanced mobile UI
  function initializeEnhancedMobileUI() {
    if (enhancedMobileUIInitialized || !isMobileDevice) {
      return;
    }
    
    console.log('📱✨ Initializing Phase 2 Enhanced Mobile UI...');
    
    // Create enhanced mobile scoreboard
    createEnhancedMobileScoreboard();
    
    // Create mobile game status overlay
    createMobileGameStatus();
    
    // Initialize mobile performance monitoring
    initializeMobilePerformanceMonitoring();
    
    // Initialize touch gesture system
    initializeTouchGestureSystem();
    
    // Initialize mobile-optimized team selection
    initializeMobileTeamSelection();
    
    // Initialize mobile game menu
    initializeMobileGameMenu();
    
    enhancedMobileUIInitialized = true;
    console.log('✅ Phase 2 Enhanced Mobile UI initialized');
  }
  
  // Create enhanced mobile scoreboard
  function createEnhancedMobileScoreboard() {
    const scoreboard = document.createElement('div');
    scoreboard.className = 'enhanced-mobile-scoreboard';
    scoreboard.id = 'enhanced-mobile-scoreboard';
    
    scoreboard.innerHTML = `
      <div class="mobile-team-score">
        <div class="mobile-team-name mobile-team-red">Red</div>
        <div class="mobile-score-number mobile-team-red" id="mobile-red-score">0</div>
      </div>
      <div class="mobile-team-score">
        <div class="mobile-team-name mobile-team-blue">Blue</div>
        <div class="mobile-score-number mobile-team-blue" id="mobile-blue-score">0</div>
      </div>
      <div class="mobile-game-time" id="mobile-game-time">
        Waiting for game to start...
      </div>
    `;
    
    document.body.appendChild(scoreboard);
    console.log('📱 Enhanced mobile scoreboard created');
  }
  
  // Create mobile game status overlay
  function createMobileGameStatus() {
    const gameStatus = document.createElement('div');
    gameStatus.className = 'mobile-game-status';
    gameStatus.id = 'mobile-game-status';
    gameStatus.textContent = 'Ready to play!';
    
    document.body.appendChild(gameStatus);
    console.log('📱 Mobile game status overlay created');
  }
  
  // Initialize mobile performance monitoring
  function initializeMobilePerformanceMonitoring() {
    const performanceIndicator = document.getElementById('mobile-performance-indicator');
    if (!performanceIndicator) return;
    
    let frameCount = 0;
    let lastTime = performance.now();
    let fps = 60;
    
    mobilePerformanceMonitor = setInterval(() => {
      const currentTime = performance.now();
      const deltaTime = currentTime - lastTime;
      frameCount++;
      
      if (deltaTime >= 1000) { // Update every second
        fps = Math.round((frameCount * 1000) / deltaTime);
        frameCount = 0;
        lastTime = currentTime;
        
        // Update performance indicator with color coding
        let performanceClass = 'performance-good';
        let batteryStatus = '🔋';
        
        if (fps < 20) {
          performanceClass = 'performance-poor';
          batteryStatus = '🪫';
        } else if (fps < 40) {
          performanceClass = 'performance-warning';
          batteryStatus = '🔋';
        }
        
        performanceIndicator.className = `mobile-performance-indicator ${performanceClass}`;
        performanceIndicator.innerHTML = `${batteryStatus} ${fps} FPS | Mobile Mode`;
        
        // Send performance data to server for optimization
        if (fps < 30) {
                     hytopia.sendData({
             type: "mobile-performance-warning",
             fps: fps,
             deviceInfo: {
               userAgent: navigator.userAgent,
               memory: navigator['deviceMemory'] || 'unknown',
               cores: navigator.hardwareConcurrency || 'unknown'
             }
           });
        }
      }
    }, 100);
    
    console.log('📱 Mobile performance monitoring started');
  }
  
  // Initialize touch gesture system
  function initializeTouchGestureSystem() {
    let gestureStartPos = null;
    let gestureStartTime = null;
    let isGesturing = false;
    
    // Pinch to zoom variables
    let initialPinchDistance = 0;
    let currentZoom = 1;
    
    touchGestureHandler = {
      // Swipe gesture detection
      handleTouchStart: function(e) {
        if (e.touches.length === 1) {
          gestureStartPos = {
            x: e.touches[0].clientX,
            y: e.touches[0].clientY
          };
          gestureStartTime = Date.now();
          isGesturing = false;
        } else if (e.touches.length === 2) {
          // Pinch gesture start
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          initialPinchDistance = Math.sqrt(
            Math.pow(touch2.clientX - touch1.clientX, 2) +
            Math.pow(touch2.clientY - touch1.clientY, 2)
          );
        }
      },
      
      handleTouchMove: function(e) {
        if (e.touches.length === 2 && initialPinchDistance > 0) {
          // Handle pinch zoom gesture
          e.preventDefault();
          
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = Math.sqrt(
            Math.pow(touch2.clientX - touch1.clientX, 2) +
            Math.pow(touch2.clientY - touch1.clientY, 2)
          );
          
          const zoomRatio = currentDistance / initialPinchDistance;
          const newZoom = Math.max(0.5, Math.min(2.0, currentZoom * zoomRatio));
          
          // Send zoom data to server
          hytopia.sendData({
            type: "mobile-zoom-gesture",
            zoom: newZoom,
            center: {
              x: (touch1.clientX + touch2.clientX) / 2,
              y: (touch1.clientY + touch2.clientY) / 2
            }
          });
          
          updateMobileGameStatus(`🔍 Zoom: ${Math.round(newZoom * 100)}%`);
        }
      },
      
      handleTouchEnd: function(e) {
        if (gestureStartPos && !isGesturing && e.touches.length === 0) {
          const gestureEndPos = {
            x: e.changedTouches[0].clientX,
            y: e.changedTouches[0].clientY
          };
          const gestureTime = Date.now() - gestureStartTime;
          
          const deltaX = gestureEndPos.x - gestureStartPos.x;
          const deltaY = gestureEndPos.y - gestureStartPos.y;
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          
          // Detect swipe gestures (fast movement over distance)
          if (distance > 50 && gestureTime < 300) {
            const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
            let direction = '';
            
            if (angle >= -45 && angle <= 45) direction = 'right';
            else if (angle >= 45 && angle <= 135) direction = 'down';
            else if (angle >= -135 && angle <= -45) direction = 'up';
            else direction = 'left';
            
            // Send swipe gesture to server
            hytopia.sendData({
              type: "mobile-swipe-gesture",
              direction: direction,
              speed: distance / gestureTime,
              distance: distance
            });
            
            // Show visual feedback
            updateMobileGameStatus(`⚡ Swipe ${direction.toUpperCase()}`);
            setTimeout(() => updateMobileGameStatus('Ready to play!'), 1000);
            
            console.log(`📱 Swipe gesture detected: ${direction} (${Math.round(distance)}px in ${gestureTime}ms)`);
          }
        }
        
        // Reset gesture tracking
        gestureStartPos = null;
        gestureStartTime = null;
        isGesturing = false;
        currentZoom = 1;
        initialPinchDistance = 0;
      }
    };
    
    // Add gesture event listeners to the entire document
    document.addEventListener('touchstart', touchGestureHandler.handleTouchStart, { passive: false });
    document.addEventListener('touchmove', touchGestureHandler.handleTouchMove, { passive: false });
    document.addEventListener('touchend', touchGestureHandler.handleTouchEnd, { passive: false });
    
    console.log('📱 Touch gesture system initialized');
  }
  
  // Initialize mobile team selection
  function initializeMobileTeamSelection() {
    // This will be shown when team selection is needed
    const mobileTeamSelection = document.createElement('div');
    mobileTeamSelection.className = 'mobile-team-selection';
    mobileTeamSelection.id = 'mobile-team-selection';
    mobileTeamSelection.style.display = 'none';
    
    mobileTeamSelection.innerHTML = `
      <div class="mobile-menu-title">Choose Your Team</div>
      <button class="mobile-team-button mobile-team-red-btn" onclick="selectMobileTeam('red')">
        🔴 Red Team
      </button>
      <button class="mobile-team-button mobile-team-blue-btn" onclick="selectMobileTeam('blue')">
        🔵 Blue Team
      </button>
    `;
    
    document.body.appendChild(mobileTeamSelection);
    console.log('📱 Mobile team selection created');
  }
  
  // Initialize mobile game menu
  function initializeMobileGameMenu() {
    const mobileGameMenu = document.createElement('div');
    mobileGameMenu.className = 'mobile-game-menu';
    mobileGameMenu.id = 'mobile-game-menu';
    mobileGameMenu.style.display = 'none';
    
    mobileGameMenu.innerHTML = `
      <div class="mobile-menu-title">Game Menu</div>
      <button class="mobile-menu-button" onclick="resumeGameMobile()">
        ▶️ Resume Game
      </button>
      <button class="mobile-menu-button" onclick="showMobileSettings()">
        ⚙️ Settings
      </button>
      <button class="mobile-menu-button danger" onclick="quitGameMobile()">
        🚪 Quit Game
      </button>
    `;
    
    document.body.appendChild(mobileGameMenu);
    console.log('📱 Mobile game menu created');
  }
  
  // Mobile UI helper functions
  function updateMobileScoreboard(redScore, blueScore, gameTime) {
    const redScoreEl = document.getElementById('mobile-red-score');
    const blueScoreEl = document.getElementById('mobile-blue-score');
    const gameTimeEl = document.getElementById('mobile-game-time');
    
    if (redScoreEl) redScoreEl.textContent = redScore || '0';
    if (blueScoreEl) blueScoreEl.textContent = blueScore || '0';
    if (gameTimeEl) gameTimeEl.textContent = gameTime || 'Game Time';
  }
  
  function updateMobileGameStatus(message) {
    const gameStatus = document.getElementById('mobile-game-status');
    if (gameStatus) {
      gameStatus.textContent = message;
      gameStatus.style.display = 'block';
      
      // Auto-hide after 3 seconds if it's a temporary message
      if (message.includes('⚡') || message.includes('🔍')) {
        setTimeout(() => {
          if (gameStatus.textContent === message) {
            gameStatus.style.display = 'none';
          }
        }, 3000);
      }
    }
  }
  
  function showMobileTeamSelection() {
    const teamSelection = document.getElementById('mobile-team-selection');
    if (teamSelection) {
      teamSelection.style.display = 'block';
    }
  }
  
  function hideMobileTeamSelection() {
    const teamSelection = document.getElementById('mobile-team-selection');
    if (teamSelection) {
      teamSelection.style.display = 'none';
    }
  }
  
  function selectMobileTeam(team) {
    console.log(`📱 Mobile team selected: ${team}`);
    
    // Send team selection to server
    hytopia.sendData({
      type: "mobile-team-selection",
      team: team
    });
    
    // Hide team selection
    hideMobileTeamSelection();
    
    // Show confirmation
    updateMobileGameStatus(`✅ Joined ${team.toUpperCase()} team!`);
  }
  
  function showMobileGameMenu() {
    const gameMenu = document.getElementById('mobile-game-menu');
    if (gameMenu) {
      gameMenu.style.display = 'block';
    }
  }
  
  function hideMobileGameMenu() {
    const gameMenu = document.getElementById('mobile-game-menu');
    if (gameMenu) {
      gameMenu.style.display = 'none';
    }
  }
  
  function resumeGameMobile() {
    hideMobileGameMenu();
    updateMobileGameStatus('🎮 Game resumed');
  }
  
  function showMobileSettings() {
    hideMobileGameMenu();
    updateMobileGameStatus('⚙️ Settings - Coming soon!');
  }
  
  function quitGameMobile() {
    hytopia.sendData({
      type: "mobile-quit-game"
    });
    hideMobileGameMenu();
  }
  
  // Auto-initialize enhanced mobile UI when basic mobile controls are ready
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      if (isMobileDevice) {
        initializeEnhancedMobileUI();
      }
    }, 1500);
  });
  
  // Make Phase 2 mobile functions globally accessible
  window.initializeEnhancedMobileUI = initializeEnhancedMobileUI;
  window.updateMobileScoreboard = updateMobileScoreboard;
  window.updateMobileGameStatus = updateMobileGameStatus;
  window.showMobileTeamSelection = showMobileTeamSelection;
  window.selectMobileTeam = selectMobileTeam;
  window.showMobileGameMenu = showMobileGameMenu;

</script>

</body>
</html>

<!-- favicon added -->
